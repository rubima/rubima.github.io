<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>qwikWeb の仕組み 【第 2 回】 qwikWeb のプラグインを作ってみよう</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0013/0013-qwikWeb.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>qwikWeb の仕組み 【第 2 回】 qwikWeb のプラグインを作ってみよう</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=qwikWeb の仕組み 【第 2 回】 qwikWeb のプラグインを作ってみよう&amp;url=https://magazine.rubyist.net/articles/0013/0013-qwikWeb.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0013/0013-qwikWeb.html&amp;t=qwikWeb の仕組み 【第 2 回】 qwikWeb のプラグインを作ってみよう" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0013/0013-qwikWeb.html&amp;qwikWeb の仕組み 【第 2 回】 qwikWeb のプラグインを作ってみよう" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        
<p>書いた人：えと こういちろう</p>

<ul id="markdown-toc">
  <li><a href="#qwikweb-のプラグインを作ってみよう" id="markdown-toc-qwikweb-のプラグインを作ってみよう">qwikWeb のプラグインを作ってみよう</a>    <ul>
      <li><a href="#目標" id="markdown-toc-目標">目標</a></li>
    </ul>
  </li>
  <li><a href="#セットアップ方法" id="markdown-toc-セットアップ方法">セットアップ方法</a></li>
  <li><a href="#qwikweb-プラグインの作り方" id="markdown-toc-qwikweb-プラグインの作り方">qwikWeb プラグインの作り方</a>    <ul>
      <li><a href="#html-を出力するプラグイン" id="markdown-toc-html-を出力するプラグイン">HTML を出力するプラグイン</a></li>
      <li><a href="#滝川クリステルプラグイン" id="markdown-toc-滝川クリステルプラグイン">滝川クリステルプラグイン</a></li>
    </ul>
  </li>
  <li><a href="#動的にコンテンツを生成するプラグイン" id="markdown-toc-動的にコンテンツを生成するプラグイン">動的にコンテンツを生成するプラグイン</a>    <ul>
      <li><a href="#高橋メソッドプラグイン" id="markdown-toc-高橋メソッドプラグイン">高橋メソッドプラグイン</a></li>
      <li><a href="#コード表示プラグイン" id="markdown-toc-コード表示プラグイン">コード表示プラグイン</a></li>
    </ul>
  </li>
  <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
  <li><a href="#著者について" id="markdown-toc-著者について">著者について</a></li>
  <li><a href="#qwikweb-の仕組み-連載一覧" id="markdown-toc-qwikweb-の仕組み-連載一覧">qwikWeb の仕組み 連載一覧</a></li>
</ul>

<h2 id="qwikweb-のプラグインを作ってみよう">qwikWeb のプラグインを作ってみよう</h2>

<p>本稿では、__qwikWeb のプラグインの作り方__について解説する。実際にいくつかのプラグインを書きながら、どのようにすれば qwikWeb を拡張できるのかを実践してみる。</p>

<h3 id="目標">目標</h3>

<p>qwikWeb は元々、グループのメンバーだけが使う_非公開 Wiki サイト_の実現を目標としており、プライベートな利用において必要な機能の実現を優先している。しかし、qwikWeb も徐々に公開 Wiki サイトのために利用されることが増えてきた。元々プライベートな利用を優先してきたという経緯から、公開 Wiki サイトとして必要な機能はまだまだ十分に実装されているとは言えない状況である。そのような機能を開発していくには、私一人では到底力が足りない。そこで、__「 qwikWeb 開発に参加してくれる人を増やそう！」__というのがこの連載の狙いである。</p>

<p>qwikWeb は、それぞれの部品ごとに機能を追加していけるように構成している。
その中でも、プラグインはもっとも基本的な拡張方法であり、このプラグインの作り方から解説を始める。</p>

<h2 id="セットアップ方法">セットアップ方法</h2>

<p>qwikWeb 開発版のインストール方法は前回解説したが、前回からはリポジトリを CVS から Subversion へと変更しているため、ソースコードのチェックアウト方法が変わっている。最初からもう一度解説することとする。</p>

<p>「 ~/qwik 」以下に qwikWeb をインストールすると仮定する。
まず、リポジトリより最新版を取得する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% cd
% svn checkout svn://rubyforge.org//var/svn/qwik/qwik</code></pre></figure>

<p>このようにして最新版を取得する。次に、qwikWeb を起動する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% cd qwik
% ruby bin/qwikweb-server -d -c etc/config.txt
[2006-01-26 08:53:26] INFO  WEBrick 1.3.1
[2006-01-26 08:53:26] INFO  ruby 1.8.4 (2005-10-29) [i486-linux]
[2006-01-26 08:53:36] INFO  Qwik::Server#start: pid=2345 port=9190</code></pre></figure>

<p>このようにして、取得したディレクトリからデバッグモードで起動する。
make コマンドが使える場合は、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% cd qwik
% make</code></pre></figure>

<p>として、単に make をうつだけでよい。</p>

<p>qwikWeb が起動すると、WEBrick の起動メッセージが表示される。</p>

<ul>
  <li><a href="http://127.0.0.1:9190/">http://127.0.0.1:9190/</a></li>
</ul>

<p>にアクセスしてみると、qwikWeb の入口となるページが表示される。
qwikWeb サーバは通常はポート 9190 で立ち上がるが、
ポート指定を含まない URL からアクセスできるようにしたい場合は、</p>

<ul>
  <li><a href="http://qwik.jp/UseWithApache.html">http://qwik.jp/UseWithApache.html</a></li>
</ul>

<p>を参照して、リバースプロキシを設定することになる。</p>

<p>また、システムにインストールしたい場合のために、setup.rb を使ってインストールできるように準備中である。現在はまだすぐにうまくいく状態になってないが、概略を説明しておく。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% sudo ruby setup.rb</code></pre></figure>

<p>とすると、ファイルはそれぞれ目標となるディレクトリにインストールされる。
標準では下記のようなディレクトリ構成となる。</p>

<ul>
  <li>/usr/bin/qwikweb-server</li>
  <li>/usr/bin/quickml-server</li>
  <li>/usr/bin/qwik-service</li>
  <li>/usr/local/lib/site_ruby/1.8/qwik/*</li>
  <li>/usr/local/lib/site_ruby/1.8/i486-linux/xmlformatter.so</li>
  <li>/usr/share/qwik/*</li>
  <li>/etc/qwik/config.txt</li>
</ul>

<p>このようにしてインストールした後に、設定ファイル「 /etc/qwik/config.txt 」を編集して、適切なパスを設定する必要がある。
標準的なディレクトリであれば、設定ファイル後半のコメントを外すだけでよいはずである。</p>

<p>また、えとー氏によって Debian 用のパッケージが作成されている。</p>

<ul>
  <li><a href="http://www.eto.to/deb/">http://www.eto.to/deb/</a></li>
</ul>

<p>この下に .deb ファイルがあるので、sources.list などを適切に設定すれば、
apt-get でインストールできるようになる。
いつも Debian パッケージを作成してくれているえとー氏に感謝いたします。</p>

<h2 id="qwikweb-プラグインの作り方">qwikWeb プラグインの作り方</h2>

<p>前回は、qwikWeb の基本的な要素として、<strong>わびさび方式__と__クラス構造</strong>、__テスト方法__について述べた。
本稿では、その基本的な要素をふまえた上で、実際にプラグインを実装し、拡張する方法について詳述する。</p>

<h3 id="html-を出力するプラグイン">HTML を出力するプラグイン</h3>

<p>まず最も簡単なプラグインとして、ごく単純に __HTML を出力するプラグイン__を作ってみよう。</p>

<p>まず新しいプラグインファイルを作成する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% cd ~/qwik/lib/qwik
% vi act-test.rb</code></pre></figure>

<p>ライブラリのあるディレクトリに移動し、
「 act-test.rb 」というファイルを新規作成する。
(もちろんエディタは vi じゃなくてもかまわない。)</p>

<p>qwikWeb では、このディレクトリ中にある__「 act- 」__からはじまるファイルを自動的に読み込むようになっている。そのため、「 act-test.rb 」というファイル名のファイルを作成すれば、それだけで自動的に読み込まれる。
そのため、「 act-test.rb 」というファイル名でなくても「 act- 」から始まっていれば、別のファイル名でもかまわない。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">module Qwik
  class Action
    def plg_strong(text)
      return [:strong, text]
    end
  end
end</code></pre></figure>

<p>このように記述し、qwikWeb サーバを再起動する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% cd ../..
% ruby bin/qwikweb-server -d -c etc/config.txt &amp;</code></pre></figure>

<p>FrontPage にアクセスする。</p>

<ul>
  <li><a href="http://127.0.0.1:9190/">http://127.0.0.1:9190/</a></li>
</ul>

<p>先程作成したプラグインを実際に使ってみよう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">{{strong('hello, world!')}}</code></pre></figure>

<p>編集画面に移動し、このような一文を挿入すると、画面には__「 hello, world! 」__という
文字列が strong で表示されたことと思う。</p>

<p>次に、このプラグインをすこしだけ修正してみよう。
「 act-test.rb 」の中身をこのように変更し、保存する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   def plg_strong(text)
     return [:i, text]
   end</code></pre></figure>

<p>つまり、<strong>「 :strong 」__だったところを</strong>「 :i 」__に変更するわけである。</p>

<p>次に、先程表示したページを再読み込みする。</p>

<ul>
  <li><a href="http://127.0.0.1:9190/">http://127.0.0.1:9190/</a></li>
</ul>

<p>Internet Explorer では、Ctrl を押しながら F5 を押すと、強制リロードとなる。
文字列がイタリックで表示されるようになっただろうか。</p>

<p>ここで、qwikWeb サーバを__再起動していない__ことに注目してほしい。デバッグモードで立ち上げた場合、qwikWebサーバは、ファイルの書き換えを自動的に検知し、書き換えられたファイルを再読み込みする。そのため、qwikWeb サーバをデバッグ中にファイルを書き換えた場合は、再起動しなくても自動的にプログラムは更新される。ファイル作成直後に一度再起動したのは、ファイルを require するのはサーバ起動直後のみであり、再起動しなければ新しく作成し
たファイルは読み込まれないからである。一旦 require で読み込まれれば、その後は自動再読み込みされるようになる。ここで述べるプラグインの開発のようにプログラムの一部分を頻繁に更新しながら開発を進める場合、ファイルを更新するたびにそのプログラムの本体を再起動させなければならないとすると、開発効率が大変落ちる。
qwikWeb ではファイルを更新したらリロードするだけでよいので、プログラムの変化を逐次確認できるようになる。</p>

<p>この処理は、qwikWeb から分離し、単体で使うこともできる。
この autoreload 処理は「autoreload.rb」というファイルで行っている。
下記のようにして使う。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">require 'autoreload'
AutoReload.start(1, true)</code></pre></figure>

<p>require したファイルは全て自動的に監視対象となるため、どのファイルを変更しても自動的に再読み込みしてくれる。一つ目の引数では、ファイル更新確認の間隔を指定する。この例では、一秒置きに require された全ファイルの更新をチェックする。二つ目の引数は、verbose mode の設定である。verbose mode では、ファイルが再読み込みされたときは、下記のようなメッセージが表示される。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">reload: "/home/eto/qwik/lib/qwik/act-test.rb"</code></pre></figure>

<p>このようにして、任意のプログラムにおいて、動的にファイルの自動更新をさせることができる。</p>

<p>さて、プラグインの作り方に話を戻す。先程「 :i 」に変更したところをもう一度「 :strong 」に戻しておこう。次に、テストコードを追加してみる。プログラムができてからテストコードを書いたのではテストファーストではないが、qwikWeb のプラグインの開発ではブラウザでどのように表示されるかを確認しながら開発を進めることが多いため、テストケースは後で作ることが多い。先程のプログラムに、下記コードを追加する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">if $0 == __FILE__
  $LOAD_PATH &lt;&lt; '..' unless $LOAD_PATH.include? '..'
  require 'qwik/test-common'
  $test = true
end

if defined?($test) &amp;&amp; $test
  class TestActTest &lt; Test::Unit::TestCase
    include TestSession

    def test_all
      ok_wi([:strong, "t"], '{{strong(t)}}')
    end
  end
end</code></pre></figure>

<p>この中で実質的に意味を持つのは一行だけである。
それ以外は、テストケース記述に要する定型句と考えてほしい。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     ok_wi([:strong, "t"], '{{strong(t)}}')</code></pre></figure>

<p>この一行は、Wiki ページ中に</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">{{strong(t)}}</code></pre></figure>

<p>と記述すると、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[:strong, "t"]</code></pre></figure>

<p>に変換されるということを示している。
このテストケースの左側はわびさび方式で書かれた HTML である。
HTMLで表現するとすれば、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;strong&gt;t&lt;/strong&gt;</code></pre></figure>

<p>となる。このように、テストの結果記述においても、わびさび方式を使っている。</p>

<p>テストを実行してみる。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% ruby act-test.rb 
Loaded suite act-test
Started
.
Finished in 0.065539 seconds.

1 tests, 1 assertions, 0 failures, 0 errors</code></pre></figure>

<p>assertion の実行が無事確認された。</p>

<p>このように、ブラウザから表示させなくても__コマンドラインから実行を確認できる__のが、このテスト方法の大きな利点である。よくあるパターンだと、コードを書き換えたら、いちいちブラウザからページをリロードしてちゃんと表示されるかを確認しなくてはならない。毎回
ブラウザを操作しなければならないため非常に面倒である。また、エラー表示は「 error.log 」を確認しなければならないなど、エラー表示の確認が面倒だったりすることもある。qwikWeb のテスト方式は単なる普通のコマンドラインからのプログラム実行と同じなので、容易にデバッグを行える。</p>

<p>ここでのポイントは、プログラムが想定通りに実行されるかどうかと、ブラウザ上に想定通りに表示されるかどうかを、別の問題として切り分けているということである。プログラムがエラーがなく実行されるかどうか、想定した通りの値が計算されるかどうかは、ユニットテストで確認できる。しかし、ブラウザ上に正しく表示されるかどうかは、実際にブラウザに表示させてみ
ないとわからない。このようにテストを二分割することによって、まずエラーなく実行できることを確認し、その後にブラウザ上で表示させながら結果表示を改善していく形で開発を進めていくことができる。</p>

<p>このようにして、プラグインのコードを書き、ブラウザで表示させ、そのテストケースを書き、テストを実行してみるというプラグイン開発における一連のプロセスをたどってみることができた。</p>

<p>ここで述べた方法を使って、もう少し実践的なプラグインを作ってみる。このような単純に HTML を出力するだけのプラグインではあまり面白い効果を発揮させられないと思われるかもしれないが、工夫次第では様々な処理をさせることができる。</p>

<h3 id="滝川クリステルプラグイン">滝川クリステルプラグイン</h3>

<p>最近話題の「<a href="http://gedo-style.com/crstl/">滝川クリステルジェネレータ</a>」を題材にして、滝川クリステル女史を Wiki ページ中に表示するプラグインを作ってみる。
名付けて__「滝川クリステルプラグイン」__である。
「滝川クリステルジェネレータ」の作者に感謝いたします。</p>

<p>作る過程は省略し、結果としてできたコードを引用しつつ解説する。</p>

<ul>
  <li>qwik/lib/qwik/act-christel.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">module Qwik
  class Action
    def plg_christel(width = 320)
      width = width.to_i.to_s
      content = yield
      message, image_url = content.to_a
      message.chomp!
      image_url.chomp! if image_url
      query_str = {
        :m =&gt; message.set_page_charset.to_utf8,
        :u =&gt; image_url
      }.to_query_string
      url = "http://gedo-style.com/crstl/crstl.php?#{query_str}"
      return [:img, {:src=&gt;url, :width=&gt;width}]
    end
  end
end</code></pre></figure>

<p>最初から順番に解説していく。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">module Qwik
  class Action
    def plg_christel(width = 320)
      width = width.to_i.to_s</code></pre></figure>

<p>まずプラグインは、Action というクラスの__「 plg_ 」__から始まるメソッドとして定義される。プラグインの引数は、同じくメソッドへの引数として渡される。引数を省略可能にすることもできる。ここでは引数には横幅の数値だけをとることとしている。</p>

<p>プラグインは、引数以外にも情報を受け取ることができる。プラグインの中に複数行の中身を記述することができる。これを__複数行プラグイン__と呼んでいる。
そのような複数行プラグインの場合は、プラグインに囲まれた内容は yield で取得する。</p>

<p>例えば、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">{{christel
This is a test.
This is a test, too.
}}</code></pre></figure>

<p>このように記述した場合、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     content = yield</code></pre></figure>

<p>とすると、contentにはプラグインに囲まれた二行の文字列がはいる。</p>

<p>このプラグインの場合には、その中身は二行しか使わないので、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     message, image_url = content.to_a</code></pre></figure>

<p>として、一行目のメッセージ、二行目の画像 URL を受け取る。</p>

<p>次に、行末の改行を処理してから、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     message.chomp!
     image_url.chomp! if image_url</code></pre></figure>

<p>その取得した情報を元にクエリ文字列を生成している。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     query_str = {
       :m =&gt; message.set_page_charset.to_utf8,
       :u =&gt; image_url
     }.to_query_string</code></pre></figure>

<p>ここではまず、与えられたメッセージを文字コード変換している。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">message.set_page_charset.to_utf8</code></pre></figure>

<p>これは一風変った方法で、まず最初に現時点での文字コードは何かという情報を一旦文字列自身に持たせ、次に目標となる文字コードに変換している。これは、将来的にはページに使う文字コードを変更しようと思っているため、後で文字コードが切り替わってもプログラムを修正しなくても済むように、まわりくどい書き方をしている。</p>

<p>次に、Hash#to_query_string を呼び出して query_string に変換している。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     url = "http://gedo-style.com/crstl/crstl.php?#{query_str}"
     return [:img, {:src=&gt;url, :width=&gt;width}]</code></pre></figure>

<p>最後に、url を組み立てて、img 要素として出力している。要するに、最終的には単に一つの img タグを出力しているだけである。たったこれだけであるが、プラグインから情報を入力し、必要な画像を出力するところまでを実現することができた。</p>

<p>テストケースをどのように書いているのか見てみよう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     ok_wi([:img, {:width=&gt;'320',
	:src=&gt;"http://gedo-style.com/crstl/crstl.php?m=a"}],
    "{{christel\na\n}}")</code></pre></figure>

<p>このテストケースはどういう意味かというと、Wiki ページ中に</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">{{christel
a
}}</code></pre></figure>

<p>というプラグインを記述すると、このような HTML に変換されるということである。</p>

<p>開発の手順としては、最初からこのようなテストケースが用意しているわけではなく、まずは適当にプラグインを書いてみて、ちゃんと期待通りに表示されるように開発し、その後にテストケースに書いている。その意味ではテストファーストではないが、一旦テストケースを作れば、後でそれを変更・拡張することが容易になる。</p>

<p>実際の出力例は、下記ページから見ることができる。</p>

<ul>
  <li><a href="http://qwik.jp/christel.describe">http://qwik.jp/christel.describe</a></li>
</ul>

<h2 id="動的にコンテンツを生成するプラグイン">動的にコンテンツを生成するプラグイン</h2>

<p>実際には、プラグインにはもう少し複雑な動作をさせたいと思うことがあるだろう。例えば、Wiki ページ中に__動的に生成したコンテンツ__を埋込みたいと思うことがあるだろう。
ここではそのような構造を持つプラグインとして、__「高橋メソッドプラグイン」__を作ってみる。
これは、Wiki ページ中に高橋メソッドによるプレゼンテーションを埋込むというプラグインである。</p>

<h3 id="高橋メソッドプラグイン">高橋メソッドプラグイン</h3>

<p>このプラグインは、<a href="http://lab.ajibit.com">WEBLAB@AJIBIT</a> にて公開されている「高橋メソッドマシーン」という Flash を使用している。
「高橋メソッドマシーン」の作者に感謝します。</p>

<p>実際のプラグインのコードを引用しつつ解説する。</p>

<ul>
  <li>qwik/lib/qwik/act-takahashi.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">    def plg_takahashi
      files = @site.files(@req.base)
 
      # Copy T_method_module.swf from theme directory.
      fname = 'T_method_module.swf'
      if ! files.exist?(fname)
         swf_path = @config.theme_dir.path+'swf'+fname
         return nil if ! swf_path.exist?
         swf = swf_path.read
         files.overwrite(fname, swf)
      end
 
      # Generate a text file.
      content = yield
      content.chomp!
      text = content.set_page_charset.to_utf8
      files.overwrite('textData.txt', text)
 
      # Generate a html file.
      (中略)
      html_str = html.format_xml
      files.overwrite('takahashi.html', html_str)

      # Embed the html file as iframe.
      h = "#{@req.base}.files/takahashi.html"
      return [:div, {:class=&gt;'takahashi'},
         [:iframe, {:src=&gt;h, :style=&gt;'width:700px;height:400px;border:0;'}, ''],
         [:br],
         [:div, {:style=&gt;'margin: 0 0 1em 0;'},
           [:a, {:href=&gt;h, :style=&gt;'font-size:x-small;'},
             _('Show in fullscreen.')]]]
    end</code></pre></figure>

<p>最初から順に解説する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   def plg_takahashi</code></pre></figure>

<p>ここで、高橋メソッドプラグインを定義している。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     files = @site.files(@req.base)</code></pre></figure>

<p>ここでは、__「 @req.base 」__というページの添付ファイルにアクセスしようとしている。「 @req.base 」というのは、現在のアクセスしているページのページキーとなる。「 FrontPage.html 」にアクセスしている場合は「 FrontPage 」となる。省略された場合には「 FrontPage 」となる。
__「 @site.files(@req.base) 」__という処理で、「 @req.base 」というページキーに対応する添付ファイルインスタンスを取得するという意味になる。これは「 page-files.rb 」にて定義されており、詳細な使い方はそのファイルで確認することができる。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     # Copy T_method_module.swf from theme directory.
     fname = 'T_method_module.swf'
     if ! files.exist?(fname)
       swf_path = @config.theme_dir.path+'swf'+fname
       return nil if ! swf_path.exist?
       swf = swf_path.read
       files.overwrite(fname, swf)
     end</code></pre></figure>

<p>ここではまず、高橋メソッドを実現するためのFlashファイル「 T_method_module.swf 」を添付ファイル内にコピーしている。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     # Generate a text file.
     content = yield
     content.chomp!
     text = content.set_page_charset.to_utf8
     files.overwrite('textData.txt', text)</code></pre></figure>

<p>次に、その Flash ファイルにパラメータとして与えるテキストファイルを生成している。
このようにして、その場で動的に添付ファイルを作り出している。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     # Generate a html file.</code></pre></figure>

<p>次に、ページ中に IFRAME で埋込むための html ファイルを生成している。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     # Embed the html file as iframe.</code></pre></figure>

<p>最後に、その動的に生成した html ファイルを埋込むための IFRAME 要素を生成している。</p>

<p>このようにして、このプラグインにおいて、表示するのに必要な Flash ファイルそれ自身をコピーし、パラメータとして与えるテキストファイルを生成し、埋込み用の html ファイルを生成し、それを IFRAME としてページ中に埋め込んでいる。</p>

<p>このようにしてパラメータファイルが必要な Flash コンテンツを動的に埋込むことができた。テキストを基本とした Wiki ページに動的なコンテンツを埋め込んでいくことによって、Wiki ページを複合的なコンテンツを表示させるための基盤として扱うことができるようになる。</p>

<p>実際の出力例は、下記ページから見ることができる。</p>

<ul>
  <li><a href="http://qwik.jp/takahashi.describe">http://qwik.jp/takahashi.describe</a></li>
</ul>

<h3 id="コード表示プラグイン">コード表示プラグイン</h3>

<p>HTML を生成し、かつ同時に動的にコンテンツを生成するプラグイン例として、コード表示プラグインを紹介する。</p>

<p>実行結果はこのようになる。</p>

<ul>
  <li><a href="http://qwik.jp/code.describe">http://qwik.jp/code.describe</a></li>
</ul>

<p>ここでは、単にコードを行番号付きで表示しているだけに見えるかもしれないが、実は表示を工夫している。普通の行番号付きの表示では、行の先頭に行番号をつけて出力しているため、その表示をコピー&amp;ペーストすると、行番号も一緒にコピーされてしまう。
しかしここでの出力例は、普通にコードの内容をコピー&amp;ペーストできる。それはなぜかというと、行番号はテキストではなく、画像として背景に表示しているからだ。行番号は、動的に PNG ファイルを生成し、それをスタイルシートで背景に表示している。このようにして、行番号の表示と、簡単にコピー &amp; ペーストできるという特徴を同時に実現している。</p>

<ul>
  <li>qwik/lib/qwik/act-code.rb</li>
</ul>

<p>実際のコードはこのファイルである。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   def plg_code(filename=nil)
     content = ''
     content = yield if block_given?
     pre = [:pre]
     content.each_with_index {|line, index|
        line.chomp!
        linenum = index + 1
        klass = 'line '
        klass += if linenum % 2 == 0 then 'even' else 'odd' end
        style = "background-image: url(.num/#{linenum}.png);"
        pre &lt;&lt; [:span, {:class=&gt;klass, :style=&gt;style}, line]
        pre &lt;&lt; "\n"
     }
     return [:div, {:class=&gt;'code'}, pre]
   end</code></pre></figure>

<p>このようなコードによって、yield で入力された文字列を、一行づつ別々の span タグにいれ、それぞれの背景に画像を埋め込み、pre タグに入れていく。</p>

<p>スタイルシートは、現在は一箇所にまとめて管理している。</p>

<ul>
  <li>qwik/share/theme/css/base.css</li>
</ul>

<p>この中で、code クラスのスタイルを定義している。</p>

<p>背景画像として指定されるのは、どのような URL か。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">url(.num/#{linenum}.png);</code></pre></figure>

<p>このような URL である。つまり一行目であれば__「 .num/1.png 」<strong>という画像が埋込まれることになる。この URL は一見静的なファイルを参照しているように見えるが、実はそうではなく、実際には動的に数字の画像を生成している。この</strong>「 .num 」__というのはアクションプラグインという。実際のコードを見てみよう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   def act_num
     return c_nerror(_('Error')) if ! $have_gd
     args = @req.path_args
     return c_nerror(_('Error')) if args.nil? || args.empty?
     filename = args.first
     return c_nerror(_('Error')) unless /\A([0-9]+)\.png\z/ =~ filename
     str = $1
     return c_nerror(_('Error')) if 10 &lt; str.length
     files = @site.files('FrontPage')
     if ! files.exist?(filename)
        png = Action.generate_png(str)
        files.put(filename, png)
     end
     path = files.path(filename)
     return c_simple_send(path.to_s, 'image/png')
   end</code></pre></figure>

<p>以下、順に見てみる。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     return c_nerror(_('Error')) if ! $have_gd</code></pre></figure>

<p>GD という外部ライブラリを使って、動的に画像を生成しているため、
ライブラリが無かったらエラーになる。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     args = @req.path_args
     return c_nerror(_('Error')) if args.nil? || args.empty?</code></pre></figure>

<p>__「 @req.path_args 」__という記述で、アクションプラグインに続いて与
えられたパスを配列として取得できる。パスが指定されてなければエラーにする。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     filename = args.first
     return c_nerror(_('Error')) unless /\A([0-9]+)\.png\z/ =~ filename</code></pre></figure>

<p>一つ目の値を取り出し、ファイル名として適切かどうかを判定する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     str = $1
     return c_nerror(_('Error')) if 10 &lt; str.length</code></pre></figure>

<p>10 文字以内であることを確認する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     files = @site.files('FrontPage')</code></pre></figure>

<p>FrontPage の添付ファイルを扱うインスタンスを取得する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     if ! files.exist?(filename)</code></pre></figure>

<p>もしファイル名に相当するファイルが存在していなかったら、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">png = Action.generate_png(str)
files.put(filename, png)</code></pre></figure>

<p>対応する画像を生成し、その画像を添付ファイルとして保存する。
「 generate_png 」の中身は、与えられた文字列を元に PNG 画像を生成し、その中身を返している。つまりここでは、一旦生成した画像を、添付ファイルに保存する形でキャッシュしているわけだ。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     path = files.path(filename)</code></pre></figure>

<p>このようにして添付ファイルのパスを取得する。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">     return c_simple_send(path, 'image/png')</code></pre></figure>

<p>そのパスを「 c_simple_send 」に渡して、Content-Type には image/png を指定しつつ、ファイルそのものをリクエストの結果として返す。</p>

<p>このようにして、リクエストに応じて動的に生成するコンテンツを作り出すこともできる。ページに埋込むプラグインと、URL から直接呼び出すアクションプラグインとを組み合わせることで、柔軟な処理を可能としている。</p>

<h2 id="まとめ">まとめ</h2>

<p>本稿では、動的にコンテンツを生成するプラグインとして、「滝川クリステルプラグイン」「高橋メソッドプラグイン」「コード表示プラグイン」について、実際の実装方法を見ながら解説した。</p>

<p>みなさまもぜひ、qwikWeb のプラグイン制作にトライしてみてください。
面白いプラグインができたら、ぜひメーリングリストで教えてください。
メーリングリストの加入方法は、次のページに記述しています。</p>

<ul>
  <li><a href="http://qwik.jp/qwikWeb.html">http://qwik.jp/qwikWeb.html</a></li>
</ul>

<h2 id="著者について">著者について</h2>

<p>えと こういちろう (Rails 使ったら負けかなと思ってる)。
<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup></p>

<p>ついに私もブログ始めました。</p>

<ul>
  <li><a href="https://www.codeblog.org/blog/eto/">https://www.codeblog.org/blog/eto/</a></li>
</ul>

<p>ブログといいつつ tDiary なんだけどな。</p>

<h2 id="qwikweb-の仕組み-連載一覧">qwikWeb の仕組み 連載一覧</h2>

<ul>
  <li>
    <p><a href="../../articles/0014/0014-qwikWeb.html">qwikWeb の仕組み 【第 3 回】 ページの一部分だけ編集できるようにしてみる</a></p>
  </li>
  <li>
    <p><a href="../../articles/0013/0013-qwikWeb.html">qwikWeb の仕組み 【第 2 回】 qwikWeb のプラグインを作ってみよう</a></p>
  </li>
  <li>
    <p><a href="../../articles/0012/0012-qwikWeb.html">qwikWeb の仕組み 【第 1 回】 コンテンツ・フレームワークとしての qwikWeb</a></p>
  </li>
</ul>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>もちろん冗談ですけどね。;-) <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
