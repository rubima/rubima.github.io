<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>プログラマーのための YAML 入門 (探索編)</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0013/0013-YAML.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0059/0059-index.html">0059号(2019-01)</a></li>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>プログラマーのための YAML 入門 (探索編)</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=プログラマーのための YAML 入門 (探索編)&amp;url=https://magazine.rubyist.net/articles/0013/0013-YAML.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0013/0013-YAML.html&amp;t=プログラマーのための YAML 入門 (探索編)" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0013/0013-YAML.html&amp;プログラマーのための YAML 入門 (探索編)" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            



                        </div>
                        
<p>書いた人: kwatch</p>

<h2 id="はじめに">はじめに</h2>

<p><a href="http://www.yaml.org">YAML</a> (YAML Ain’t Markup Language) とは、構造化されたデータを表現するためのフォーマットです。本来はデータシリアライゼーション用のフォーマットですが、人にとって読みやすく書きやすいフォーマットなので、設定ファイルやデータ定義ファイルなどに使用されます。「構造化されたデータを表現する」という点では XML と同じですが、XML と比べて読みやすい、書きやすい、わかりやすいという特徴があります。</p>

<p>今回は YPath について説明します。YPath とは、YAML ドキュメントの中からある特定のデータを指定したり検索するための規格です (XML には <a href="http://www.w3.org/TR/xpath">XPath</a> という規格がありますが、それの YAML 版だと考えていただいて結構です)。YPath を使うと、例えば次のようなことができます。</p>

<ul>
  <li>アドレス帳のなかから名前が XXX である人のデータを取り出す。</li>
  <li>クラス名簿のなかから性別が女の子である子供の名前と電話番号だけを取り出す。</li>
</ul>

<p>なお YPath の仕様は議論中で、まだ固まっていません。また Syck (YAML 用ライブラリ) での実装も中途半端で、<a href="http://www.w3.org/TR/xpath">XPath</a> と比べると見劣りします。このような事情を踏まえて、本稿では YPath の基本的な機能だけを説明します。</p>

<p>なおプログラムの動作は Ruby 1.8.4 で確認しています。1.8.2 以前と 1.8.3 以降では Syck の仕様がかなり変わっているので、1.8.2 以前を使っている方は 1.8.4 をインストールしてください。</p>

<h3 id="目次">目次</h3>

<ul id="markdown-toc">
  <li><a href="#はじめに" id="markdown-toc-はじめに">はじめに</a>    <ul>
      <li><a href="#目次" id="markdown-toc-目次">目次</a></li>
    </ul>
  </li>
  <li><a href="#事前準備" id="markdown-toc-事前準備">事前準備</a></li>
  <li><a href="#ypath-の基本" id="markdown-toc-ypath-の基本">YPath の基本</a>    <ul>
      <li><a href="#パス" id="markdown-toc-パス">パス</a></li>
      <li><a href="#ルート" id="markdown-toc-ルート">ルート</a></li>
      <li><a href="#任意の要素" id="markdown-toc-任意の要素">任意の要素</a></li>
      <li><a href="#再帰的な検索" id="markdown-toc-再帰的な検索">再帰的な検索</a></li>
      <li><a href="#選択" id="markdown-toc-選択">選択</a></li>
      <li><a href="#条件" id="markdown-toc-条件">条件</a></li>
    </ul>
  </li>
  <li><a href="#応用例yaml-ドキュメント検索ツール" id="markdown-toc-応用例yaml-ドキュメント検索ツール">応用例：YAML ドキュメント検索ツール</a>    <ul>
      <li><a href="#コマンドyamlgrep" id="markdown-toc-コマンドyamlgrep">コマンド「yamlgrep」</a></li>
      <li><a href="#使い方" id="markdown-toc-使い方">使い方</a></li>
      <li><a href="#実行例" id="markdown-toc-実行例">実行例</a></li>
    </ul>
  </li>
  <li><a href="#おわりに" id="markdown-toc-おわりに">おわりに</a></li>
  <li><a href="#著者について" id="markdown-toc-著者について">著者について</a></li>
  <li><a href="#プログラマーのための-yaml-入門-連載一覧" id="markdown-toc-プログラマーのための-yaml-入門-連載一覧">プログラマーのための YAML 入門 連載一覧</a></li>
</ul>

<h2 id="事前準備">事前準備</h2>

<p>YPath を説明する前に、次のスクリプト「show-ypath.rb」を用意してください。これは YAML ドキュメントの中から、YPath で指定されたデータを抜き出して表示するスクリプトです。使い方は、第 1 引数で YPath を、第 2 引数で YAML ドキュメントのファイル名を指定します。</p>

<p><a href="../../images/0013-YAML/show-ypath.rb">show-ypath.rb</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1">## Usage: ruby show-ypath.rb ypath datafile.yaml</span>

<span class="nb">require</span> <span class="s1">'yaml'</span>
<span class="nb">require</span> <span class="s1">'pp'</span>

<span class="c1">## YPath パターンを取得する</span>
<span class="n">ypath</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
<span class="k">unless</span> <span class="n">ypath</span>
   <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"Usage: show-ypath ypath [file.yaml ...]"</span>
   <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">## YAML ファイルを読み込み、ツリーに変換する</span>
<span class="n">str</span> <span class="o">=</span> <span class="no">ARGF</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="no">YAML</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="o">*</span><span class="p">\}\}</span>

<span class="c1">## ツリーを探索し、ypath にマッチしたノードのパスをすべて表示する</span>
<span class="nb">puts</span> <span class="s2">"#--- search('</span><span class="si">#{</span><span class="n">ypath</span><span class="si">}</span><span class="s2">') ---"</span>
<span class="n">paths</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">tree</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">ypath</span><span class="p">)</span><span class="o">*</span><span class="p">\}\}</span>    <span class="c1"># paths はパスの配列</span>
<span class="n">paths</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
  <span class="n">pp</span> <span class="n">path</span>
<span class="k">end</span>

<span class="c1">## ツリーを探索し、ypath にマッチしたノードをすべて表示する</span>
<span class="nb">puts</span> <span class="s2">"#--- select('</span><span class="si">#{</span><span class="n">ypath</span><span class="si">}</span><span class="s2">') ---"</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">tree</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">ypath</span><span class="p">)</span><span class="o">*</span><span class="p">\}\}</span>    <span class="c1"># nodes はノードの配列</span>
<span class="n">nodes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">node</span><span class="p">.</span><span class="nf">transform</span><span class="o">*</span><span class="p">\}\}</span>    <span class="c1"># ノードをオブジェクトに変換する</span>
  <span class="n">pp</span> <span class="n">obj</span>
<span class="k">end</span>
<span class="c1">## または</span>
<span class="c1"># objs = \{\{*tree.select!(ypath)*\}\}</span>
<span class="c1"># objs.each do |obj|</span>
<span class="c1">#   pp obj</span>
<span class="c1"># end</span>

</code></pre></div></div>

<p>YPath を使ったスクリプトは本連載の第 2 回でも説明しましたが、もう一度説明します。</p>

<ul>
  <li>「YAML.parse(input)」は、文字列または IO オブジェクトを読み込んで、ツリー形式に変換します。</li>
  <li>ツリーはノード (YAML::Syck::Node オブジェクト) で構成されます<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>。ノードを Ruby のオブジェクト (Array、Hash、String、Fixnum など) に変換するには、YAML::Syck::Node#transform() を使います。</li>
  <li>ツリーを探索するメソッドには以下の 3 つがあります<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>。これらはどれも、文字列 ypath をもとにツリーを探索するという点では同じですが、戻り値が異なります。
    <ul>
      <li>Node#search(ypath) は、マッチしたノードのパスの配列を返します。</li>
      <li>Node#select(ypath) は、マッチしたノードの配列を返します。</li>
      <li>Node#select!(ypath) は、マッチしたノードに対して transform() を呼び出し、その結果のオブジェクトの配列を返します。</li>
    </ul>
  </li>
</ul>

<p>また検索対象となるサンプルドキュメントとして、次のような YAML ドキュメント「datafile.yaml」を用意してください。</p>

<p><a href="../../images/0013-YAML/datafile.yaml">datafile.yaml</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>teams:
  - name:        Akudaman
    members:
      - name:    Mujo
        age:     24
        leader:  yes
      - name:    Tobokkee
        age:     25
      - name:    Donjuro
        age:     30
  - name:        Doronboo
    members:
      - name:    Doronjo
        age:     24
        leader:  yes
      - name:    Boyakkie
        age:     25
      - name:    Tonzuraa
        age:     30

</code></pre></div></div>

<h2 id="ypath-の基本">YPath の基本</h2>

<h3 id="パス">パス</h3>

<p>YPath は、ファイルや URL のパスと同じように、パス要素と区切り文字から構成されます。</p>

<ul>
  <li>パス要素は「シーケンスのインデックス番号」または「マッピングのキー」です。</li>
  <li>パス要素の区切り文字は「/」です。</li>
</ul>

<p>例えばサンプルのデータファイルでは、「/teams/0/name」という YPath を指定すると「Akudaman」という文字列が検索されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '/teams/0/name' datafile.yaml
 #--- search('/teams/0/name') ---
 "/teams/0/name"
 #--- select('/teams/0/name') ---
 "Akudaman"</code></pre></figure>

<p>また「/teams/0/members」という YPath を指定すると、メンバーのデータを表すシーケンスが検索されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '/teams/0/members' datafile.yaml
 #--- search('/teams/0/members') ---
 "/teams/0/members"
 #--- select('/teams/0/members') ---
 [{"name"=&gt;"Mujo", "leader"=&gt;true, "age"=&gt;24},
  {"name"=&gt;"Tobokkee", "age"=&gt;25},
  {"name"=&gt;"Donjuro", "age"=&gt;30}]</code></pre></figure>

<h3 id="ルート">ルート</h3>

<p>ツリーのルートとなるノードは、「/.」という YPath で表されます。ここで「.」は現在のノードを表します<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '/.' datafile.yaml
 #--- search('/.') ---
 "/"
 #--- select('/.') ---
 {"teams"=&gt;
   [{"name"=&gt;"Akudaman",
     "members"=&gt;
      [{"name"=&gt;"Mujo", "leader"=&gt;true, "age"=&gt;24},
       {"name"=&gt;"Tobokkee", "age"=&gt;25},
       {"name"=&gt;"Donjuro", "age"=&gt;30}]},
    {"name"=&gt;"Doronboo",
     "members"=&gt;
      [{"name"=&gt;"Doronjo", "leader"=&gt;true, "age"=&gt;24},
       {"name"=&gt;"Boyakkie", "age"=&gt;25},
       {"name"=&gt;"Tonzuraa", "age"=&gt;30}]}]}</code></pre></figure>

<h3 id="任意の要素">任意の要素</h3>

<p>「*」はすべてのパス要素 (シーケンスならインデックス番号、マッピングならキー) にマッチします。</p>

<p>例えばサンプルのデータファイルにおいて、「/teams/<em>/name」を指定すればすべてのチーム名が、また「/teams/</em>/members/*/name」を指定すればすべてのメンバー名が検索されます。</p>

<p>「/teams/*/name」</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '/teams/*/name' datafile.yaml
 #--- search('/teams/*/name') ---
 "/teams/0/name"
 "/teams/1/name"
 #--- select('/teams/*/name') ---
 "Akudaman"
 "Doronboo"</code></pre></figure>

<p>「/teams/<em>/members/</em>/name」</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '/teams/*/members/*/name' datafile.yaml
 #--- search('/teams/*/members/*/name') ---
 "/teams/0/members/0/name"
 "/teams/0/members/1/name"
 "/teams/0/members/2/name"
 "/teams/1/members/0/name"
 "/teams/1/members/1/name"
 "/teams/1/members/2/name"
 #--- select('/teams/*/members/*/name') ---
 "Mujo"
 "Tobokkee"
 "Donjuro"
 "Doronjo"
 "Boyakkie"
 "Tonzuraa"</code></pre></figure>

<h3 id="再帰的な検索">再帰的な検索</h3>

<p>再帰的な検索を行うには「//」を使用します。
例えば「//name」を指定すると、すべてのマッピングの中から「name」をキーとする値を表示します。サンプルデータでなら、チーム名とメンバー名がすべて表示されます。</p>

<p>「//name」</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '//name' datafile.yaml
 #--- search('//name') ---
 "/teams/0/name"
 "/teams/0/members/0/name"
 "/teams/0/members/1/name"
 "/teams/0/members/2/name"
 "/teams/1/name"
 "/teams/1/members/0/name"
 "/teams/1/members/1/name"
 "/teams/1/members/2/name"
 #--- select('//name') ---
 "Akudaman"
 "Mujo"
 "Tobokkee"
 "Donjuro"
 "Doronboo"
 "Doronjo"
 "Boyakkie"
 "Tonzuraa"</code></pre></figure>

<p>「//」は、YPath の途中に現れても構いません。例えば「/teams//name」という指定をすれば、「/teams」以下のノードを探索し「//name」にマッチするものが検索されます。</p>

<h3 id="選択">選択</h3>

<table>
  <tbody>
    <tr>
      <td>複数の要素を指定するには、「</td>
      <td>」で区切ります。通常は「(foo</td>
      <td>bar</td>
      <td>baz)」のように丸括弧でくくります。</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>例えばサンプルのデータファイルでは、「//members/*/(name</td>
      <td>age)」という YPath を指定すると、すべてのメンバーの名前と年齢が検索できます。</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>「//members/*/(name</td>
      <td>age)」</td>
    </tr>
  </tbody>
</table>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '//members/*/(name|age)' datafile.yaml
 #--- search('//members/*/(name|age)') ---
 "/teams/0/members/0/name"
 "/teams/0/members/1/name"
 "/teams/0/members/2/name"
 "/teams/1/members/0/name"
 "/teams/1/members/1/name"
 "/teams/1/members/2/name"
 "/teams/0/members/0/age"
 "/teams/0/members/1/age"
 "/teams/0/members/2/age"
 "/teams/1/members/0/age"
 "/teams/1/members/1/age"
 "/teams/1/members/2/age"
 #--- select('//members/*/(name|age)') ---
 "Mujo"
 "Tobokkee"
 "Donjuro"
 "Doronjo"
 "Boyakkie"
 "Tonzuraa"
 24
 25
 30
 24
 25
 30</code></pre></figure>

<h3 id="条件">条件</h3>

<p>「[]」を使うと、簡単な探索条件を指定できます。今のところ、Syck が対応しているのは次の 2 つのようです。</p>

<ul>
  <li>指定されたキーを持つマッピング</li>
  <li>キーの値が指定された値と同じもの</li>
</ul>

<p>「//members/*[leader]」は、すべてのメンバーからキー「leader」を持つノードを検索します。</p>

<p>「//members/*[leader]」</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '//members/*[leader]' datafile.yaml
 #--- search('//members/*[leader]') ---
 "/teams/0/members/0"
 "/teams/1/members/0"
 #--- select('//members/*[leader]') ---
 {"name"=&gt;"Mujo", "leader"=&gt;true, "age"=&gt;24}
 {"name"=&gt;"Doronjo", "leader"=&gt;true, "age"=&gt;24}</code></pre></figure>

<p>「//members/*/age[.=25]」は、キー「age」の値が 25 であるものを検索します (今のところ、「以上」や「以下」などは指定できません)。「.=」のピリオドは「現在のノード」を表します。</p>

<p>「//members/*/age[.=25]」</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby show-ypath.rb '//members/*/age[.=25]' datafile.yaml
 #--- search('//members/*/age[.=25]') ---
 "/teams/0/members/1/age"
 "/teams/1/members/1/age"
 #--- select('//members/*/age[.=25]') ---
 25
 25</code></pre></figure>

<p>ここで「age の値が 25 であるようなマッピングのノード」を抽出できればいいのですが、Syck がサポートしている YPath だけではできないので、次のようなコードを使ってください<sup id="fnref:4"><a href="#fn:4" class="footnote">4</a></sup>。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> ## YAML ファイルを読み込み、ツリーに変換する
 str = ARGF.read()
 tree = YAML.parse(str)

 ## ypath にマッチしたノードのパスを取得する
 ypath = '//age[.=25]'         # 「age が 25である」ことを表す YPath
 paths = tree.search(ypath)    # paths はパスの配列

 ## パスから最後の要素を取り除く
 ## (ex. "/teams/0/members/1/age" =&gt; "/teams/0/members/1")
 paths = paths.collect { |path| File.dirname(path) }

 ## ノードを表示する
 nodes = tree.select(ypath)    # nodes はノードの配列
 nodes.each do |node|
   pp node.transform
 end</code></pre></figure>

<h2 id="応用例yaml-ドキュメント検索ツール">応用例：YAML ドキュメント検索ツール</h2>

<h3 id="コマンドyamlgrep">コマンド「yamlgrep」</h3>

<p>YPath の応用例として、YPath を使って YAML ドキュメントを検索するツール「yamlgrep」を作成してみます。ちょうど grep が正規表現でテキストファイルを検索するように、yamlgrep では YPath で YAML ファイルを検索します。</p>

<p><a href="../../images/0013-YAML/yamlgrep">yamlgrep</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/ruby</span>

<span class="c1">##</span>
<span class="c1">## yamlgrep - YAML ファイルから YPath にマッチしたデータを抜き出す</span>
<span class="c1">##</span>

<span class="k">def</span> <span class="nf">usage</span><span class="p">()</span>
  <span class="n">command</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="vg">$0</span><span class="p">)</span>
  <span class="n">s</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="no">END</span><span class="sh">
使い方:  </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sh"> [-h] [-q] [-u[N]] [-z ypath] ypath-pattern [yamlfile ...]
  -h        : ヘルプ
  -q        : 余分な出力を抑える (quietモード)
  -u[N]     : 親をたどる数 (省略時 N=1)
  -z ypath  : 末尾に追加する YPath パターン
</span><span class="no">END</span>
  <span class="k">return</span> <span class="n">s</span>
<span class="k">end</span>


<span class="nb">require</span> <span class="s1">'yaml'</span>

<span class="c1">## コマンドラインオプションを解析</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">while</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">/^-/</span>
  <span class="n">opt</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
  <span class="k">case</span> <span class="n">opt</span>
  <span class="k">when</span> <span class="s1">'-h'</span><span class="p">,</span> <span class="s1">'--help'</span>     <span class="c1"># ヘルプ</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:help</span><span class="p">]</span>   <span class="o">=</span> <span class="kp">true</span>
  <span class="k">when</span> <span class="s1">'-q'</span>               <span class="c1"># 余分な出力を抑える</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:quiet</span><span class="p">]</span>  <span class="o">=</span> <span class="kp">true</span>
  <span class="k">when</span> <span class="sr">/^-u(\d*)/</span>         <span class="c1"># 親をたどる数</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:parent</span><span class="p">]</span> <span class="o">=</span> <span class="vg">$1</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="vg">$1</span><span class="p">.</span><span class="nf">to_i</span>
  <span class="k">when</span> <span class="sr">/^-z(.*)/</span>          <span class="c1"># 末尾に追加する YPath</span>
    <span class="n">ypath</span> <span class="o">=</span> <span class="vg">$1</span><span class="p">.</span><span class="nf">empty?</span> <span class="p">?</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span> <span class="p">:</span> <span class="vg">$1</span>
    <span class="k">unless</span> <span class="n">ypath</span>
      <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">opt</span><span class="si">}</span><span class="s2">: YPath パターンが指定されていません。"</span>
      <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">options</span><span class="p">[</span><span class="ss">:tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">ypath</span>
  <span class="k">else</span>
    <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">opt</span><span class="si">}</span><span class="s2">: 不正なオプションです。"</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1">## ヘルプを表示</span>
<span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:help</span><span class="p">]</span>
  <span class="nb">puts</span> <span class="n">usage</span><span class="p">()</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">## YPath パターンを読み取る</span>
<span class="n">ypath</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span>
<span class="k">unless</span> <span class="n">ypath</span>
  <span class="vg">$stderr</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"YPath パターンが指定されていません。"</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">## YAML ファイルを読み込み、ツリーに変換</span>
<span class="n">str</span> <span class="o">=</span> <span class="no">ARGF</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
<span class="n">tree</span> <span class="o">=</span> <span class="no">YAML</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>

<span class="c1">## YPath にマッチするパスをすべて取得</span>
<span class="n">paths</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">tree</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="n">ypath</span><span class="p">)</span><span class="o">*</span><span class="p">\}\}</span>

<span class="c1">## パスごとにノードを取得し、データを表示</span>
<span class="n">paths</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>

  <span class="c1">## -u オプションがあれば親をたどる</span>
  <span class="n">options</span><span class="p">[</span><span class="ss">:parent</span><span class="p">].</span><span class="nf">times</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">}</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:parent</span><span class="p">]</span>

  <span class="c1">## -z オプションがあれば YPath パターンを末尾に追加する</span>
  <span class="n">path</span> <span class="o">&lt;&lt;</span> <span class="n">options</span><span class="p">[</span><span class="ss">:tail</span><span class="p">]</span> <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="ss">:tail</span><span class="p">]</span>

  <span class="c1">## ノードを取得してオブジェクトに変換する</span>
  <span class="n">objs</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">nodes</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">tree</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">*</span><span class="p">\}\}</span>
  <span class="n">nodes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">node</span><span class="p">.</span><span class="nf">transform</span><span class="o">*</span><span class="p">\}\}</span>         <span class="c1"># ノードをオブジェクトに変換</span>
    <span class="n">objs</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span>
  <span class="k">end</span>

  <span class="c1">## 表示する</span>
  <span class="nb">puts</span> <span class="s2">"## </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span> <span class="k">unless</span> <span class="n">options</span><span class="p">[</span><span class="ss">:quiet</span><span class="p">]</span>
  <span class="n">s</span> <span class="o">=</span> <span class="p">\{\{</span><span class="o">*</span><span class="n">objs</span><span class="p">.</span><span class="nf">to_yaml</span><span class="o">*</span><span class="p">\}\}</span>               <span class="c1"># YAML 形式の文字列に変換</span>
  <span class="nb">puts</span> <span class="n">s</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/^---\s*\n?/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>   <span class="c1"># ドキュメントの区切り「---」を取り除く</span>
  <span class="nb">puts</span> <span class="k">unless</span> <span class="n">options</span><span class="p">[</span><span class="ss">:quiet</span><span class="p">]</span>

<span class="k">end</span>

</code></pre></div></div>

<h3 id="使い方">使い方</h3>

<p>yamlgrep の基本的な使い方は、「yamlgrep <em>YPathパターン</em> <em>[ファイル名 …]</em>」です。ファイル名が省略された場合は標準入力が使われます。例えば「Doronjo」という名前のメンバーがいるかどうかは次のようにして検索できます (実行例のデータファイルは前のセクションと同じものです)。</p>

<p>実行例： 名前が「Doronjo」であるデータを表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep '//members/*/name[.=Doronjo]' datafile.yaml
 ## /teams/1/members/0/name
 - Doronjo</code></pre></figure>

<p>オプション「-u_[N]_」を使うと、マッチしたパスの親をたどります。例えば上の例では「Doronjo」という名前しか表示されませんでしたが、オプション「-u1」をつけるとメンバーのデータをすべて表示できます。</p>

<p>実行例： メンバー「Doronjo」のデータを表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u1 '//members/*/name[.=Doronjo]' datafile.yaml
 ## /teams/1/members/0
 - name: Doronjo
   leader: true
   age: 24</code></pre></figure>

<table>
  <tbody>
    <tr>
      <td>オプション「-z <em>YPath</em>」を使うと、マッチしたパスの末尾に YPath を追加できます。例えば上の例に「-z ‘/(name</td>
      <td>age)’」をつけると、名前と年齢だけが表示されます。</td>
    </tr>
  </tbody>
</table>

<p>実行例： メンバー「Doronjo」の名前と年齢だけを表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u1 -z '/(name|age)' '//members/*/name[.=Doronjo]' datafile.yaml
 ## /teams/1/members/0/(name|age)
 - Doronjo
 - 24</code></pre></figure>

<p>オプション「-q」をつけると、余分な出力 (マッチしたパスおよび空行) を出力しないようにします。例えば全メンバーの名前を検索するには YPath として「//members/*/name」を指定しますが、そのままだとマッチしたパスおよび空行が表示されます。</p>

<p>実行例： 全メンバーの名前を出力 (「-q」なし)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep '//members/*/name' datafile.yaml
 ## /teams/0/members/0/name
 - Mujo

 ## /teams/0/members/1/name
 - Tobokkee

 ## /teams/0/members/2/name
 - Donjuro

 ## /teams/1/members/0/name
 - Doronjo

 ## /teams/1/members/1/name
 - Boyakkie

 ## /teams/1/members/2/name
 - Tonzuraa</code></pre></figure>

<p>ここでオプション「-q」をつけると、マッチしたパスおよび空行が表示されなくなります。コマンド「wc -l」でカウントするときなどに便利です。</p>

<p>実行例： 全メンバーの名前を出力 (「-q」あり)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -q '//members/*/name' datafile.yaml
 - Mujo
 - Tobokkee
 - Donjuro
 - Doronjo
 - Boyakkie
 - Tonzuraa</code></pre></figure>

<p>なお yamlgrep では出力も YAML 形式になっているので、yamlgrep の出力を yamlgrep で処理することも可能です。</p>

<h3 id="実行例">実行例</h3>

<p>ほかの実行例をいくつか示します。</p>

<p>実行例： チーム名の一覧を表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep '/teams/*/name'  datafile.yaml
 ## /teams/0/name
 - Akudaman

 ## /teams/1/name
 - Doronboo</code></pre></figure>

<p>実行例： Akudaman一味を表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u1 '/teams/*/name[.=Akudaman]'  datafile.yaml
 ## /teams/0
 - name: Akudaman
   members:
   - name: Mujo
     leader: true
     age: 24
   - name: Tobokkee
     age: 25
   - name: Donjuro
     age: 30</code></pre></figure>

<p>実行例： Mujoさまが所属するチームの名前を表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u3 -z '/name' '//members/*/name[.=Mujo]'  datafile.yaml
 ## /teams/0/name
 - Akudaman</code></pre></figure>

<p>実行例： チームリーダをすべて表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u1 '//leader[.=yes]'  datafile.yaml
 ## /teams/0/members/0
 - name: Mujo
   leader: true
   age: 24

 ## /teams/1/members/0
 - name: Doronjo
   leader: true
   age: 24</code></pre></figure>

<p>実行例： チームリーダの名前だけを表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u1 -z '/name' '//leader[.=yes]'  datafile.yaml
 ## /teams/0/members/0/name
 - Mujo

 ## /teams/1/members/0/name
 - Doronjo</code></pre></figure>

<p>実行例： チームリーダの名前と年齢を表示</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ruby yamlgrep -u1 -z '/(name|age)' '//leader[.=yes]'  datafile.yaml
 ## /teams/0/members/0/(name|age)
 - Mujo
 - 24

 ## /teams/1/members/0/(name|age)
 - Doronjo
 - 24</code></pre></figure>

<h2 id="おわりに">おわりに</h2>

<p>今回は YPath について説明しました。YPath とは、YAML ドキュメント中のデータをパス形式で指定したり検索するための仕様です。仕様はまだ議論の最中であり固まっていませんが、Syck では最低限の機能は実装されているので、興味のある方は試してみてください。</p>

<p>なお本連載はこれにて終了です。本当は「車輪の再発明編」と題して YAML パーサの作り方をやろうかと思ったのですが、書いてみると趣味丸出しになってしまったので、苦情がくる前に自主規制しておきます。長いことお付き合いくださりありがとうございました。</p>

<h2 id="著者について">著者について</h2>

<p>名前：kwatch。三流プログラマー。親戚の子供にお年玉をあげてなかったら、「お年玉あげられないほど貧乏なの？　人生負け組だね。」と 6 歳児にいわれ、かなり鬱。最近のお気に入りは「ダ・ビンチ・コード」。</p>

<h2 id="プログラマーのための-yaml-入門-連載一覧">プログラマーのための YAML 入門 連載一覧</h2>

<ul>
  <li>
    <p><a href="../../articles/0013/0013-YAML.html">プログラマーのための YAML 入門 (探索編)</a></p>
  </li>
  <li>
    <p><a href="../../articles/0012/0012-YAML.html">プログラマーのための YAML 入門 (検証編)</a></p>
  </li>
  <li>
    <p><a href="../../articles/0011/0011-YAML.html">プログラマーのための YAML 入門 (実践編)</a></p>
  </li>
  <li>
    <p><a href="../../articles/0010/0010-YAML.html">プログラマーのための YAML 入門 (中級編)</a></p>
  </li>
  <li>
    <p><a href="../../articles/0009/0009-YAML.html">プログラマーのための YAML 入門 (初級編)</a></p>
  </li>
</ul>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>実際には YAML::Syck::Node のサブクラスである YAML::Syck::Seq、YAML::Syck::Map、YAML::Syck::Serial が使用されます。 <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>これらのメソッドは YAML::BaseNode モジュールで定義されており、これを YAML::Syck::Node クラスが include しています。 <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>本当なら「.」で現在のノードを、「..」で親のノードを表すはずなのですが、「..」は今のところ動作しないようです。 <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:4">
      <p>本来なら「//members/*[age=25]」のように書けるとよいのですが、YPath の仕様が決まってないこともあり、Syck ではこのような探索条件がサポートされていません。 <a href="#fnref:4" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
