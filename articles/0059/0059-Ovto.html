<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RubyistのためのフロントエンドフレームワークOvto</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0059/0059-Ovto.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    <li><a href="../../articles/backnumber/backnumber.html">記事単位</a></li>
    <hr>
    
        <li><a href="../../articles/prerubykaigi2020/preRubyKaigi2020-index.html">RubyKaigi Takeout 2020 直前特集号</a></li>
    
        <li><a href="../../articles/0061/0061-index.html">0061号(2020-02)</a></li>
    
        <li><a href="../../articles/0060/0060-index.html">0060号(2019-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2019/preRubyKaigi2019-index.html">RubyKaigi 2019 直前特集号</a></li>
    
        <li><a href="../../articles/0059/0059-index.html">0059号(2019-01)</a></li>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>RubyistのためのフロントエンドフレームワークOvto</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=RubyistのためのフロントエンドフレームワークOvto&amp;url=https://magazine.rubyist.net/articles/0059/0059-Ovto.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0059/0059-Ovto.html&amp;t=RubyistのためのフロントエンドフレームワークOvto" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0059/0059-Ovto.html&amp;RubyistのためのフロントエンドフレームワークOvto" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            
  <span class="author">著者：yhara</span><br />


  <span class="created_on">初稿：2019年1月27日</span>



                        </div>
                        
<h2 id="はじめに">はじめに</h2>

<p>こんにちは。yharaです。みなさんはWebアプリを作るとき何を使っているでしょうか？Ruby界隈だと、Railsと答える人が多そうですね。ではフロント側は？React、Vue.js、Angularなどいろいろありますね。</p>

<p>そんな中で、hyperappというフレームワークを聞いたことはあるでしょうか。hyperappはわずか<a href="https://github.com/jorgebucaran/hyperapp/blob/1.2.9/src/index.js">400行</a>のJavaScriptで実装された「マイクロフレームワーク」ですが、そのサイズからは考えられないほど本格的な機能を持っています。</p>

<p>hyperappを見て私は思いました。これはすごい、たったこれだけでReact＋Reduxのかなりの機能が提供できているじゃないか、と。そして、400行しかないのなら、これをまるごとRubyに移植できないだろうか？と。</p>

<p>そうしてできたのがRubyistのためのフロントエンドフレームワーク「Ovto」です。シンプルで高機能なAPIを持つのはhyperappと同じですが、アプリを全てRubyで書けるというのが違うところです:-)</p>

<p>本稿ではOvtoの概要と、簡単なサンプルアプリを作るところまでを解説します。Ovtoは、自分で言うのもなんですが使っていて楽しいフレームワークなので、ぜひ手を動かしてみてください。</p>

<h2 id="ovtoとは">Ovtoとは</h2>

<p><a href="https://yhara.github.io/ovto/">Ovto(オブト)</a>はReactやVue.js等と同じく、ブラウザ上で動く複雑なアプリケーションを作るためのフレームワークです。サーバ側の機能はないので、例えばDBにデータを保存したりしたい場合はRailsやSinatraなどと組み合わせて使うことを想定しています。</p>

<p><a href="https://yhara.github.io/ovto/"><img src="../../images/0059-Ovto/ovtologo.png" alt="Ovtoロゴ" /></a></p>

<p>Ovtoの特徴は以下です。</p>

<dl>
  <dt>Rubyで書ける</dt>
  <dd>普通、ブラウザで動くアプリはJavaScriptで書く必要がありますが、OvtoではRubyだけでアプリを作ることができます。Ovtoで作ったアプリは、<a href="https://opalrb.com">Opal</a>を使ってJavaScriptにコンパイルすることでブラウザで動かします。</dd>
  <dt>学習が簡単</dt>
  <dd>State, Actions, Componentという3つのクラスを覚えるだけで実用的なアプリが作れます。</dd>
  <dt>仮想DOMベース</dt>
  <dd>Reactと同じく仮想DOMベースで、全体の構造を管理しつつも高速なレンダリングが可能です。</dd>
  <dt>シングルステート</dt>
  <dd>react-reduxのように、アプリは単一の状態を持ち、状態が決まれば画面も決まります。</dd>
</dl>

<p>難しいことを書きましたけど、一番大事なのはOvtoは「楽しい」ということです。Ovtoができたあと、何か実用的なアプリを作ってみようということで<a href="https://github.com/yhara/vision">Vision</a>というTODOアプリを作ったのですが、その過程はとても楽しかったです。</p>

<h2 id="ovtoアプリを作る">Ovtoアプリを作る</h2>

<p>ここからは実際にOvtoアプリを作っていきます。今回は説明を簡単にするため、静的なhtmlファイルを使いますが、RailsやSinatraと組み合わせる場合もアプリの書き方は同じです。Rails・SinatraアプリにOvtoアプリを埋め込む方法については、以下のサンプルを参考にしてください。</p>

<ul>
  <li>(Rails) <a href="https://github.com/yhara/vision/">https://github.com/yhara/vision/</a></li>
  <li>(Sinatra) <a href="https://github.com/yhara/ovto/tree/master/examples/sinatra">https://github.com/yhara/ovto/tree/master/examples/sinatra</a></li>
</ul>

<h3 id="準備">準備</h3>

<p>RubyとBundlerはインストールされているものとします。以下のようなGemfileを作り、<code class="language-plaintext highlighter-rouge">bundle install</code>します。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'ovto'</span>
<span class="n">gem</span> <span class="s1">'rake'</span>
</code></pre></div></div>

<p>同じディレクトリに、以下の3つのファイルを作ります。</p>

<p>まずは<code class="language-plaintext highlighter-rouge">index.html</code>。このファイルはこれで完成、つまり本稿の最後までこのままです。ほとんどdivタグしかないように見えますが、中身はOvtoで作っていくのでこれで良いのです。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">'text/javascript'</span> <span class="na">src=</span><span class="s">'app.js'</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">'stylesheet'</span> <span class="na">href=</span><span class="s">'style.css'</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'ovto'</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'ovto-debug'</span><span class="nt">&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>次は<code class="language-plaintext highlighter-rouge">style.css</code>。スタイルシートです。今回はサンプルコードなので、最小限のスタイルだけ適用します。以下のように書いてください(あとで使います)。</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">table</span><span class="nf">#board</span> <span class="nt">td</span> <span class="p">{</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">50px</span><span class="p">;</span>
  <span class="nl">height</span><span class="p">:</span> <span class="m">50px</span><span class="p">;</span>
  <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="no">black</span><span class="p">;</span>
  <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最後に<code class="language-plaintext highlighter-rouge">app.rb</code>です。このファイルにOvtoのコードを書いていきます。まずは画面にHELLOと出すだけの、最小限のOvtoアプリを用意します。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'ovto'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">App</span>
  <span class="k">class</span> <span class="nc">State</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Actions</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Actions</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">MainComponent</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">o</span> <span class="s1">'div'</span> <span class="k">do</span>
        <span class="n">o</span> <span class="s1">'h1'</span><span class="p">,</span> <span class="s2">"HELLO"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">MyApp</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">id: </span><span class="s1">'ovto'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="コンパイルする">コンパイルする</h3>

<p>3つのファイルが用意できたら、さっそく動かしてみましょう。以下のコマンドを実行すると、app.rbがapp.jsに変換されます。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bundle exec opal -c -g ovto app.rb &gt; app.js
</code></pre></div></div>

<p>index.htmlをブラウザで開くと、HELLOと表示されたはずです。</p>

<p>これでOvtoアプリを作る環境が整いました。試しに「HELLO」の部分を適当な文字列に変えて、もう一度コンパイルしてみてください。ブラウザをリロードすれば文字が変わるはずです。(変わらない場合はブラウザのキャッシュが効いているかもしれません。例えばGoogle Chromeの場合は、開発者コンソールを開いて「Disable Cache」にチェックを入れることで、一時的にキャッシュを無効化できます)</p>

<h3 id="state-actions-component">State, Actions, Component</h3>

<p>app.rbには、State, Actions, MainComponentという3つのクラスが出てきました。Ovtoではこの3つのクラスを使ってアプリを書いていきます。</p>

<p>Stateはアプリケーションの状態を保持するクラスです。MainComponentはビューの定義で、<code class="language-plaintext highlighter-rouge">state</code>を受け取ってどんな画面を表示したいかを記述します。</p>

<p>Actionは<code class="language-plaintext highlighter-rouge">state</code>に変更を加えるものです。アプリケーションの動作中は、アプリの状態は刻一刻と変化していきますが、MainComponentから直接<code class="language-plaintext highlighter-rouge">state</code>を書き換えることはできません。<code class="language-plaintext highlighter-rouge">state</code>を書き換えたいときは、Actionsクラスに定義したメソッド(以下では単に「アクション」と呼びます)を経由する必要があります。一見めんどくさそうですが、このような制約を設けることにより、「状態がどのように変化するのか」「状態がどこで変化するのか」を調べるのがとても簡単になります。</p>

<p>以下では「カウンター」というデモを通して、3つのクラスの具体例を見ていきます。</p>

<h3 id="state">State</h3>

<p>最初に、Stateクラスを以下のようにします。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">App</span>
  <span class="k">class</span> <span class="nc">State</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
    <span class="n">item</span> <span class="ss">:count</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>itemメソッドはStateクラスの要素を宣言します。ここではcountという要素を宣言しています。要素が複数あるときはitemメソッドの呼び出しを並べます。<code class="language-plaintext highlighter-rouge">default:</code>はデフォルト値の指定です。</p>

<p>StateオブジェクトはState.newで作れます。引数には各要素の値を指定します。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">state</span> <span class="o">=</span> <span class="no">MyApp</span><span class="o">::</span><span class="no">State</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">count: </span><span class="mi">15</span><span class="p">)</span>
<span class="n">state</span><span class="p">.</span><span class="nf">count</span>  <span class="c1">#=&gt; 15</span>
</code></pre></div></div>

<p>引数を省略した場合はデフォルト値で初期化されます。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">state</span> <span class="o">=</span> <span class="no">MyApp</span><span class="o">::</span><span class="no">State</span><span class="p">.</span><span class="nf">new</span>
<span class="n">state</span><span class="p">.</span><span class="nf">count</span>  <span class="c1">#=&gt; 0</span>
</code></pre></div></div>

<h3 id="maincomponent">MainComponent</h3>

<p>次にMainComponentを書いてみましょう。以下のように書き換えてみてください。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">MainComponent</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">o</span> <span class="s1">'div'</span> <span class="k">do</span>
        <span class="n">o</span> <span class="s1">'h1'</span><span class="p">,</span> <span class="s1">'Counter'</span>
        <span class="n">o</span> <span class="s1">'div'</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="nf">count</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>これを実行すると以下のようになります。</p>

<p><img src="../../images/0059-Ovto/counter_0.png" alt="Counter 0" /></p>

<p>開発者コンソールを開くと、<code class="language-plaintext highlighter-rouge">&lt;div id='ovto'&gt;</code>内に以下のようなHTMLが生成されていることがわかります。</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Counter<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;div&gt;</span>0<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">MyApp.run</code>でOvtoアプリを起動すると、まずMyApp::Stateクラスのオブジェクトが自動的に作成され、それを引数としてMainComponentクラスのrenderメソッドが呼ばれます。引数の<code class="language-plaintext highlighter-rouge">state:</code>というのは見慣れないかもしれませんが、キーワード引数の初期値を省略した形です。Ovtoではキーワード引数を多用するので、この機会に慣れてください。<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup></p>

<p>renderメソッドは、「このようなDOMを生成してほしい」という依頼を返さなくてはなりません。この依頼を作成するのがoメソッドです。</p>

<h3 id="oメソッド">oメソッド</h3>

<p>ぱっと見では箇条書きみたいに見えますが、「o」はOvto::Componentクラスが提供する1文字メソッドです。以下のように括弧をつければ、メソッド呼び出しであることがわかりやすいでしょうか。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">o</span><span class="p">(</span><span class="s1">'h1'</span><span class="p">,</span> <span class="s1">'Counter'</span><span class="p">)</span>
</code></pre></div></div>

<p>oメソッドは以下の引数を取ります。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">o</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{},</span> <span class="n">content</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</code></pre></div></div>

<p>tag_nameは<code class="language-plaintext highlighter-rouge">'div'</code>など、HTMLのタグ名を指定します。attrsはタグの属性値をハッシュで指定します(省略可)。contentはタグの中身を文字列で指定します。</p>

<p>タグの中身はブロックで渡すこともできます。タグをネストさせたいときはブロックを使います。</p>

<h3 id="actions">Actions</h3>

<p>stateを表示する方法がわかったので、次はstateを書き換えられるようにしましょう。</p>

<p>前述のように、Componentから直接stateを書き換えることはできません。書き換えたいときは必ずActionsを通す必要があります。ということで、Actionsクラスに「カウントを増やす」というメソッドを定義します。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">Actions</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Actions</span>
    <span class="k">def</span> <span class="nf">increment_count</span><span class="p">(</span><span class="n">state</span><span class="p">:,</span> <span class="n">num</span><span class="p">:)</span>
      <span class="k">return</span> <span class="p">{</span><span class="ss">count: </span><span class="n">state</span><span class="p">.</span><span class="nf">count</span> <span class="o">+</span> <span class="n">num</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Actionsクラスのメソッドは、stateをキーワード引数で受け取り、stateのどの要素がどう変化するかをハッシュで返します。</p>

<h3 id="アクションを呼ぶ">アクションを呼ぶ</h3>

<p>次にMainComponentを編集してこのアクションを呼ぶボタンを設置してみましょう。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">MainComponent</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">o</span> <span class="s1">'div'</span> <span class="k">do</span>
        <span class="n">o</span> <span class="s1">'h1'</span><span class="p">,</span> <span class="s1">'Counter'</span>
        <span class="n">o</span> <span class="s1">'div'</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="nf">count</span>
        <span class="c1"># カウントを増やすボタン</span>
        <span class="n">o</span> <span class="s1">'input'</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'button'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">increment_count</span><span class="p">(</span><span class="ss">num: </span><span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="ss">value: </span><span class="s1">'+1'</span>
        <span class="n">o</span> <span class="s1">'input'</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'button'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">increment_count</span><span class="p">(</span><span class="ss">num: </span><span class="mi">3</span><span class="p">)</span> <span class="p">},</span> <span class="ss">value: </span><span class="s1">'+3'</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>上記を実行してボタンを押すと、どうなるでしょうか？そう、画面に表示されるカウントが変化したはずです。</p>

<p><img src="../../images/0059-Ovto/counter_26.png" alt="Counter 26 +1 +3" /></p>

<p>Ovtoはstateが変化すると、自動的に新しいstateで画面を再描画します。これは、jQueryを使ったプログラミングと一味違うところです。jQueryの場合は「画面をどう変化させるか」を常に考えなければいけないので、「○○画面を開いて最初のボタンをクリックして二番目のフォームを…」のように複雑なアプリになると大変になってきます。</p>

<p>一方Ovtoの場合は「各状態がどういう画面になるか」をしっかり書いておけば、あとは状態を変化させるだけで自動的に画面ができあがります！</p>

<h3 id="イベントハンドラ">イベントハンドラ</h3>

<p>「ボタンが押されたとき」のようなイベントハンドラの指定もoメソッドを使います。以下の<code class="language-plaintext highlighter-rouge">onclick:</code>で渡しているのがイベントハンドラです。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">o</span> <span class="s1">'input'</span><span class="p">,</span> <span class="ss">type: </span><span class="s1">'button'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">increment_count</span><span class="p">(</span><span class="ss">num: </span><span class="mi">1</span><span class="p">)</span> <span class="p">},</span> <span class="ss">value: </span><span class="s1">'+1'</span>
</code></pre></div></div>

<p>oメソッドの第二引数にハッシュを指定した場合、タグの属性値の指定になりますが、いくつか特殊な指定があります。</p>

<ul>
  <li>onxx(onclick, onchange等): イベントハンドラの指定</li>
  <li>style: CSSの指定(文字列ではなくハッシュを渡す)</li>
  <li>oncreate/onupdate/onremove/ondestroy: タグのライフサイクルイベント(生成・削除等)をフックする</li>
  <li>key: <a href="https://github.com/hyperapp/hyperapp#keys">キー</a>の指定</li>
</ul>

<p>上のコードでは、onclickを使ってボタンが押されたときの処理を記述しています。実行したい処理はProcオブジェクトで指定します。<code class="language-plaintext highlighter-rouge">-&gt;(){ ... }</code>はProcオブジェクトを作るRubyの文法です。</p>

<p>イベントハンドラ内では、<code class="language-plaintext highlighter-rouge">actions</code>メソッドを経由してアクションを呼び出すことができます。アクションを実行すると、stateが更新され、新しいstateを引数にしてrenderが呼び出されて、画面が書き換わります。<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup></p>

<h2 id="ovtoで三目並べを作る">Ovtoで三目並べを作る</h2>

<p>以上で、Ovtoの根幹であるStateとActionsとMainComponentについて解説できました。ここからはもう少し複雑なアプリケーションとして、三目並べゲームを作ってみます。</p>

<h3 id="stateを考える">Stateを考える</h3>

<p>Ovtoでアプリを作るときは、まずStateから設計します。まずは盤面データが必要ですね。これは3x3の二次元配列にすれば良さそうです。各セルは「○」「×」「空」のいずれかなので、それぞれ<code class="language-plaintext highlighter-rouge">0</code>, <code class="language-plaintext highlighter-rouge">1</code>, <code class="language-plaintext highlighter-rouge">nil</code>で表すことにしましょう。</p>

<p>あとは今どっちの手番かも覚えておく必要があります。とすると、こんな感じでしょうか。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">State</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
    <span class="c1"># 盤面データ(0または1またはnil)</span>
    <span class="n">item</span> <span class="ss">:board</span><span class="p">,</span> <span class="ss">default: </span><span class="p">[</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="c1"># 現在のプレイヤー(0または1)</span>
    <span class="n">item</span> <span class="ss">:player</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
</code></pre></div></div>

<h3 id="盤面を描画する">盤面を描画する</h3>

<p>Stateが決まったら、それを使って画面を作ります。<code class="language-plaintext highlighter-rouge">MyApp::MainComponent</code>を以下のように書き換えてください。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">MainComponent</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="no">PLAYER_MARK</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'○'</span><span class="p">,</span> <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'×'</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">o</span> <span class="s1">'div'</span> <span class="k">do</span>
        <span class="n">o</span> <span class="s1">'div#player'</span> <span class="k">do</span>
          <span class="s2">"PLAYER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">player</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">end</span>
        <span class="n">o</span> <span class="s1">'table#board'</span> <span class="k">do</span>
          <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
            <span class="n">o</span> <span class="s1">'tr'</span> <span class="k">do</span>
              <span class="n">row</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">cell</span><span class="o">|</span>
                <span class="n">o</span> <span class="s1">'td'</span> <span class="k">do</span>
                  <span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
                <span class="k">end</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>ゲームボードとプレイヤー情報が出るようになりました。tdタグに枠線が付いているのは、最初に説明したstyle.cssのおかげです。</p>

<p><img src="../../images/0059-Ovto/empty_board.png" alt="Player: ○ 空のゲーム盤" /></p>

<h3 id="アクションを書く">アクションを書く</h3>

<p>ボードが出たので、思わずクリックしたくなりますが、今はクリックしても何も起きません。tdタグのonclickイベントを使って、○×を置けるようにしましょう。○×を置くということは<code class="language-plaintext highlighter-rouge">state.board</code>を変更するということなので、まずはセルに○×を置くアクションが必要です。</p>

<p>セルの内容を更新するアクションということで、<code class="language-plaintext highlighter-rouge">update_cell</code>という名前にしましょうか。引数としてどのセルなのか(<code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">y</code>)を受け取る必要がありそうです。あとは○と×のどっちを置くかという情報も必要ですが、これは<code class="language-plaintext highlighter-rouge">state.player</code>を見ればわかるので引数にはしなくて良いでしょう。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">Actions</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Actions</span>
    <span class="k">def</span> <span class="nf">update_cell</span><span class="p">(</span><span class="n">state</span><span class="p">:,</span> <span class="n">x</span><span class="p">:,</span> <span class="n">y</span><span class="p">:)</span>
      <span class="c1"># 新しい盤面を作る</span>
      <span class="n">new_board</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="n">row</span><span class="p">.</span><span class="nf">dup</span><span class="p">}</span>
      <span class="n">new_board</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="nf">player</span>
      <span class="c1"># 新しいプレイヤーは、現在と逆のプレイヤー(0なら1、1なら0)</span>
      <span class="n">new_player</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">state</span><span class="p">.</span><span class="nf">player</span>
      <span class="k">return</span> <span class="p">{</span><span class="ss">board: </span><span class="n">new_board</span><span class="p">,</span> <span class="ss">player: </span><span class="n">new_player</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>ここで一つOvtoの大事なルールを紹介します。それは<strong>stateに入っているオブジェクトを破壊的に変更してはいけない</strong>ということです。例えば、盤面を更新するのに<code class="language-plaintext highlighter-rouge">state.board[y][x] = ...</code>とするのではなく、新しい3x3のArrayを作ってやらないといけないということです。</p>

<p>というのはOvtoでは効率のため、stateが変化していない(<code class="language-plaintext highlighter-rouge">==</code>が真を返す)場合は画面を更新しないからです。そのため、現在のstateは変化前のものとして触らないでおく必要があるのです。</p>

<p>上記では<code class="language-plaintext highlighter-rouge">new_board = state.board.map{|row| row.dup}</code>のようにしてArray全体を複製しています。</p>

<h3 id="アクションを呼ぶ-1">アクションを呼ぶ</h3>

<p>アクションができたので、tdにonclickイベントのハンドラを追加し、セルがクリックされたらこのアクションを呼ぶようにします。そのときにどのセルがクリックされたかを渡す必要があるので、2箇所の<code class="language-plaintext highlighter-rouge">.each</code>に<code class="language-plaintext highlighter-rouge">.with_index</code>を付けて、<code class="language-plaintext highlighter-rouge">x</code>と<code class="language-plaintext highlighter-rouge">y</code>が取れるようにします。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">o</span> <span class="s1">'table#board'</span> <span class="k">do</span>
          <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">.</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span>
            <span class="n">o</span> <span class="s1">'tr'</span> <span class="k">do</span>
              <span class="n">row</span><span class="p">.</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">cell</span><span class="p">,</span> <span class="n">x</span><span class="o">|</span>
                <span class="n">o</span> <span class="s1">'td'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">update_cell</span><span class="p">(</span><span class="ss">x: </span><span class="n">x</span><span class="p">,</span> <span class="ss">y: </span><span class="n">y</span><span class="p">)</span> <span class="p">}</span> <span class="k">do</span>
                  <span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
                <span class="k">end</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
</code></pre></div></div>

<p>これで、クリックすると○×が置けるようになりました。また、プレイヤー欄も○から×にちゃんと変化していますね。</p>

<p><img src="../../images/0059-Ovto/board_oxo.png" alt="ゲーム中" /></p>

<h3 id="バグ修正">バグ修正</h3>

<p>上のコードにはバグがあるのですが、お気づきでしょうか？<code class="language-plaintext highlighter-rouge">update_cell</code>では指定された座標に○または×を置いていますが、そこに今何が入っているかはチェックしていませんね。なので、なんと相手の手を上書きすることができてしまいます！</p>

<p>これは以下の1行を追加して、指定された場所にすでに何か入っている場合はすぐにreturnするようにすれば直ります。アクションがnilを返した場合、stateは更新されません。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">update_cell</span><span class="p">(</span><span class="n">state</span><span class="p">:,</span> <span class="n">x</span><span class="p">:,</span> <span class="n">y</span><span class="p">:)</span>
      <span class="c1"># そこには置けない</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="kp">nil</span>
      <span class="o">...</span>
    <span class="k">end</span>
</code></pre></div></div>

<h3 id="勝者を判定する">勝者を判定する</h3>

<p>これで対戦ができるようになりましたが、○か×を3つ並べてもそのままゲームが続いてしまいます。勝利条件が満たされたら勝者を表示するようにしましょう。そのあと、クリックでゲーム状態をリセットして次のゲームを開始できるといいですね。</p>

<p>あ、三目並べの場合は決着が付かずに引き分けになる場合もありますね。この場合もリセットボタンが表示されてほしいですね。</p>

<p>ということで、「ゲームが決着したかを返すメソッド」と「勝者がどちらかを返すメソッド」を作りたいと思います。これはどのクラスに定義することもできますが、いずれも状態から決まる情報なので、Stateクラスに定義するのが良いでしょう。</p>

<p>以下ではそれぞれ<code class="language-plaintext highlighter-rouge">game_over?</code>と<code class="language-plaintext highlighter-rouge">winner</code>という名前でメソッドを定義しています。3つ並びがあるかの判定はいろいろな書き方ができると思いますが、今回はこんな感じにしてみました。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">State</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
    <span class="n">item</span> <span class="ss">:board</span><span class="p">,</span> <span class="ss">default: </span><span class="p">[</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">item</span> <span class="ss">:player</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>

    <span class="c1"># ゲームが終了しているとき真を返す</span>
    <span class="k">def</span> <span class="nf">game_over?</span>
      <span class="c1"># 勝者が決まったらゲーム終了</span>
      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">winner</span> 
      <span class="c1"># 盤面が全部埋まったらゲーム終了</span>
      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">board</span><span class="p">.</span><span class="nf">all?</span><span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="n">row</span><span class="p">.</span><span class="nf">all?</span><span class="p">{</span><span class="o">|</span><span class="n">cell</span><span class="o">|</span> <span class="n">cell</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">}}</span>
      <span class="c1"># それ以外の場合はゲーム中</span>
      <span class="k">return</span> <span class="kp">false</span>
    <span class="k">end</span>

    <span class="c1"># 勝者(0または1)を返す。勝者がいないときはnilを返す</span>
    <span class="k">def</span> <span class="nf">winner</span>
      <span class="c1"># 横一列が作られたかをチェック</span>
      <span class="n">board</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="k">end</span>
      <span class="c1"># 縦一列が作られたかをチェック</span>
      <span class="n">board</span><span class="p">.</span><span class="nf">transpose</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">col</span><span class="o">|</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="o">*</span><span class="n">col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="k">end</span>
      <span class="c1"># 斜めの列が作られたかをチェック</span>
      <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="c1"># 勝者がいない(＝まだ試合が続いているか、引き分けで終わった)</span>
      <span class="k">return</span> <span class="kp">nil</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># a,b,cが等しいときその値を返す</span>
    <span class="k">def</span> <span class="nf">check_winner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">==</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">a</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>これを使って、勝者表示を実装してみましょう。MainComponentのPLAYER表示の下あたりに以下のif式を入れます。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">o</span> <span class="s1">'div#player'</span> <span class="k">do</span>
          <span class="s2">"PLAYER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">player</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">end</span>
        <span class="c1"># 勝者を表示する</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span>
          <span class="n">o</span> <span class="s1">'div#winner'</span> <span class="k">do</span>
            <span class="s2">"WINNER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">winner</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">end</span>
        <span class="k">end</span>
</code></pre></div></div>

<p><img src="../../images/0059-Ovto/board_ooo.png" alt="○の勝利" /></p>

<p>○が横一列に並んだので、「WINNER: ○」と出ていますね。</p>

<h2 id="バグ修正-1">バグ修正</h2>

<p>これだけだとWINNERが出たあともセルをクリックできてしまうので、tdのonclickに「ゲーム終了でない場合」という条件を追加しておきましょう。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="n">o</span> <span class="s1">'td'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">update_cell</span><span class="p">(</span><span class="ss">x: </span><span class="n">x</span><span class="p">,</span> <span class="ss">y: </span><span class="n">y</span><span class="p">)</span> <span class="k">unless</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span> <span class="p">}</span> <span class="k">do</span>
                  <span class="o">...</span>
</code></pre></div></div>

<p>あとはWINNERが決まったのにPLAYER欄が出ているのは変なので、ゲーム終了時は<code class="language-plaintext highlighter-rouge">div#player</code>を描画しないよう、unlessで囲みましょう。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">unless</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span>
          <span class="n">o</span> <span class="s1">'div#player'</span> <span class="k">do</span>
            <span class="s2">"PLAYER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">player</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">end</span>
        <span class="k">end</span>
</code></pre></div></div>

<h3 id="リセットボタンを作る">リセットボタンを作る</h3>

<p>だいぶゲームらしくなってきましたね。最後にリセットボタンを付けて、ゲームが終わったあと次のゲームをプレイできるようにしましょう。</p>

<p>まずはゲームの状態をリセットするアクションが要りそうです。<code class="language-plaintext highlighter-rouge">MyApp::Actions</code>にメソッドを追加しましょう。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># ゲームをリセットする</span>
    <span class="k">def</span> <span class="nf">reset_game</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">new_board</span> <span class="o">=</span>  <span class="p">[</span>
        <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
        <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
        <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">]</span>
      <span class="n">new_player</span> <span class="o">=</span> <span class="k">case</span> <span class="n">state</span><span class="p">.</span><span class="nf">winner</span>
                   <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span>
                   <span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="mi">0</span>
                   <span class="k">else</span> <span class="n">state</span><span class="p">.</span><span class="nf">player</span>
                   <span class="k">end</span>
      <span class="k">return</span> <span class="p">{</span><span class="ss">board: </span><span class="n">new_board</span><span class="p">,</span> <span class="ss">player: </span><span class="n">new_player</span><span class="p">}</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>boardはアプリケーション開始時と同じく、3x3の空の配列にしています。playerは今回のゲームで負けた方を選ぶようにしてみました。</p>

<p>ビューの方は、WINNER表示の下に<code class="language-plaintext highlighter-rouge">a</code>タグを追加して、クリックされたら上のreset_gameアクションを呼ぶようにします。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span>
          <span class="n">o</span> <span class="s1">'div#winner'</span> <span class="k">do</span>
            <span class="s2">"WINNER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">winner</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">end</span>
          <span class="c1"># リセットボタン</span>
          <span class="n">o</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">href: </span><span class="s1">'#'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">{</span> <span class="n">actions</span><span class="p">.</span><span class="nf">reset_game</span> <span class="p">}</span> <span class="k">do</span>
            <span class="s2">"RESET"</span>
          <span class="k">end</span>
        <span class="k">end</span>
</code></pre></div></div>

<p>これでリセットボタンが出るはずです。試しに○を３つ並べてみると…</p>

<p><img src="../../images/0059-Ovto/board_reset.png" alt="RESET" /></p>

<p>うん、大丈夫そうですね。RESETを押すと新しいゲームが始まります。これで、完成です:grin:</p>

<h3 id="完成">完成</h3>

<p>最後に全体像を貼っておきます。ちょうど120行です。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'ovto'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">App</span>
  <span class="k">class</span> <span class="nc">State</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
    <span class="c1"># 盤面データ(0または1またはnil)</span>
    <span class="n">item</span> <span class="ss">:board</span><span class="p">,</span> <span class="ss">default: </span><span class="p">[</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="c1"># 現在のプレイヤー(0または1)</span>
    <span class="n">item</span> <span class="ss">:player</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>

    <span class="c1"># ゲームが終了しているとき真を返す</span>
    <span class="k">def</span> <span class="nf">game_over?</span>
      <span class="c1"># 勝者が決まったらゲーム終了</span>
      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">winner</span> 
      <span class="c1"># 盤面が全部埋まったらゲーム終了</span>
      <span class="k">return</span> <span class="kp">true</span> <span class="k">if</span> <span class="n">board</span><span class="p">.</span><span class="nf">all?</span><span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="n">row</span><span class="p">.</span><span class="nf">all?</span><span class="p">{</span><span class="o">|</span><span class="n">cell</span><span class="o">|</span> <span class="n">cell</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">}}</span>
      <span class="c1"># それ以外の場合はゲーム中</span>
      <span class="k">return</span> <span class="kp">false</span>
    <span class="k">end</span>

    <span class="c1"># 勝者(0または1)を返す。勝者がいないときはnilを返す</span>
    <span class="k">def</span> <span class="nf">winner</span>
      <span class="c1"># 横一列が作られたかをチェック</span>
      <span class="n">board</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="k">end</span>
      <span class="c1"># 縦一列が作られたかをチェック</span>
      <span class="n">board</span><span class="p">.</span><span class="nf">transpose</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">col</span><span class="o">|</span>
        <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="o">*</span><span class="n">col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="k">end</span>
      <span class="c1"># 斜めの列が作られたかをチェック</span>
      <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="n">winner</span> <span class="o">=</span> <span class="n">check_winner</span><span class="p">(</span><span class="n">board</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">board</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">winner</span> <span class="k">if</span> <span class="n">winner</span>
      <span class="c1"># 勝者がいない(＝まだ試合が続いているか、引き分けで終わった)</span>
      <span class="k">return</span> <span class="kp">nil</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># a,b,cが等しいときその値を返す</span>
    <span class="k">def</span> <span class="nf">check_winner</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">==</span> <span class="n">c</span>
        <span class="k">return</span> <span class="n">a</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Actions</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Actions</span>
    <span class="k">def</span> <span class="nf">update_cell</span><span class="p">(</span><span class="n">state</span><span class="p">:,</span> <span class="n">x</span><span class="p">:,</span> <span class="n">y</span><span class="p">:)</span>
      <span class="c1"># そこには置けない</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="kp">nil</span>
      <span class="c1"># 新しい盤面を作る</span>
      <span class="n">new_board</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="n">row</span><span class="p">.</span><span class="nf">dup</span><span class="p">}</span>
      <span class="n">new_board</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="nf">player</span>
      <span class="c1"># 新しいプレイヤーは、現在と逆のプレイヤー(0なら1、1なら0)</span>
      <span class="n">new_player</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">state</span><span class="p">.</span><span class="nf">player</span>
      <span class="k">return</span> <span class="p">{</span><span class="ss">board: </span><span class="n">new_board</span><span class="p">,</span> <span class="ss">player: </span><span class="n">new_player</span><span class="p">}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">reset_game</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">new_board</span> <span class="o">=</span>  <span class="p">[</span>
        <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
        <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
        <span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">],</span>
      <span class="p">]</span>
      <span class="n">new_player</span> <span class="o">=</span> <span class="k">case</span> <span class="n">state</span><span class="p">.</span><span class="nf">winner</span>
                   <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span>
                   <span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="mi">0</span>
                   <span class="k">else</span> <span class="n">state</span><span class="p">.</span><span class="nf">player</span>
                   <span class="k">end</span>
      <span class="k">return</span> <span class="p">{</span><span class="ss">board: </span><span class="n">new_board</span><span class="p">,</span> <span class="ss">player: </span><span class="n">new_player</span><span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">MainComponent</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="no">PLAYER_MARK</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span> <span class="o">=&gt;</span> <span class="s1">'○'</span><span class="p">,</span> <span class="mi">1</span> <span class="o">=&gt;</span> <span class="s1">'×'</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">o</span> <span class="s1">'div'</span> <span class="k">do</span>
        <span class="k">unless</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span>
          <span class="n">o</span> <span class="s1">'div#player'</span> <span class="k">do</span>
            <span class="s2">"PLAYER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">player</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">end</span>
        <span class="k">end</span>
        <span class="c1"># 勝者を表示する</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span>
          <span class="n">o</span> <span class="s1">'div#winner'</span> <span class="k">do</span>
            <span class="s2">"WINNER: </span><span class="si">#{</span><span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="nf">winner</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">end</span>
          <span class="c1"># リセットボタン</span>
          <span class="n">o</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">href: </span><span class="s1">'#'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">{</span> <span class="n">actions</span><span class="p">.</span><span class="nf">reset_game</span> <span class="p">}</span> <span class="k">do</span>
            <span class="s2">"RESET"</span>
          <span class="k">end</span>
        <span class="k">end</span>
        <span class="n">o</span> <span class="s1">'table#board'</span> <span class="k">do</span>
          <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">.</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span>
            <span class="n">o</span> <span class="s1">'tr'</span> <span class="k">do</span>
              <span class="n">row</span><span class="p">.</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">cell</span><span class="p">,</span> <span class="n">x</span><span class="o">|</span>
                <span class="n">o</span> <span class="s1">'td'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">update_cell</span><span class="p">(</span><span class="ss">x: </span><span class="n">x</span><span class="p">,</span> <span class="ss">y: </span><span class="n">y</span><span class="p">)</span> <span class="k">unless</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span> <span class="p">}</span> <span class="k">do</span>
                  <span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
                <span class="k">end</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">MyApp</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="ss">id: </span><span class="s1">'ovto'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="より大きなアプリを作るには">より大きなアプリを作るには</h2>

<p>最後にOvtoアプリの拡張方法について説明しておきます。今回の三目並べは120行でできましたが、もっと大きなものを作ろうとすると、Stateクラスの要素が増えたり、Actionsクラスのメソッドが増えたり、MainComponent#renderが長くなったりして大変になると思います。</p>

<p>でも大丈夫、Ovtoではそれぞれについて対処法を考えてあります。</p>

<h3 id="stateの拡張">Stateの拡張</h3>

<p>Stateについては「Stateを入れ子にする」という方法があります。例えば三目並べの例であれば、盤面に関する部分だけを独立したクラスBoardにするのが良いでしょう。まず以下のようにして<code class="language-plaintext highlighter-rouge">Ovto::State</code>を継承したクラスBoardを作ります。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">Board</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
    <span class="n">item</span> <span class="ss">:cells</span><span class="p">,</span> <span class="ss">default: </span><span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">3</span><span class="p">){</span> <span class="no">Array</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">3</span><span class="p">){</span> <span class="kp">nil</span> <span class="p">}}</span>
    <span class="o">...</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>次に<code class="language-plaintext highlighter-rouge">MyApp::State</code>が要素としてBoardオブジェクトを持つようにします。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">State</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">State</span>
    <span class="c1"># 盤面データ(0または1またはnil)</span>
    <span class="n">item</span> <span class="ss">:board</span><span class="p">,</span> <span class="ss">default: </span><span class="no">Board</span><span class="p">.</span><span class="nf">new</span>
    <span class="c1"># 現在のプレイヤー(0または1)</span>
    <span class="n">item</span> <span class="ss">:player</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>これでだいぶすっきりするはずです。Boardクラスはboard.rbなど別のファイルに切り出すのも良いでしょう。opalコマンドでコンパイルする場合は<code class="language-plaintext highlighter-rouge">-I .</code>オプションを付ければ、<code class="language-plaintext highlighter-rouge">require "board"</code>で読み込むことができます。</p>

<h3 id="actionsの拡張">Actionsの拡張</h3>

<p>Actionsのメソッドが増えてきた場合は、<code class="language-plaintext highlighter-rouge">module</code>を使って分割するのが良いでしょう。普通のRubyクラスを整理する手順と同じです。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">module</span> <span class="nn">XxxActions</span> 
    <span class="o">...</span>
  <span class="k">end</span>
  <span class="k">module</span> <span class="nn">YyyActions</span>
    <span class="o">...</span>
  <span class="k">end</span>
  <span class="k">class</span> <span class="nc">Actions</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Actions</span>
    <span class="kp">include</span> <span class="no">XxxActions</span>
    <span class="kp">include</span> <span class="no">YyyActions</span>
  <span class="k">end</span>
</code></pre></div></div>

<h3 id="maincomponentの拡張">MainComponentの拡張</h3>

<p>MainComponent#renderが長くなった場合は、サブのComponentを定義するのが良いです。例えば三目並べの盤面部分をサブComponentにしてみると、以下のようになります。<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">Board</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:)</span>
      <span class="n">o</span> <span class="s1">'table#board'</span> <span class="k">do</span>
        <span class="n">state</span><span class="p">.</span><span class="nf">board</span><span class="p">.</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="p">,</span> <span class="n">y</span><span class="o">|</span>
          <span class="n">o</span> <span class="s1">'tr'</span> <span class="k">do</span>
            <span class="n">row</span><span class="p">.</span><span class="nf">each</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">cell</span><span class="p">,</span> <span class="n">x</span><span class="o">|</span>
              <span class="n">o</span> <span class="s1">'td'</span><span class="p">,</span> <span class="ss">onclick: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">actions</span><span class="p">.</span><span class="nf">update_cell</span><span class="p">(</span><span class="ss">x: </span><span class="n">x</span><span class="p">,</span> <span class="ss">y: </span><span class="n">y</span><span class="p">)</span> <span class="k">unless</span> <span class="n">state</span><span class="p">.</span><span class="nf">game_over?</span> <span class="p">}</span> <span class="k">do</span>
                <span class="no">PLAYER_MARK</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
              <span class="k">end</span>
            <span class="k">end</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>MainComponentではoメソッドのタグ名にクラスを指定することで、サブComponentをレンダリングできます。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">o</span> <span class="no">Board</span>
</code></pre></div></div>

<p>サブComponentのレンダリング時に引数を渡すこともできます。例えば盤面の色を指定できるようにするとしたら、こんな感じでしょうか。</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">Board</span> <span class="o">&lt;</span> <span class="no">Ovto</span><span class="o">::</span><span class="no">Component</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">state</span><span class="p">:,</span> <span class="n">color</span><span class="p">:)</span>
      <span class="o">...</span>
    <span class="k">end</span>
  <span class="k">end</span>

    <span class="o">...</span>
        <span class="n">o</span> <span class="no">Board</span><span class="p">,</span> <span class="ss">color: </span><span class="s2">"red"</span>
</code></pre></div></div>

<p>サブComponentもそれぞれ別のファイルに分けて、本体からrequireするようにするとより良いでしょう。</p>

<p>Ovtoアプリの分割については、以下に実際のアプリケーションでの例があるので参考にしてください。</p>

<ul>
  <li><a href="https://github.com/yhara/vision/tree/v0.4.1/app/assets/javascripts/ovto_app">https://github.com/yhara/vision/tree/v0.4.1/app/assets/javascripts/ovto_app</a></li>
</ul>

<h2 id="おわりに">おわりに</h2>

<p>今回は「Rubyistのためのフロントエンドフレームワーク」Ovtoについて紹介しました。Ovtoの楽しさが伝われば嬉しいです。</p>

<h2 id="関連リンク">関連リンク</h2>

<dl>
  <dt>Ovto公式サイト</dt>
  <dd><a href="https://yhara.github.io/ovto/">https://yhara.github.io/ovto/</a></dd>
  <dt>Ovtoソースコード(github)</dt>
  <dd><a href="https://github.com/yhara/ovto/">https://github.com/yhara/ovto/</a></dd>
  <dt>Opalアドベントカレンダー</dt>
  <dd><a href="https://qiita.com/advent-calendar/2018/opal">https://qiita.com/advent-calendar/2018/opal</a></dd>
</dl>

<h2 id="著者について">著者について</h2>

<p>yhara (原 悠) twitter: <a href="https://twitter.com/yhara/">@yhara</a> blog: <a href="https://yhara.jp/">yhara.jp</a></p>

<p>Ruby歴18年。↑のブログも<a href="https://github.com/yhara/nlog2">Rubyで作っています</a>。</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>キーワード引数の初期値を省略した場合は「必須キーワード引数」という扱いになり、メソッド呼び出し時にこのキーワードを指定し忘れていないかチェックしてくれるようになります。フロントエンドのコードは頻繁に書き換えが起こるので、引数名を変えたりしたときに変更漏れがすぐ分かるように、キーワード引数を使うよう設計しました。 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>注意深い読者なら、呼び出し側に<code class="language-plaintext highlighter-rouge">state:</code>がないのが気になったかもしれません。実は<code class="language-plaintext highlighter-rouge">actions</code>が返すのは<code class="language-plaintext highlighter-rouge">MyApp::Actions</code>のインスタンスではなく、<code class="language-plaintext highlighter-rouge">Ovto::WiredActions</code>というクラスのインスタンスです。WiredActionsはアクション実行後のstate更新や画面の再描画などの処理を担当します。現在のstateをActionsのメソッドに渡すのもWiredActionsの仕事です。stateを手で渡してしまうと複数のアクションが同時に実行されたときに値がおかしくなる可能性があるので、WiredActionsの方で自動的に現在のstateを渡すようになっています。 <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>StateのところでBoardというクラスを作った場合は名前が被ってしまうので、別のクラス名をつけるか、<code class="language-plaintext highlighter-rouge">MyApp::State::Board</code>と<code class="language-plaintext highlighter-rouge">MyApp::MainComponent::Board</code>みたいにネストした名前空間に定義するのが良いでしょう。 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
