<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ruby コードの感想戦 【第 1 回】 WikiR</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0040/0040-CodePostMortem.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    <li><a href="../../articles/backnumber/backnumber.html">記事単位</a></li>
    <hr>
    
        <li><a href="../../articles/prerubykaigi2020/preRubyKaigi2020-index.html">RubyKaigi Takeout 2020 特集号</a></li>
    
        <li><a href="../../articles/0061/0061-index.html">0061号(2020-02)</a></li>
    
        <li><a href="../../articles/0060/0060-index.html">0060号(2019-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2019/preRubyKaigi2019-index.html">RubyKaigi 2019 直前特集号</a></li>
    
        <li><a href="../../articles/0059/0059-index.html">0059号(2019-01)</a></li>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Ruby コードの感想戦 【第 1 回】 WikiR</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=Ruby コードの感想戦 【第 1 回】 WikiR&amp;url=https://magazine.rubyist.net/articles/0040/0040-CodePostMortem.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0040/0040-CodePostMortem.html&amp;t=Ruby コードの感想戦 【第 1 回】 WikiR" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0040/0040-CodePostMortem.html&amp;Ruby コードの感想戦 【第 1 回】 WikiR" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            

  <span class="created_on">初稿：2012-11-25</span>



                        </div>
                        
<ul id="markdown-toc">
  <li><a href="#ruby-コードの感想戦-第-1-回-wikir" id="markdown-toc-ruby-コードの感想戦-第-1-回-wikir">Ruby コードの感想戦 【第 1 回】 WikiR</a>    <ul>
      <li><a href="#まず動かす" id="markdown-toc-まず動かす">まず、動かす</a></li>
      <li><a href="#コードを見る" id="markdown-toc-コードを見る">コードを見る</a>        <ul>
          <li><a href="#wikirrb" id="markdown-toc-wikirrb">wikir.rb</a>            <ul>
              <li><a href="#マジックコメント" id="markdown-toc-マジックコメント">マジックコメント</a></li>
              <li><a href="#ライブラリ読み込み" id="markdown-toc-ライブラリ読み込み">ライブラリ読み込み</a></li>
              <li><a href="#wikirbook" id="markdown-toc-wikirbook">WikiR::Book</a></li>
              <li><a href="#wikirpage" id="markdown-toc-wikirpage">WikiR::Page</a></li>
              <li><a href="#wikirui" id="markdown-toc-wikirui">WikiR::UI</a></li>
            </ul>
          </li>
          <li><a href="#indexrb" id="markdown-toc-indexrb">index.rb</a></li>
        </ul>
      </li>
      <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
      <li><a href="#著者紹介" id="markdown-toc-著者紹介">著者紹介</a></li>
    </ul>
  </li>
  <li><a href="#ruby-コードの感想戦-連載一覧" id="markdown-toc-ruby-コードの感想戦-連載一覧">Ruby コードの感想戦 連載一覧</a></li>
</ul>

<p>書いた人: 須藤 功平 (<a href="https://github.com/kou">@kou</a>)</p>

<h2 id="ruby-コードの感想戦-第-1-回-wikir">Ruby コードの感想戦 【第 1 回】 WikiR</h2>

<figure class="highlight"><pre><code class="language-text" data-lang="text">感想戦（かんそうせん）とは、囲碁、将棋、チェス、麻雀などのゲームにおいて、対局後に開始から終局まで、またはその一部を再現し、
対局中の着手の善悪や、その局面における最善手などを検討することである。 (Wikipedia 「感想戦」より)</code></pre></figure>

<p>るびまには「よい Ruby コードのお手本を示す」というスタイルの青木峰郎さんの「<a href="../../articles/0010/0010-CodeReview.html">あなたの Ruby コードを添削します</a>」という名連載がありました。</p>

<p>新しく始まるこの連載もコード添削をテーマにした連載です。青木さんの連載との違いは、「よい Ruby コードのお手本を示す」、「Ruby で書くよいコードのベストプラクティスを提供する」というのではなく、「よいコードにも視点の違いによって多様性があり、それぞれの視点を読んだうえで記事を読む人に自分はどう考えるかを考えてもらう」というスタイルをとる点です。結果として、読んだ人が自分のコードを書くときに、視点がひとつ、ふたつ増えているということを期待しています。</p>

<p>この連載では、「ある人がコードにコメントし、そのコメントに対してまた別の人がコメントする」という記事がセットで進んでいきます。コメントする人は特定の誰かではなく、毎回変わっていきます。先生と生徒の関係ではなく、コメントする人、される人、どちらもコードに一家言持ったプログラマです。きっと、いろいろな視点を見つけられるはずです。</p>

<p>第 1 回目は<a href="../../articles/0013/0013-Hotlinks.html">咳さん</a>の書いたコードに対して私（須藤）がコメントします。題材は以下の URL にある小さな Wiki です。</p>

<p><a href="http://d.hatena.ne.jp/m_seki/20120213#1329064281">http://d.hatena.ne.jp/m_seki/20120213#1329064281</a></p>

<p>私が咳さんのコードに最初に触れたのはたぶん <a href="http://pub.cozmixng.org/~the-rwiki/rw-cgi.rb?cmd=view;name=top">RWiki</a> です。RWiki は咳さんが書いた Wiki です。私も RWiki をいじっていた時期がありましたが、それは咳さんがほとんどいじらなくなってからです。私が咳さんのコードをいじるのは 5 年以上ぶりです。</p>

<h3 id="まず動かす">まず、動かす</h3>

<p>単に他の人のコードにコメントするだけであれば、コードを読んで気になるところにコメントするだけでもよいのですが、自分がちゃんと関わる気のあるコードならまずは動かしましょう。今回はちゃんと関わる気はないのですが、ちゃんと読む気はあるので動かします。</p>

<p>WikiR は dRuby サーバーと dRuby サーバーに接続する CGI で構成されています。これは、咳プロダクツではよくあるパターンです。咳フリークならみんな知っています。</p>

<p>まずは dRuby サーバーを動かします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> % ruby wikir.rb</code></pre></figure>

<p>次に CGI を動かします。CGI を動かすためには HTTP サーバーが必要なので、まずは HTTP サーバーを作りましょう。</p>

<p>httpd.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> #!/usr/bin/env ruby

 require "webrick"
 require "webrick/httpservlet/cgihandler"

 server = WEBrick::HTTPServer.new(:Port =&gt; 8080)
 cgi_script = File.expand_path("index.rb", File.dirname(__FILE__))
 server.mount("/", WEBrick::HTTPServlet::CGIHandler, cgi_script)
 trap(:INT) do
   server.shutdown
 end
 server.start</code></pre></figure>

<p>HTTP サーバーを動かします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> % ruby httpd.rb
 [2012-10-09 21:57:22] INFO  WEBrick 1.3.1
 [2012-10-09 21:57:22] INFO  ruby 1.9.3 (2012-04-20) [x86_64-linux]
 [2012-10-09 21:57:22] INFO  WEBrick::HTTPServer#start: pid=14901 port=8080</code></pre></figure>

<p>localhost の 8080 番ポートで HTTP サーバーが起動しました。それでは、Web ブラウザーでアクセスしましょう。
<img src="../../images/0040-CodePostMortem/cgi-fail.png" alt="cgi-fail.png" /></p>

<p>CGI の実行に失敗しました。うまくいかないときはまずはログを確認します<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>。HTTP サーバーのログを確認すると以下のようになっています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [2012-10-09 22:01:25] ERROR CGIHandler: /home/kou/work/ruby/rubima-correction-wikir/index.rb:
 /usr/lib/ruby/1.9.1/webrick/httpservlet/cgi_runner.rb:46:in `exec': No such file or directory - /home/kou/work/ruby/rubima-correction-wikir/index.rb (Errno::ENOENT)
         from /usr/lib/ruby/1.9.1/webrick/httpservlet/cgi_runner.rb:46:in `&lt;main&gt;'
 [2012-10-09 22:01:25] ERROR CGIHandler: /home/kou/work/ruby/rubima-correction-wikir/index.rb exit with 1
 [2012-10-09 22:01:25] ERROR Premature end of script headers: /home/kou/work/ruby/rubima-correction-wikir/index.rb
 localhost - - [09/Oct/2012:22:01:25 JST] "GET / HTTP/1.1" 500 365
 - -&gt; /</code></pre></figure>

<p>ファイルが存在しているのにファイルの実行時に「No such file or directory」とでるときは shebang<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote">2</a></sup> がおかしいと相場が決まっています。index.rb を見てみましょう。</p>

<p>index.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> #!/usr/local/bin/ruby
 require 'drb/drb'

 DRb.start_service('druby://localhost:0')
 ro = DRbObject.new_with_uri('druby://localhost:50830')
 ro.start(ENV.to_hash, $stdin, $stdout)</code></pre></figure>

<p>私の環境では ruby コマンドは <em>/usr/bin/ruby</em> なので <em>/usr/local/bin/ruby</em> から <em>/usr/bin/ruby</em> に変更します <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote">3</a></sup>。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit f9fdacafc7dbe57a537f09a013193f6fe257b454 (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Tue Oct 9 22:06:59 2012 +0900

     Adjust shebang

     Ruby command exists at /usr/bin/ruby instead of /usr/local/bin/ruby on
     Debian GNU/Linux.
 ---
  index.rb |    2 +-
  1 file changed, 1 insertion(+), 1 deletion(-)

 diff --git a/index.rb b/index.rb
 index 22d10cd..1b146a6 100755
 --- a/index.rb
 +++ b/index.rb
 @@ -1,4 +1,4 @@
 -#!/usr/local/bin/ruby
 +#!/usr/bin/ruby
  require 'drb/drb'

  DRb.start_service('druby://localhost:0')</code></pre></figure>

<p>ふたたび Web ブラウザーでアクセスすると今度はトップページが表示されます。
<img src="../../images/0040-CodePostMortem/cgi-work.png" alt="cgi-work.png" /></p>

<p>これでスタート地点に立てました。それでは、コードを見ていきましょう。</p>

<h3 id="コードを見る">コードを見る</h3>

<p>私がコードを読むときは 2 つのモードがあります。1 つが「なんとなく読む」モードで、もう 1 つが「必要だから読む」モードです。「なんとなく読む」モードのときは上から順に読んでいって、なにか気になったらコメントしたり直したり無視したりします。読むというより眺めるに近いかもしれません<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote">4</a></sup>。「必要だから読む」モードのときは、まず必要なところを探して、見つけたらそこだけを集中して読んで他のところには目もくれずに必要なことだけ調べます。</p>

<p>「なんとなく読む」モードはコミットメール<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote">5</a></sup>を読む時のモードです。「必要だから読む」モードは機能を追加する時やデバッグする時や実装を調べる時のモードです。</p>

<p>今回は機能追加などではなく、気になったことにコメントするために読むので「なんとなく読む」モードです。</p>

<p>WikiR は index.rb と wikir.rb の 2 つのファイルで構成されています。まずは、本体である wikir.rb の方から見ていきましょう。</p>

<h4 id="wikirrb">wikir.rb</h4>

<h5 id="マジックコメント">マジックコメント</h5>

<p>はじめにファイル内で使うエンコーディングを指定するコメントがあります。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 1 # -*- coding: utf-8 -*-</code></pre></figure>

<p>これはマジックコメントと呼ばれています。マジックコメントには以下のようにいくつかの書き方があります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> # -*- coding: エンコーディング名 -*-
 # -*- encoding: エンコーディング名 -*-
 # coding: エンコーディング名
 # coding = エンコーディング名
 # encoding: エンコーディング名
 # encoding = エンコーディング名
 # ...</code></pre></figure>

<p>たくさんあるとどの書き方がよいか悩むかもしれませんが、wikir.rb と同じく以下の書き方にしましょう<sup id="fnref:6" role="doc-noteref"><a href="#fn:6" class="footnote">6</a></sup>。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> # -*- coding: エンコーディング名 -*-</code></pre></figure>

<p>この形式は Ruby だけではなく GNU Emacs も認識できる形式です。GNU Emacs がエンコーディングを認識すると、保存するときに指定したエンコーディングに変換してくれます。そのため、マジックコメントで指定したエンコーディングと実際のエンコーディングが異なることがありません。なお、ruby-mode<sup id="fnref:7" role="doc-noteref"><a href="#fn:7" class="footnote">7</a></sup>を使っていると ASCII 範囲外の文字列があれば自動でマジックコメントが挿入されるので、意識せずにマジックコメントを指定していることでしょう。</p>

<h5 id="ライブラリ読み込み">ライブラリ読み込み</h5>

<p>次にライブラリを読み込んでいます。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 2 require 'kramdown'
 3 require 'webrick'
 4 require 'webrick/cgi'
 5 require 'drb/drb'
 6 require 'erb'
 7 require 'monitor'</code></pre></figure>

<p>特に気になるところはありません。</p>

<h5 id="wikirbook">WikiR::Book</h5>

<p>いよいよクラス定義です。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  9 class WikiR
 10   class Book
 11     include MonitorMixin
 12     def initialize
 13       super()
 14       @page = {}
 15     end
 16
 17     def [](name)
 18       @page[name] || Page.new(name)
 19     end
 20
 21     def []=(name, src)
 22       synchronize do
 23         page = self[name]
 24         @page[name] = page
 25         page.set_src(src)
 26       end
 27     end
 28   end</code></pre></figure>

<p>まずは <em>WikiR::Book</em> です。これは複数のページを管理するクラスですね。咳さんはページを管理するクラスには「本」という名前をつけます。RWiki の時もそうでした。</p>

<p>ページを管理するクラスには他にも違う名前が考えられます。例えば「Wiki」という名前です。ページを全部集めたものが Wiki だと考えれば適切な名前です。あるいは、「データベース」という名前です。ページが保存されている感じがします。「本」や「Wiki」ではどのように保存するかは気になりませんが、データベースという名前を使うとどのようにページを保存するかを意識している感じがしますね。</p>

<p>咳さんは何かに例えた名前をつけます。作っているものは Wiki ですが、「ページが集まっているものと言えば本だよね」という連想をして「本」という名前をつけたのでしょう。このように何かに例えた名前をつけると愛着がわき、例えたものベースで説明するようになります。例えば、「ページの数が増えてきて処理に時間がかかるようになったね」というのではなく、「本が厚くなって重くなったね」というような感じです。自分が書いたソフトウェアに愛着がわくので一度は試してみるとよいでしょう<sup id="fnref:8" role="doc-noteref"><a href="#fn:8" class="footnote">8</a></sup>。</p>

<p>さて、それではコードの中を見てみましょう。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 11 include MonitorMixin
 12 def initialize
 13   super()
 14   @page = {}
 15 end</code></pre></figure>

<p><em>MonitorMixin</em> を使っています。咳さんが使っているのをよく見ます。</p>

<p>これはマルチスレッド対応なクラスを作る時に便利なモジュールです。このモジュールは <em>synchronize</em> メソッドを提供します。同時に複数のスレッドからアクセスされそうなコードを <em>synchronize</em> メソッドのブロック内で呼び出すことで、競合を防ぐことができます。例えば、以下のコードは <em>Counter#up</em> を複数のスレッドから同時に呼び出すと正しくカウントアップできません。</p>

<p>thread-unsafe-counter.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Counter
   attr_reader :count
   def initialize
     @count = 0
   end

   def up
     count = @count
     sleep(0.00000001)
     @count = count + 1
   end
 end

 counter = Counter.new

 threads = []
 100.times do
   threads &lt;&lt; Thread.new do
     100.times do
       counter.up
     end
   end
 end
 threads.each(&amp;:join)

 p counter.count # =&gt; 10000にならない！</code></pre></figure>

<p>これを <em>MonitorMixin</em> を使ってマルチスレッドでも正しくカウントアップできるようにすると以下のようになります。</p>

<p>thread-safe-counter-mixin.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require "monitor"

 class Counter
   include MonitorMixin

   attr_reader :count
   def initialize
     super()
     @count = 0
   end

   def up
     synchronize do
       count = @count
       sleep(0.00000001)
       @count = count + 1
     end
   end
 end

 counter = Counter.new

 threads = []
 100.times do
   threads &lt;&lt; Thread.new do
     100.times do
       counter.up
     end
   end
 end
 threads.each(&amp;:join)

 p counter.count # =&gt; 10000になる！</code></pre></figure>

<p>違いは以下の通りです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> % diff -u thread-unsafe-counter.rb thread-safe-counter-mixin.rb
 --- thread-unsafe-counter.rb	2012-10-15 00:04:45.476261676 +0900
 +++ thread-safe-counter-mixin.rb	2012-10-15 00:04:34.440532956 +0900
 @@ -1,13 +1,20 @@
 +require "monitor"
 +
  class Counter
 +  include MonitorMixin
 +
    attr_reader :count
    def initialize
 +    super()
      @count = 0
    end

    def up
 -    count = @count
 -    sleep(0.00000001)
 -    @count = count + 1
 +    synchronize do
 +      count = @count
 +      sleep(0.00000001)
 +      @count = count + 1
 +    end
    end
  end</code></pre></figure>

<p><em>MonitorMixin</em> を <em>include</em> して、<em>initialize</em> で <em>super()</em> して、<em>up</em> の中の処理を <em>synchronize do … end</em> しています。これは dRuby を使ったプログラムでよく見る処理です。</p>

<p>と、<em>MonitorMixin</em> の説明をしてきましたが、私は <em>MonitorMixin</em> が好きではありません。<em>initialize</em> で <em>super()</em> するのがカッコ悪いなぁと思います。継承したときに <em>initialize</em> で <em>super()</em> するのは親クラスも初期化しないといけないからだろうなぁとは思います。クラスをインスタンス化するときに <em>initialize</em> が呼ばれるというルールがあるからです。しかし、モジュールは <em>initialize</em> が呼ばれるというルールはありません。それなのに <em>super</em> を呼ばなければいけないのがカッコ悪いなぁと思う理由な気がします。</p>

<p>なお、Ruby 2.0 では <em>Module#prepend</em> があるので、以下のようにすればクラス側で明示的に <em>super</em> を呼ばなくてもすみます。</p>

<p>module-prepend.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> # -*- coding: utf-8 -*-

 module MonitorMixin
   def initialize
     p :monitor_mixin
     super # これは必要。これがないと:bookが出力されない
   end
 end

 class Book
   prepend MonitorMixin
   def initialize
     p :book
   end
 end

 Book.new # =&gt; :monitor_mixin
          #    :book</code></pre></figure>

<p>話が逸れましたが、<em>super()</em> を呼ばなければいけないなら <em>@monitor = Monitor.new</em> して <em>@monitor.synchronize</em> とする方が好きです。こっちの方が役割が分離されていてわかりやすいからです。</p>

<p>thread-safe-counter-composite.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require "monitor"

 class Counter
   attr_reader :count
   def initialize
     @count = 0
     @monitor = Monitor.new
   end

   def up
     @monitor.synchronize do
       count = @count
       sleep(0.00000001)
       @count = count + 1
     end
   end
 end</code></pre></figure>

<p>ということで、<em>WikiR::Book</em> も <em>MonitorMixin</em> ではなく <em>Monitor</em> を使うようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit 96488c8ee5e0158c3dc67bc280c76f8a60e78ae9 (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Mon Oct 15 00:24:45 2012 +0900

     Use Monitor instead of MonitorMixin

     Monitor is readable rather than MonitorMixin.
 ---
  wikir.rb |    5 ++---
  1 file changed, 2 insertions(+), 3 deletions(-)

 diff --git a/wikir.rb b/wikir.rb
 index 2c73014..72c5a58 100644
 --- a/wikir.rb
 +++ b/wikir.rb
 @@ -8,9 +8,8 @@ require 'monitor'

  class WikiR
    class Book
 -    include MonitorMixin
      def initialize
 -      super()
 +      @monitor = Monitor.new
        @page = {}
      end

 @@ -19,7 +18,7 @@ class WikiR
      end

      def []=(name, src)
 -      synchronize do
 +      @monitor.synchronize do
          page = self[name]
          @page[name] = page
          page.set_src(src)</code></pre></figure>

<p>私は、以下のようなときは「こうした方がいいんじゃない？」と日本語でコメントするのではなくて、直接コミットしてコミットメッセージに「どうしてこうした方がいいと思うか」を書きます。</p>

<ul>
  <li>自分がコミット権を持っている</li>
  <li>コミットした人が他の人のコミットも見ていそう</li>
  <li>自分でコミットするのが面倒くさくない</li>
  <li>日本語じゃなくてもコードで伝わりそう</li>
  <li>日本語でも通じなさそう</li>
</ul>

<p>直接コミットすると、そのコミットには以下の情報が含まれます。</p>

<ul>
  <li>どう直したかのサマリー（Use Monitor instead of MonitorMixin）</li>
  <li>どうしてこう直したかという理由（Monitor is readable rather than MonitorMixin.）</li>
  <li>どう直したか（変更点そのもの。diff）</li>
</ul>

<p>私は、こっちのコードの方がいいんじゃないかということを伝える時には「どうしてそう思うか」という理由も伝えたいなぁと思っています。理由も伝えれば同じパターン<sup id="fnref:9" role="doc-noteref"><a href="#fn:9" class="footnote">9</a></sup>の別のケースの時にも使える知識になってくれるのではないかと期待しているからです。そして、上述のようにコミットすることにより私が伝えたい内容を全部含んだ状態で伝えられるのではないかと思っています。ただ、これが本当に効果がある方法なのかどうかはまだわかっていません。</p>

<p>それでは、コードの続きを見ていきましょう。</p>

<p>もう忘れているかもしれませんが、<em>initialize</em> を見ていました。今の <em>initialize</em> は以下のようになっています。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 11 def initialize
 12   @monitor = Monitor.new
 13   @page = {}
 14 end</code></pre></figure>

<p>次に気になるのが <em>@page</em> というインスタンス変数名です。このインスタンス変数は複数のページを扱っているので複数形にしましょう。複数形にすることで、このインスタンス変数には複数の値が入っていることがわかりやすくなります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit 8c2c555dc29c1538ffcfde0a71e30bd4b9bbc11a (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Mon Oct 15 21:59:00 2012 +0900

     Use plural form for collection

     @page -&gt;
     @pages

     Plural form is suitable for collection.
 ---
  wikir.rb |    6 +++---
  1 file changed, 3 insertions(+), 3 deletions(-)

 diff --git a/wikir.rb b/wikir.rb
 index 72c5a58..c51e312 100644
 --- a/wikir.rb
 +++ b/wikir.rb
 @@ -10,17 +10,17 @@ class WikiR
    class Book
      def initialize
        @monitor = Monitor.new
 -      @page = {}
 +      @pages = {}
      end

      def [](name)
 -      @page[name] || Page.new(name)
 +      @pages[name] || Page.new(name)
      end

      def []=(name, src)
        @monitor.synchronize do
          page = self[name]
 -        @page[name] = page
 +        @pages[name] = page
          page.set_src(src)
        end
      end</code></pre></figure>

<p>名前を変える変更をするときのコミットメッセージには、以下のようにどのように変更したかを書きます。ポイントは縦に並べてどこが変わったかをわかりやすくすることです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> @page -&gt;
 @pages</code></pre></figure>

<p>以下のように書く方法もありますが、縦に並べたほうが違いがわかりやすいのでそうしています。なお、縦に並べて違いをわかりやすくするという方法はテスティングフレームワークの失敗時の出力でも使われています。test-unit なら <em>assert_equal</em> が失敗した時の出力、RSpec なら <em>should ==</em> が失敗した時の出力を確認しなおしてみてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> @page -&gt; @pages
 Rename @page to @pages.</code></pre></figure>

<p><em>WikiR::Book</em> にはもうひとつ気になるところがありますが、それは後で触れることにします。次のクラスへ進みましょう。</p>

<h5 id="wikirpage">WikiR::Page</h5>

<p>次のクラスは <em>WikiR::Page</em> です。<em>WikiR::Page</em> も小さなクラスです。咳さんのコードに出てくるクラスは小さいことが多いです。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 29 class Page
 30   def initialize(name)
 31     @name = name
 32     set_src("# #{name}\n\nan empty page. edit me.")
 33   end
 34   attr_reader :name, :src, :html, :warnings
 35
 36   def set_src(text)
 37     @src = text
 38     km = Kramdown::Document.new(text)
 39     @html = km.to_html
 40     @warnings = km.warnings
 41   end
 42 end</code></pre></figure>

<p>RWiki の時もそうでしたが、咳さんは <em>set_src</em> という名前を使います。<em>src=</em> の方が Ruby らしいのに、です。たぶん、「<em>src=</em> だと単純に値を設定するだけ」というイメージがあるけど、実際は「ソースを設定した後に HTML に変換するというようにたくさんやっている」から <em>set_src</em> という別の名前にしているんじゃないかと思います。で、私はこの名前が好きではありません。</p>

<p><em>src=</em> でいいんじゃないかと思います。もし、HTML に変換するコストが大きいと感じるようであれば、本当に HTML が必要になるまで HTML への変換処理を遅延すればよいでしょう。例えば以下のようにです。ただ、このプログラムではそこまでする必要はないと思っています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> def src=(text)
   @dirty = true
   @src = text
 end

 def html
   parse if @dirty
   @html
 end

 def warnings
   parse if @dirty
   @warnings
 end

 private
 def parse
   km = Kramdown::Document.new(@src)
   @html = km.to_html
   @warnings = km.warnings
   @dirty = false
 end</code></pre></figure>

<p>別案は <em>set_src</em> ではなく <em>update_src</em> にするというものです。そんなにピンときませんが、<em>src=</em> よりはたくさんのことをしそうな気がします。</p>

<p>ここでは、<em>src=</em> にします。理由は <em>src=</em> の方が Ruby らしい名前だからです。Ruby らしくない名前（<em>set_src</em> とか camelCase のメソッド名とか）を使うと、Rubyist が読んだ時にモヤっとします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit 727e6c6fa3c862d0e6e87a76d1d6435d06a70cc1 (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Mon Oct 15 23:22:04 2012 +0900

     Use Rubyish name

     set_src -&gt;
     src=

     Non-Rubyish name confuses Rubyists.
 ---
  wikir.rb |    6 +++---
  1 file changed, 3 insertions(+), 3 deletions(-)

 diff --git a/wikir.rb b/wikir.rb
 index c51e312..e63f9d6 100644
 --- a/wikir.rb
 +++ b/wikir.rb
 @@ -21,7 +21,7 @@ class WikiR
        @monitor.synchronize do
          page = self[name]
          @pages[name] = page
 -        page.set_src(src)
 +        page.src = src
        end
      end
    end
 @@ -29,11 +29,11 @@ class WikiR
    class Page
      def initialize(name)
        @name = name
 -      set_src("# #{name}\n\nan empty page. edit me.")
 +      self.src = "# #{name}\n\nan empty page. edit me."
      end
      attr_reader :name, :src, :html, :warnings

 -    def set_src(text)
 +    def src=(text)
        @src = text
        km = Kramdown::Document.new(text)
        @html = km.to_html</code></pre></figure>

<p>なお、diff にもある通り、<em>WikiR::Book</em> で後回しにした気になることはこのメソッドの名前のことでした。</p>

<p>次に気になることは <em>src=</em> の中です。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 36 def src=(text)
 37   @src = text
 38   km = Kramdown::Document.new(text)
 39   @html = km.to_html
 40   @warnings = km.warnings
 41 end</code></pre></figure>

<p><em>km</em> という変数名が気になります。これは KraMdown の略だと思いますが、このオブジェクトは <em>Kramdown::Document</em> オブジェクトなので <em>km</em> ではなく <em>document</em> が適切です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit 66359d8fa18df2e3ea64d8a7f47e79a710dfa126 (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Mon Oct 15 23:29:07 2012 +0900

     Use meaningful name

     km -&gt;
     document

     Non-meaningful name is not readable.
 ---
  wikir.rb |    6 +++---
  1 file changed, 3 insertions(+), 3 deletions(-)

 diff --git a/wikir.rb b/wikir.rb
 index e63f9d6..2bcc096 100644
 --- a/wikir.rb
 +++ b/wikir.rb
 @@ -35,9 +35,9 @@ class WikiR

      def src=(text)
        @src = text
 -      km = Kramdown::Document.new(text)
 -      @html = km.to_html
 -      @warnings = km.warnings
 +      document = Kramdown::Document.new(text)
 +      @html = document.to_html
 +      @warnings = document.warnings
      end
    end</code></pre></figure>

<p>他にも <em>src</em> と省略しないで <em>source</em> にしたいとか、<em>attr_reader</em> は <em>initialize</em> の下じゃなくて上に書きたいとか、<em>”# #{name}…”</em> は <em>default_source</em> というメソッドとして括りだしたいとかありますが省略します。</p>

<h5 id="wikirui">WikiR::UI</h5>

<p>最後は <em>WikiR::UI</em> です。ERB が使われていて咳さんらしいコードですね。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 44   class UI &lt; WEBrick::CGI
 45     include ERB::Util
 46     extend ERB::DefMethod
 47     def_erb_method('to_html(page)', ERB.new(&lt;&lt;EOS))
 48 &lt;html&gt;
 49 &lt;head&gt;
 50 &lt;title&gt;Kramdown&lt;/title&gt;
 51 &lt;script language="JavaScript"&gt;
 52 function open_edit(){
 53 document.getElementById('edit').style.display = "block";
 54 }
 55 &lt;/script&gt;
 56 &lt;/head&gt;
 57 &lt;body&gt;
 58 &lt;%= page.html %&gt;
 59 &lt;a href='javascript:open_edit()'&gt;[edit]&lt;/a&gt;
 60 &lt;div id='edit' style='display:none;'&gt;
 61 &lt;form method='post'&gt;
 62 &lt;textarea name='text' rows="40" cols="50"&gt;&lt;%=h page.src %&gt;&lt;/textarea&gt;
 63 &lt;input type='submit' name='ok' value='ok'/&gt;
 64 &lt;/form&gt;
 65 &lt;/div&gt;
 66 &lt;/body&gt;
 67 &lt;/html&gt;
 68 EOS
 69
 70     def initialize(book, *args)
 71       super(*args)
 72       @book = book
 73     end
 74
 75     def do_GET(req, res)
 76       do_request(req, res)
 77       build_page(req, res)
 78     end
 79     alias :do_POST :do_GET
 80
 81     def do_request(req, res)
 82       text ,= req.query['text']
 83       return if text.nil? || text.empty?
 84       text = text.force_encoding('utf-8')
 85       @book[req.path_info] = text
 86     rescue
 87     end
 88
 89     def build_page(req, res)
 90       res['content-type'] = 'text/html; charset=utf-8'
 91       res.body = to_html(@book[req.path_info])
 92     end
 93   end</code></pre></figure>

<p>まずは、ERB 関連の部分を見ましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 45     include ERB::Util
 46     extend ERB::DefMethod
 47     def_erb_method('to_html(page)', ERB.new(&lt;&lt;EOS))
 ...
 68 EOS</code></pre></figure>

<p>特に改善案はないのですが、前から <em>DefMethod</em> というモジュール名がカッコ悪いなぁと思っていることだけ書いておきます。</p>

<p>なお、<em>def_erb_method</em> のように ERB をメソッドとして使うのは ERB way です。MVC の V は View Object（実行環境とテンプレート）なのです！　気になる人は<a href="http://www.druby.org/erb08.pdf">erbを偲んで（PDF）</a>を確認しましょう。</p>

<p>ERB はこのくらいにして次に進みましょう。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 81 def do_request(req, res)
 82   text ,= req.query['text']
 83   return if text.nil? || text.empty?
 84   text = text.force_encoding('utf-8')
 85   @book[req.path_info] = text
 86 rescue
 87 end</code></pre></figure>

<p>以下の書き方は、「Ruby で Web アプリケーションを書くときは <a href="http://rack.github.com/">Rack</a> ベースのものばかり<sup id="fnref:10" role="doc-noteref"><a href="#fn:10" class="footnote">10</a></sup>」という人には馴染みのないものでしょう。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 82 text ,= req.query['text']</code></pre></figure>

<p>WEBrick が提供する CGI 用ライブラリや昔の cgi.rb は、クエリーパラメーターの値を必ず配列で返します。これは、<em>cgi.rb?key=value1;key=value2</em> というリクエストのときに <em>“key”</em> の値として <em>[“value1”, “value2”]</em> と配列を返すだけではなく、<em>cgi.rb?key=value</em> というリクエストのときも <em>“key”</em> の値として <em>[“value”]</em> と配列を返すということです。しかし、多くの場合は最初の値だけで十分です。そこで上述の書き方になります。多重代入の構文ですが、<em>,</em> を <em>=</em> にくっつけることで <em>,=</em> で 1 つの代入演算子のように見せようとしているのでしょう。右辺の最初の値を左辺に代入するという書き方です。昔は見た書き方ですが、最近は見ることが少なくなった書き方です。</p>

<p>昔話でした。</p>

<p>それでは、最近の書き方をしているところも見てみましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 84 text = text.force_encoding('utf-8')</code></pre></figure>

<p><em>force_encoding</em> は <em>!</em> がついていないので名前だけではわかりづらいですが、破壊的なメソッドです。そのため、戻り値を <em>text</em> に代入する必要はありません。これで十分です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> text.force_encoding('utf-8')</code></pre></figure>

<p>元の文字列を変更したくない場合は以下のようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> text = text.dup.force_encoding('utf-8')</code></pre></figure>

<p>このメソッドにはそれよりも気になることがあります。それは、例外を握りつぶしているという事です。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> 81 def do_request(req, res)
 ...
 86 rescue
 87 end</code></pre></figure>

<p><em>rescue</em> の中でログを出力するなどした方がよいです。</p>

<p><em>WEBrick::CGI</em> には触れませんでしたが、咳さんが解説してくれるかもしれません<sup id="fnref:11" role="doc-noteref"><a href="#fn:11" class="footnote">11</a></sup>。WikiR の本体 wikir.rb については以上です。</p>

<p>と思ったのですが、最後に 1 つ気になることがあったので触れておきます。wikir.rb の構造は以下のようになっていて、<em>WikiR</em> はネームスペース<sup id="fnref:12" role="doc-noteref"><a href="#fn:12" class="footnote">12</a></sup>としてしか使われていません。</p>

<p>wikir.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  9 class WikiR
 10   class Book
 ...
 27   end
 ...
 29   class Page
 ...
 42   end
 ...
 44   class UI &lt; WEBrick::CGI
 ...
 93   end
 94 end
 95
 96 if __FILE__ == $0
 97   book = WikiR::Book.new
 98   ui = WikiR::UI.new(book)
 99   DRb.start_service('druby://localhost:50830', ui)
100   DRb.thread.join
101 end</code></pre></figure>

<p>そのため、クラスではなくモジュールにするのが適切です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit cb0b0447fe09c8f99b31b5513848c8fb617e0c07 (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Tue Oct 16 21:43:20 2012 +0900

     class -&gt; module

     Module is suitable for namespace use.
 ---
  wikir.rb |    2 +-
  1 file changed, 1 insertion(+), 1 deletion(-)

 diff --git a/wikir.rb b/wikir.rb
 index 2bcc096..f4cf1e3 100644
 --- a/wikir.rb
 +++ b/wikir.rb
 @@ -6,7 +6,7 @@ require 'drb/drb'
  require 'erb'
  require 'monitor'

 -class WikiR
 +module WikiR
    class Book
      def initialize
        @monitor = Monitor.new</code></pre></figure>

<p>どうしてこうなったかを想像してみましょう。おそらく、最初は <em>WikiR</em> クラスだけがあったのでしょう。しかし、コードを書いていくうちにクラスが大きくなってきたので分割したのではないかと思います。咳さんの書くクラスは小さくなることを思い出してください。そして、分割した後、単なるネームスペースとしてしか使わなくなったのでしょう。</p>

<p>今度こそ wikir.rb については以上です。</p>

<h4 id="indexrb">index.rb</h4>

<p>続いて、WikiR の CGI フロントエンドである index.rb です。index.rb はたった 6 行です。咳プロダクツらしいですね。</p>

<p>index.rb:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> #!/usr/bin/ruby
 require 'drb/drb'

 DRb.start_service('druby://localhost:0')
 ro = DRbObject.new_with_uri('druby://localhost:50830')
 ro.start(ENV.to_hash, $stdin, $stdout)</code></pre></figure>

<p>その人のコードを見続けていると、この人はどうしてこんなコードを書いたのか、というのがわかってきます<sup id="fnref:13" role="doc-noteref"><a href="#fn:13" class="footnote">13</a></sup>。昔、咳さんのコードを見ていた私からすると「このコードはいろんなプロダクツで使いまわしているコードだろうなぁ」と感じます。</p>

<p>ちゃんと書いた咳さんのコードでは「<em>ro</em>（たぶん、Remote Object の略）」という名前を使いません。咳さんなら「<em>wikir</em>（リモートにあるどのオブジェクトを触るかがわかる名前。一見、ローカルのオブジェクトに見える名前をつけるはずです。wikir.rb の最後を見るとリモートにあるのは <em>WikiR::UI</em> ですが、<em>ui</em> にはしないはずです。リモートのオブジェクトを提供する側は公開用に <em>WikiR::UI</em> というオブジェクトを用意していますが、使う側からすれば Wiki サービスを使いたいだけなので、それが UI 用のやつかどうかなんて気にしたくありません。）」や「<em>front</em>（dRuby本でも使われている伝統的な名前）」といった名前を使うはずです。</p>

<p>ここでは <em>wikir</em> にしましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> commit 468dc345e63efd1ef121dc374571e8eab97ed4dd (HEAD, master)
 Author: Kouhei Sutou &lt;kou@clear-code.com&gt;
 Date:   Tue Oct 16 00:16:08 2012 +0900

     Use meaningful name

     ro -&gt;
     wikir

     Non-meaningful name is not readable.
 ---
  index.rb |    4 ++--
  1 file changed, 2 insertions(+), 2 deletions(-)

 diff --git a/index.rb b/index.rb
 index 1b146a6..efe0fbd 100755
 --- a/index.rb
 +++ b/index.rb
 @@ -2,5 +2,5 @@
  require 'drb/drb'

  DRb.start_service('druby://localhost:0')
 -ro = DRbObject.new_with_uri('druby://localhost:50830')
 -ro.start(ENV.to_hash, $stdin, $stdout)
 +wikir = DRbObject.new_with_uri('druby://localhost:50830')
 +wikir.start(ENV.to_hash, $stdin, $stdout)</code></pre></figure>

<p>index.rb については以上です。</p>

<h3 id="まとめ">まとめ</h3>

<p>咳さんの書いた小さな Wiki のコードを上から見て<sup id="fnref:14" role="doc-noteref"><a href="#fn:14" class="footnote">14</a></sup>気になることをコメントしました。咳さんはどうしてこのようなコードを書いたのだろうか、ということを考えながら読んでいることが伝わったでしょうか。コードを読むときは書いた人がどうしてこのコードを書いたかということを考えながら読みましょう。そうした方がコードを理解しやすくなります<sup id="fnref:15" role="doc-noteref"><a href="#fn:15" class="footnote">15</a></sup>。理解した状態でコードを読み書きした方がプログラミングは楽しいですよ。ぜひ試してみてください。</p>

<p>読む人の視点でコードと向き合うことで、コードの書き方も変わってくるかもしれません。「このようにコードを書くと読む人はどう思うかな？」という視点が入るかもしれません。あなたの書いたコードを読み書きした人が楽しくプログラミングできたらステキじゃないですか。</p>

<p>次号は咳さんの言い訳編です。私のコメントに対して咳さんがひとつひとつ言い訳する予定です。楽しみですね。</p>

<h3 id="著者紹介">著者紹介</h3>

<p>須藤功平 (株式会社クリアコード) 。フリーソフトウェアプログラマーで株式会社クリアコード代表取締役 (2 代目) 。社名の命名者でもある。社名の由来は「クリアなコード」。その名の通りクリアなコードを書く会社であろうという意図を込めている。最近は自分がどうやってクリアなコードを書いているかを他の人にうまく伝えるにはどうしたらよいかに興味がある。</p>

<h2 id="ruby-コードの感想戦-連載一覧">Ruby コードの感想戦 連載一覧</h2>

<ul>
  <li>
    <p><a href="../../articles/0041/0041-CodePostMortem.html">Ruby コードの感想戦 【第 2 回】 WikiR</a></p>
  </li>
  <li>
    <p><a href="../../articles/0040/0040-CodePostMortem.html">Ruby コードの感想戦 【第 1 回】 WikiR</a></p>
  </li>
</ul>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>今回の話題には関係ありませんが、問題解決をするにあたり、これはとても大事なことです。 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>ファイルの先頭の ‘’#!…’’ のこと <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>コミットメッセージの instead of はなんか違う気がします。 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>そのため、この記事では「コードを見る」という書き方をしています。 <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p>コミットメールとはリポジトリにコミットしたことを通知するメールです。Ruby 本体も提供しています。<a href="http://www.ruby-lang.org/ja/community/mailing-lists/">ruby-cvs というメーリングリスト</a>に流れるので誰でも確認できます。コミットメールには変更点が含まれるものと含まれないものがあります。変更点を確認しやすいので含まれるものがオススメです。なお、ruby-cvs には含まれていません。実は、含まれるバージョンもあります。<a href="http://blade.nagaokaut.ac.jp/cgi-bin/scat.rb/ruby/ruby-dev/30071">ruby-changes というメーリングリスト</a>がそれです。Ruby 本体の開発に興味がある人はコミットメールですべての変更点を読むとよいでしょう。 <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:6" role="doc-endnote">
      <p>Vim を使っている人は ‘’# vim: fileencoding=エンコーディング名’’ でもよいです。 <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:7" role="doc-endnote">
      <p>GNU Emacs で Ruby スクリプトを編集するための編集モード。 <a href="#fnref:7" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:8" role="doc-endnote">
      <p>参考: 「キラキラネーム」、「DQN ネーム」 <a href="#fnref:8" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:9" role="doc-endnote">
      <p>今回の場合はモジュールなのに ‘‘initialize’’ で ‘‘super’’ しないといけないのがわかりにくいということですが、このメッセージだけでは伝わらないのでよくありませんね！ <a href="#fnref:9" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:10" role="doc-endnote">
      <p>Ruby on Rails や Sinatra などのフレームワークを使った Web アプリケーションなど。 <a href="#fnref:10" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:11" role="doc-endnote">
      <p>咳さんは ‘‘WEBrick::CGI’’ に思い入れがあるようです。 <a href="#fnref:11" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:12" role="doc-endnote">
      <p>他のコードと名前が衝突しないようにする仕組み。コードをグループ化することにも使われる。wikir.rb の中では後者として使っていそう。 <a href="#fnref:12" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:13" role="doc-endnote">
      <p>想像できるようになってくるだけで、わかってはいないかもしれません。 <a href="#fnref:13" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:14" role="doc-endnote">
      <p>目線の話ではなく順序の話です。 <a href="#fnref:14" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:15" role="doc-endnote">
      <p>どうしても理解できないコードが世の中にはたくさんあるとは思います。 <a href="#fnref:15" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
