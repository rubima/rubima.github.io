<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Chef でサーバ管理を楽チンにしよう！ (第 2 回)</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0037/0037-ChefInDECOLOG.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0060/0060-index.html">0060号(2019-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2019/preRubyKaigi2019-index.html">RubyKaigi 2019 直前特集号</a></li>
    
        <li><a href="../../articles/0059/0059-index.html">0059号(2019-01)</a></li>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Chef でサーバ管理を楽チンにしよう！ (第 2 回)</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=Chef でサーバ管理を楽チンにしよう！ (第 2 回)&amp;url=https://magazine.rubyist.net/articles/0037/0037-ChefInDECOLOG.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0037/0037-ChefInDECOLOG.html&amp;t=Chef でサーバ管理を楽チンにしよう！ (第 2 回)" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0037/0037-ChefInDECOLOG.html&amp;Chef でサーバ管理を楽チンにしよう！ (第 2 回)" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            



                        </div>
                        
<ul id="markdown-toc">
  <li><a href="#最初に" id="markdown-toc-最初に">最初に</a></li>
  <li><a href="#対象読者" id="markdown-toc-対象読者">対象読者</a></li>
  <li><a href="#今回の課題" id="markdown-toc-今回の課題">今回の課題</a></li>
  <li><a href="#設定ファイルを変更したらサービスを再起動" id="markdown-toc-設定ファイルを変更したらサービスを再起動">設定ファイルを変更したらサービスを再起動</a></li>
  <li><a href="#もっといろいろ実行してみる" id="markdown-toc-もっといろいろ実行してみる">もっといろいろ実行してみる</a></li>
  <li><a href="#最後に" id="markdown-toc-最後に">最後に</a></li>
  <li><a href="#著者について" id="markdown-toc-著者について">著者について</a></li>
</ul>

<p>書いた人：諸富　洋 (<a href="https://twitter.com/#!/164c">@164c</a>)</p>

<h2 id="最初に">最初に</h2>

<p>前回の「<a href="../../articles/0035/0035-ChefInDECOLOG.html">Chef でサーバ管理を楽チンにしよう！ (第 1 回)</a>」では、Chef の紹介とカンタンなレシピの書き方とテストの方法を紹介しました。今回は次の一歩を紹介したいと思います。</p>

<p>ひとたび Chef を導入したならば、その後はレシピを書くことが Chef に関わるタスクの大半になります。ですので、今回も引き続き、レシピの書き方についてお伝えしていきます。今回のテーマは「○○したら、それを受けて××する」という手続きのレシピの書き方です。</p>

<h2 id="対象読者">対象読者</h2>

<p>Chef を導入したばかりでレシピの書き方に迷っている人</p>

<h2 id="今回の課題">今回の課題</h2>

<p>前回では、ミドルウェアなどの設定ファイルの管理を想定した「一定の内容が書かれたファイルを指定の場所に指定の状態に保つ」ことを実現しました。</p>

<p>さて、この設定ファイルの内容を変える必要が出てきたとします。ただテキストを変更するだけなら、とてもカンタンです。テンプレートを修正して chef-solo を実行するか、chef-client の実行をすれば変更後の内容に置き換わります。</p>

<p>ところが、大抵のミドルウェアでは設定ファイルの内容を置き換えるだけでは変更内容は反映されません。だいたい後の処理として再起動など (reload とか restart) が必要になります。
このような「○○したら、それを受けて××する」というのはレシピを書く上での超頻出パターンです。</p>

<p>今回はこの「○○したら、それを受けて××する」について挑戦してみたいと思います。<a href="http://wiki.opscode.com/display/chef/Resources">Chef Wiki の Resources のページ</a>を参考にしながら進めます</p>

<p>また、前回の続きということで、cookbook “test” がすでにある状態から始めます。</p>

<h2 id="設定ファイルを変更したらサービスを再起動">設定ファイルを変更したらサービスを再起動</h2>

<p>「httpd.conf を修正したら apache 再起動」をイメージしてみます。
これは前述の参考サイトにほとんどそのまんま書いてあります。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/recipes/default.rb</span>

<span class="n">template</span> <span class="s2">"/tmp/test.conf"</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">"service[httpd]"</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">"httpd"</span>

</code></pre></div></div>

<p>これだけです。Service リソースは引数と同名の init スクリプトを探して実行します。service コマンドと同じですね<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>。</p>

<p><a href="http://wiki.opscode.com/display/chef/Resources#Resources-Service">http://wiki.opscode.com/display/chef/Resources#Resources-Service</a></p>

<p>設定ファイルに変更がないときのログ</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">〜
[Thu, 19 Jan 2012 22:22:37 +0900] DEBUG: template[/tmp/test.conf] content has not changed.
[Thu, 19 Jan 2012 22:22:37 +0900] DEBUG: Processing service[httpd] on hoge
[Thu, 19 Jan 2012 22:22:37 +0900] INFO: Processing service[httpd] action nothing (test::default line 32)
〜</code></pre></figure>

<p>“content has not changed.” で “Processing service[httpd] action nothing” とでています。実際の動作も何もしません。</p>

<p>設定ファイルに変更があった時のログ</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[Thu, 19 Jan 2012 22:24:46 +0900] INFO: Processing template[/tmp/test.conf] action create (test::default line 24)
[Thu, 19 Jan 2012 22:24:46 +0900] DEBUG: Current content's checksum:  15b601f97b98f27fc0e209408fa88366544286d13987c4a6cf87b0734396add8
[Thu, 19 Jan 2012 22:24:46 +0900] DEBUG: Rendered content's checksum: 2e0390eb024a52963db7b95e84a9c2b12c004054a7bad9a97ec0c7c89d4681d2
〜〜〜〜
[Thu, 19 Jan 2012 22:24:46 +0900] INFO: template[/tmp/test.conf] sending restart action to service[httpd] (delayed)</code></pre></figure>

<p>“Processing template[/tmp/test.conf] action create” ということでファイルが置き換えられます。
その後 “sending restart action to service[httpd] (delayed)” ということで httpd に対して restart が送られます。
最後に (delayed) というのがあります。</p>

<p>変更時に処理を指定する際に “notifies” を使いますが、notifies のデフォルトは delayed となり、キューに貯められて Chef の処理の最後にまとめて実行されます。
今回は、処理がひとつしかないので特に困りませんが、依存関係のある複数の処理が走る場合に、即時実行したい場合は、:immediately を指定しましょう。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/recipes/default.rb</span>

<span class="n">template</span> <span class="s2">"/tmp/test.conf"</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">"service[httpd]"</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">"httpd"</span>

</code></pre></div></div>

<p>これで実行してログを確認すると、先程 (delayed) になっていた部分が (immediate) に変わっているはずです。</p>

<p>先ほどの Service リソースのマニュアルに書いてあるとおり、service 名は別名で指定できますし、start、stop、restart などの処理に対してコマンドを明示することもできます。</p>

<p>つまり、</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/recipes/default.rb</span>

<span class="n">template</span> <span class="s2">"/tmp/test.conf"</span> <span class="k">do</span>
 <span class="n">owner</span> <span class="s2">"root"</span>
 <span class="n">group</span> <span class="s2">"root"</span>
 <span class="n">mode</span> <span class="s2">"0644"</span>
 <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s2">"service[hoge]"</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s2">"hoge"</span> <span class="k">do</span>
  <span class="n">service_name</span> <span class="s2">"httpd"</span>
  <span class="n">restart_command</span> <span class="s2">"service httpd restart"</span>
<span class="k">end</span>

</code></pre></div></div>

<p>こう書くことができます。</p>

<p>こういった具合に DSL を使ってやりたいことがカンタンに書けちゃいますので、柔軟に実現することができます。</p>

<h2 id="もっといろいろ実行してみる">もっといろいろ実行してみる</h2>

<p>Service リソースは service の制御しかできません (十分有用ですけど) 。</p>

<p>さらに自由度が高いリソースとして <a href="http://wiki.opscode.com/display/chef/Resources#Resources-Execute">Execute リソース</a>があります。これを使って、メールを送ってみることにしましょう。</p>

<p>この流れなので「設定ファイルに変更があったら、メール送信」ということにしたいと思います。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/recipes/default.rb</span>

<span class="n">execute</span> <span class="s2">"sendmail"</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s1">'echo "Cook me something tasty." | mail -s "Hello! Chef!" 164c@example.com'</span>
<span class="k">end</span>

<span class="n">template</span> <span class="s2">"/tmp/test.conf"</span> <span class="k">do</span>
 <span class="n">owner</span> <span class="s2">"root"</span>
 <span class="n">group</span> <span class="s2">"root"</span>
 <span class="n">mode</span> <span class="s2">"0644"</span>
<span class="c1"># notifies :restart, "service[hoge]"</span>
 <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:execute</span> <span class="o">=&gt;</span> <span class="s2">"sendmail"</span><span class="p">)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>こんな感じに書いてみます。execute のブロックは呼び出す前に記述しておく必要があります。</p>

<p>これを実行するとメールが送られてくると思います<sup id="fnref:2"><a href="#fn:2" class="footnote">2</a></sup>。ところが、これだとファイルに変更がなくても実行されてしまい、メールが送られてきます。</p>

<p>Execute リソースのアクションは run と nothing で、デフォルトが run になっているためです。ファイルが変更されたときだけ、実行させるためには nothing にしておきます。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/recipes/default.rb</span>

<span class="n">execute</span> <span class="s2">"sendmail"</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s1">'echo "Cook me something tasty." | mail -s "Hello! Chef!" morotomi@328w.co.jp'</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>

<span class="n">template</span> <span class="s2">"/tmp/test.conf"</span> <span class="k">do</span>
 <span class="n">owner</span> <span class="s2">"root"</span>
 <span class="n">group</span> <span class="s2">"root"</span>
 <span class="n">mode</span> <span class="s2">"0644"</span>
<span class="c1"># notifies :restart, "service[hoge]"</span>
 <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:execute</span> <span class="o">=&gt;</span> <span class="s2">"sendmail"</span><span class="p">)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>これで完成です。実行してログとメールを確認してみてください。</p>

<p>ちなみに Script リソースを使えばこれと同じようなことは Perl や Python、Ruby などの言語で書くこともできます。</p>

<p><a href="http://wiki.opscode.com/display/chef/Resources#Resources-Script">http://wiki.opscode.com/display/chef/Resources#Resources-Script</a></p>

<p>ところで、マニュアルによると「Execute や Script リソースは “idempotent” を保証してないよ！　だからあなたが “idempotent” になるように記載するよう注意してね！」ということが書かれています。”idempotent” とは、何回行なっても同じ結果が得られることを指す概念だそうです<sup id="fnref:3"><a href="#fn:3" class="footnote">3</a></sup>。今回はなんでもできる度をアピールするためこういった例を出しましたが、Chef はサーバ環境などを “idempotent” に保つために設計されたものであり、その思想から外れるものは別のツールに頼るのが後の幸せを買うことになるのかもしれません。</p>

<h2 id="最後に">最後に</h2>

<p>というわけで、今回は以上です。</p>

<p>いきなりですが、ミツバチワークスではプログラマーやインフラエンジニアなど、Web サービスの開発・運用メンバーを募集しています。みんな大好き Rails を使ったプロジェクトも近々開始されます (というかこれが公開されるころには開始されているはず。。) 
Chef以外にも様々な取り組みを行なっていますので、興味があるかたはぜひ、「<a href="http://tech.dclog.jp/2010/10/blog-post.html">仲間募集のお知らせ</a>」をご覧ください！</p>

<h2 id="著者について">著者について</h2>

<p>諸富　洋。モバイル向けブログサイト「<a href="http://dclog.jp/">DECOLOG</a>」を運営する<a href="http://www.328w.co.jp/">ミツバチワークス株式会社</a>の中の人。<a href="https://twitter.com/#!/164c">@164c</a>。<a href="http://tech.dclog.jp/">DECOLOG TECH BLOG</a>。</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>というか、chef-solo のログを見ていたら内部的にも service コマンドが実行されていました <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:2">
      <p>sendmail コマンドで外部にメールが送れる環境が必要です <a href="#fnref:2" class="reversefootnote">&#8617;</a></p>
    </li>
    <li id="fn:3">
      <p>日本語では冪等性 (べきとうせい) と言ったりする <a href="#fnref:3" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
