<!DOCTYPE html>
<html>
  



  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ruby 2.0.0： refinement</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="../..http://magazine.rubyist.net/articles/ruby200specialen/Ruby200SpecialEn-refinement.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>Ruby 2.0.0： refinement</h1>
                        <div class="social-buttons">
                            <a href="http://b.hatena.ne.jp/entry//articles/ruby200specialen/Ruby200SpecialEn-refinement.html" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby 2.0.0： refinement" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/ruby200specialen/Ruby200SpecialEn-refinement.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/ruby200specialen/Ruby200SpecialEn-refinement.html" data-text="Ruby 2.0.0： refinement">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </div>
                        
<p>Author: Shugo Maeda(<a href="https://twitter.com/shugomaeda">@shugomaeda</a>)
Translator: Makoto Inoue(<a href="https://twitter.com/makoto_inoue">@makoto_inoue</a>)</p>

<h2 id="introduction">Introduction</h2>

<p>In this article, I will talk about Refinements which were supposed to be officially included as part of Ruby 2.0</p>

<h2 id="what-are-refinements-">What are Refinements ?</h2>

<p>Ruby has a feature to extend a class by redefining it. It’s called an “open class” or “monkey patching”.
It’s widely used in Rails, but overusing it may cause unexpected problems.</p>

<p>For example, requiring “mathn” that comes as part of standard library globally changes the behaviour of Fixnum#/</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">p 1 / 2 #=&gt; 0
require "mathn"
p 1 / 2 #=&gt; (1/2)</code></pre></figure>

<p>Refinements are intended to restrict the impact of monkey patching to a certain scope, and I proposed it.</p>

<p>Module#refine extends the class that is passed in as an argument</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># rationalize.rb
module Rationalize
  refine Fixnum do
    def /(other)
      quo(other)
    end
  end
end</code></pre></figure>

<p>Inside the refine block, “self” is set to an anonymous module called refinement, and you can add methods to the anonymous module.</p>

<p>The following is how you use it.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">using Rationalize
p 1 / 2 #=&gt; (1/2)</code></pre></figure>

<p>This extension is only useful within the file; it does not affect other files.</p>

<h2 id="the-specification-of-refinements">The specification of Refinements</h2>

<p>The specification of Refinements is described in the Wiki</p>

<ul>
  <li><a href="https://bugs.ruby-lang.org/projects/ruby-trunk/wiki/RefinementsSpec">Refinements Specification</a></li>
</ul>

<p>It may contain some bugs as I haven’t received much feedback.</p>

<h2 id="so-what-happened-in-the-end">So what happened in the end?</h2>

<p>Refinements were supposed to be the big features in Ruby 2.0.
However, they ended up as an experimental feature after stripping away a lot of functionality. (At one point, I suggested we remove the feature completely.)</p>

<p>Specifying “refine” or “using” will display a warning because they are still experimental features.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ ruby -e 'module M; refine String do end; end'
-e:1: warning: Refinements are experimental, and their behaviour may change in future versions of Ruby!</code></pre></figure>

<p>Please use them at your own risk (Don’t complain to me if the feature changes in future).</p>

<h2 id="the-deleted-functionalities">The deleted functionalities</h2>

<p>As mentioned earlier, much functionality has been removed since the initial proposal.</p>

<p>Here is a list of the deletions:</p>

<ul>
  <li>Enabling refinement per module</li>
  <li>Inheriting a module that is extended with “using”</li>
  <li>Extending a module (not a class) with “refine”</li>
  <li>Calling “super” in order among multiple classes extended with refinement</li>
  <li>Enabling refinement in module_eval and instance_eval</li>
</ul>

<p>The removal of the last feature has the biggest impact, since it is not as easy to use refinements in an internal DSL.</p>

<p>If we had this functionality, we might have had a feature <a href="https://github.com/amatsuda/activerecord-refinements">activerecord-refinements</a> that was implemented by Akira Matsuda.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">User.where { :name == 'matz' }</code></pre></figure>

<p>The above code would let you change the behaviour of an instance of the existing class (Symbol in this case) only within the block.</p>

<p>I was very disappointed because I was thinking about the following library using these features.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">require "sexy_regexp"
re = SexyRegexp.new { ("foo" | "bar") + (?0..?9).one_or_more }
p re.is_a?(Regexp) #=&gt; true
p re.source #=&gt; "(foo|bar)[0-9]+"</code></pre></figure>

<p>(Did you just say you were glad that this functionality was removed???)</p>

<p>If you read the specification in detail, you may have spotted that you can do similar things at the string level (not in the block level) by doing</p>

<p>eval(“using M; #{s}”, TOPLEVEL_BINDING)</p>

<p>However, this is not good enough because you cannot pass in local variables.</p>

<h2 id="so-why-were-they-removed">So why were they removed?</h2>

<p>We’ve received the following criticism when introducing Refinements</p>

<ul>
  <li>
    <ol>
      <li>Too complex</li>
    </ol>
  </li>
  <li>
    <ol>
      <li>The specification is not clear
        <ul>
          <li>No documentation</li>
          <li>No spec in RubySpec</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>
    <ol>
      <li>It’s hard to implement effectively in JRuby</li>
    </ol>
  </li>
  <li>
    <ol>
      <li>Mine is better than yours</li>
    </ol>
  </li>
</ul>

<p>Regarding 1, it’s the nature of refinements</p>

<p>Regarding 2, I created the Wiki page I mentioned earlier. I also added some specs to RubySpec, though they may not have been sufficient (In fact, it was harder to add Ruby 2.0 changes in RubySpec)</p>

<p>Regarding 3, ‘module_eval’ does play nicely with JRuby’s inline caching. I won’t go into detail on this for now.</p>

<p>Regarding 4, I’m sure there are many opinions.</p>

<p>I remember that there were other arguments. In the end, these arguments happened right before the release and therefore we didn’t have time to address all the issues.</p>

<h2 id="finally">Finally</h2>

<p>I have so far proposed “continuation” and “protected” (I’m sure I’ve made other useful proposals, but can’t remember all of them.)</p>

<p>I wonder if Refinements will be “never two without three” or “third time lucky”.</p>

<p>I am passionate about proposing interesting yet odd features. Stay tuned for my next proposal.</p>

<h2 id="about-the-author">About the author</h2>

<h3 id="shugo-maeda">Shugo Maeda</h3>

<p>A programmer born in 1975. My favourite music album is “Now and Then” (the cover of “Give Me the Night” is cool) released in 30th Jan by Cloudberry Jam and “Lua no Ceu Congadeiro” by Yuri Popoff</p>

<p>URL: <a href="http://shugo.net">http://shugo.net</a></p>


                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
