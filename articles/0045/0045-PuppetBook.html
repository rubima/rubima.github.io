<!DOCTYPE html>
<html>
  



  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>入門 Puppet ダイジェスト</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="../..http://magazine.rubyist.net/articles/0045/0045-PuppetBook.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>入門 Puppet ダイジェスト</h1>
                        <div class="social-buttons">
                            <a href="http://b.hatena.ne.jp/entry//articles/0045/0045-PuppetBook.html" class="hatena-bookmark-button" data-hatena-bookmark-title="入門 Puppet ダイジェスト" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0045/0045-PuppetBook.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0045/0045-PuppetBook.html" data-text="入門 Puppet ダイジェスト">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </div>
                        
<h2 id="入門-puppet-ダイジェスト">入門 Puppet ダイジェスト</h2>

<ul id="markdown-toc">
  <li><a href="#入門-puppet-ダイジェスト" id="markdown-toc-入門-puppet-ダイジェスト">入門 Puppet ダイジェスト</a>    <ul>
      <li><a href="#ダイジェスト版によせて" id="markdown-toc-ダイジェスト版によせて">ダイジェスト版によせて</a></li>
      <li><a href="#はじめに" id="markdown-toc-はじめに">はじめに</a></li>
      <li><a href="#システム環境" id="markdown-toc-システム環境">システム環境</a></li>
    </ul>
  </li>
  <li><a href="#vagrant-で開発環境を用意する" id="markdown-toc-vagrant-で開発環境を用意する">Vagrant で開発環境を用意する</a>    <ul>
      <li><a href="#vagrant-とは" id="markdown-toc-vagrant-とは">Vagrant とは？</a></li>
      <li><a href="#vagrant-のインストール" id="markdown-toc-vagrant-のインストール">Vagrant のインストール</a></li>
      <li><a href="#仮想ホストの起動" id="markdown-toc-仮想ホストの起動">仮想ホストの起動</a></li>
      <li><a href="#仮想ホストに-ssh-ログインする" id="markdown-toc-仮想ホストに-ssh-ログインする">仮想ホストに SSH ログインする</a></li>
      <li><a href="#仮想ホストの停止破棄" id="markdown-toc-仮想ホストの停止破棄">仮想ホストの停止・破棄</a></li>
    </ul>
  </li>
  <li><a href="#hello-puppet" id="markdown-toc-hello-puppet">Hello, Puppet!</a>    <ul>
      <li><a href="#puppet-のインストール" id="markdown-toc-puppet-のインストール">Puppet のインストール</a></li>
      <li><a href="#manifest-を置く場所" id="markdown-toc-manifest-を置く場所">manifest を置く場所</a></li>
      <li><a href="#manifest-を書いてみる" id="markdown-toc-manifest-を書いてみる">manifest を書いてみる</a></li>
      <li><a href="#manifest-を適用する" id="markdown-toc-manifest-を適用する">manifest を適用する</a></li>
      <li><a href="#パッケージをインストールする" id="markdown-toc-パッケージをインストールする">パッケージをインストールする</a></li>
      <li><a href="#manifest-の作成適用の流れ" id="markdown-toc-manifest-の作成適用の流れ">manifest の作成・適用の流れ</a></li>
      <li><a href="#function" id="markdown-toc-function">Function</a></li>
      <li><a href="#resouce-type" id="markdown-toc-resouce-type">Resouce Type</a></li>
    </ul>
  </li>
  <li><a href="#nginx-の-manifest-を書く" id="markdown-toc-nginx-の-manifest-を書く">nginx の manifest を書く</a>    <ul>
      <li><a href="#nginx-が使える状態とは" id="markdown-toc-nginx-が使える状態とは">「nginx が使える状態」とは？</a></li>
      <li><a href="#manifest-に落とす" id="markdown-toc-manifest-に落とす">manifest に落とす</a></li>
      <li><a href="#manifest-の内容" id="markdown-toc-manifest-の内容">manifest の内容</a></li>
      <li><a href="#テンプレートを用意する" id="markdown-toc-テンプレートを用意する">テンプレートを用意する</a></li>
      <li><a href="#manifest-を適用する-1" id="markdown-toc-manifest-を適用する-1">manifest を適用する</a></li>
      <li><a href="#relationship" id="markdown-toc-relationship">Relationship</a></li>
      <li><a href="#resource-reference" id="markdown-toc-resource-reference">Resource Reference</a></li>
    </ul>
  </li>
  <li><a href="#完全版の入手方法" id="markdown-toc-完全版の入手方法">完全版の入手方法</a></li>
  <li><a href="#筆者について" id="markdown-toc-筆者について">筆者について</a></li>
</ul>

<hr />

<p>(ダイジェスト版を)書いた人：柴田博志 (@hsbt)</p>

<h3 id="ダイジェスト版によせて">ダイジェスト版によせて</h3>

<p>本書は @kentaro 氏の「入門 Puppet」を著者の許諾を得て、@hsbt が前半の数章を抜粋し編集したものです。</p>

<h3 id="はじめに">はじめに</h3>

<p>クラウドが一般的になってきた昨今、サーバ構成管理の自動化は、もはやそれなしでは考えられないほど当たり前のものになっています。<a href="https://puppetlabs.com/">Puppet</a> は、そのためのフレームワークのひとつです。</p>

<p>Puppet は 2005 年のリリース以来、後発の <a href="http://www.opscode.com/chef/">Chef</a> とともに、サーバ構成管理の自動化に欠かせないフレームワークとして広く利用されてきました。とはいえ、ドキュメントが非常に充実してはいるもののその機能は膨大で、初心者にとって決してとっつきやすいものでないことは確かでしょう。現に、筆者の周りでも「Puppet を学習してみたいけど、どこから手をつけたらいいのか……」という声をよくききます。</p>

<p>クラウドの一般化によって、物理的な制約から離れ、サーバをあたかもプログラム上のオブジェクトであるかのように扱えるようになった現在、エンジニアにとって、Puppet のような自動化ツールを使いこなせるようになることは、技術スキルの向上に大きく寄与するでしょう。この本は、既に Puppet などの自動化ツールを使いこなしているオペレーションエンジニアよりもむしろ、技術向上への意欲を燃やすアプリケーション開発者への入門となることを目指しています。</p>

<p>本書の目標は、この本を読んだ読者が Puppet の基本についてひととおり知り、オペレーションエンジニアの書いた manifest (サーバのあるべき状態を記述した設定ファイルのようなもの。後述) に変更を加えたり、ある程度の規模のものなら自力でいちから書けるようになったりすることです。そのため、本書はあえてリファレンスとしての網羅性を目指しません。実際の学習段階で必要となる知識にしぼって説明します。</p>

<p>是非、本書を読みながら自分でも手を動かしてみて、一歩先行くエンジニアになってみませんか。</p>

<h3 id="システム環境">システム環境</h3>

<p>本書執筆時の、筆者のシステム環境は以下の通りです。</p>

<ul>
  <li>作業環境: Mac OSX 10.8.2 + ruby 2.0.0</li>
  <li>本番環境: Amazon Linux AMI 2013.03 + ruby 1.8.7</li>
  <li>開発環境: Vagrant 1.1.5 + CentOS 6.4 + ruby 1.8.7</li>
  <li>Puppet: 3.1.1</li>
</ul>

<p>現状、最も広く使われている Puppet のバージョンは 2.7 系だと思われますが、本書における説明の範囲内では、3.1 系でもたいした違いはありませんので、ご安心ください。</p>

<h2 id="vagrant-で開発環境を用意する">Vagrant で開発環境を用意する</h2>

<p>本書では、「はじめに」で述べたように、Puppet の実行環境として Linux (Amazon Linux と CentOS) を使用します。といっても、いますぐ手元に、自分の自由になる Linux 環境を用意できないという読者も多いでしょう。</p>

<p>そこで、Puppet の実践に入る前に、まずは Vagrant というツールを使って、開発環境を用意してみましょう。</p>

<h3 id="vagrant-とは">Vagrant とは？</h3>

<p><a href="http://www.vagrantup.com/">Vagrant</a>は、<a href="https://www.virtualbox.org/">VirtualBox</a>や<a href="http://www.vmware.com/">VMware</a>、<a href="http://aws.amazon.com/ec2/">Amazon EC2</a>といった仮想化ツールを、簡単にコントロールするためのラッパツールです。元々は VirtualBox 専用に開発されたものでしたが、本書で使用するバージョン 1.1 以降は、<a href="http://docs.vagrantup.com/v2/providers/">Providers という仕組み</a>を導入したことで、プラグインによって VirtualBox 以外の仮想化ツールにも対応するようになりました。</p>

<p>本書では、これまで Vagrant での利用実績が豊富な VirtualBox を使っていくことにします。</p>

<p>ちなみに、Vagrant には Puppet と連携できる機能があり、仮想ホストの起動時や起動後に、指定した設定をもとに manifest を適用する仕組みがあります。しかし、本書は現場で使える Puppet 入門を目指しており、より実践的な方法を採るため、その機能は使いません。</p>

<h3 id="vagrant-のインストール">Vagrant のインストール</h3>

<p>まずは VirtualBox をインストールしましょう。<a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox のダウンロードページ</a>からお使いの環境にあったパッケージをダウンロードし、インストーラの指示に従ってインストールしてください。</p>

<p>VirtualBox のインストールが終わったら、今度は Vagrant をインストールします。<a href="http://downloads.vagrantup.com/">Vagrant のダウンロードページ</a>からお使いの環境にあったパッケージをダウンロードしてください。その際、本書の環境と合わせるため、1.1.0 以上のバージョンをダウンロードするようにしてください。その後、インストーラの指示に従ってインストールします。</p>

<h3 id="仮想ホストの起動">仮想ホストの起動</h3>

<p>Vagrant で利用できる仮想ホストのひな形 (box といいます) は、有志により様々なディストリビューションのものが用意されています <a href="http://www.vagrantbox.es/">http://www.vagrantbox.es/</a> 。また、Puppet 提供元の Puppet Labs からも、様々なディストリビューションの box が提供されています <a href="http://puppet-vagrant-boxes.puppetlabs.com/">http://puppet-vagrant-boxes.puppetlabs.com/</a> 。</p>

<p>本書では、Puppet Labs が提供する CentOS 6.4 の box を利用します。</p>

<p><a href="http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box">http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box</a></p>

<p>仮想ホストを起動するための設定は、非常に簡単です。適当なディレクトリで、以下のコマンドを実行します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant init</code></pre></figure>

<p>すると、コマンドを実行したディレクトリに <em>Vagrantfile</em> というファイルが作成されます。中を見てみるといろいろ書かれていますが、本書の範囲内で必要とする設定はわずかです。設定の詳細については <a href="http://docs.vagrantup.com/v2/">Vagrant のドキュメント</a>を見ていただくとして、ここではまず、以下の内容に変更してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Vagrant.configure("2") do |config|
   config.vm.box      = "centos-6.4-puppet"
   config.vm.box_url  = "http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box"
   config.vm.hostname = "puppet-book.local"
 end</code></pre></figure>

<p>このファイルでは、以下の設定を行っています。</p>

<ul>
  <li>仮想ホストに使用する box 名の指定</li>
  <li>box が存在しなかった場合に取得する先の URL</li>
  <li>仮想ホストの hostname の指定</li>
</ul>

<p>ファイルを作成したのと同じディレクトリで、<em>vagrant up</em> コマンドを実行すると、仮想ホストが起動します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant up
 Bringing machine 'default' up with 'virtualbox' provider...
 [default] Box 'centos-6.4-puppet' was not found. Fetching box from specified URL for
 the provider 'virtualbox'. Note that if the URL does not have
 a box for this provider, you should interrupt Vagrant now and add
 the box yourself. Otherwise Vagrant will attempt to download the
 full box prior to discovering this error.
 Downloading with Vagrant::Downloaders::HTTP...
 Downloading box: http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box
 Extracting box...
 Cleaning up downloaded box...
 Successfully added box 'centos-6.4-puppet' with provider 'virtualbox'!
 [default] Importing base box 'centos-6.4-puppet'...
 [default] Matching MAC address for NAT networking...
 [default] Setting the name of the VM...
 [default] Clearing any previously set forwarded ports...
 [default] Creating shared folders metadata...
 [default] Clearing any previously set network interfaces...
 [default] Preparing network interfaces based on configuration...
 [default] Forwarding ports...
 [default] -- 22 =&gt; 2222 (adapter 1)
 [default] Booting VM...
 [default] Waiting for VM to boot. This can take a few minutes.
 [default] VM booted and ready for use!
 [default] Setting hostname...
 [default] Configuring and enabling network interfaces...
 [default] Mounting shared folders...
 [default] -- /vagrant</code></pre></figure>

<p>以下、本書の説明を通じて、<em>vagrant</em> コマンドは、<em>Vagrantfile</em> のあるディレクトリで実行してください。</p>

<p>初回実行時には、box をダウンロードするために時間がかかりますが、次回からは既にダウンロードした box を使用するため、すぐに起動します。</p>

<h3 id="仮想ホストに-ssh-ログインする">仮想ホストに SSH ログインする</h3>

<p>以下のコマンドを実行すると、仮想ホストに SSH でログインできます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant ssh</code></pre></figure>

<p>また、のちの章では通常の ssh コマンドによるログインが必要になりますので、以下のようにコマンドを実行して、準備しておいてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant ssh-config --host puppet-book.local &gt;&gt; ~/.ssh/config</code></pre></figure>

<p>これで、いつものように ssh コマンドで仮想ホスト (ここでは puppet-book.local というホスト名を指定) にログインできます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ ssh puppet-book.local</code></pre></figure>

<p>ログインしたら、適当にコマンドを実行してみたりして、触ってみてください。ふだん使っている Linux と変わらない環境が簡単にできてしまったことに、驚くことでしょう。</p>

<p>また、あれこれといじってみた結果、たとえ壊してしまったとしても、後述の通り簡単にリセットして元通りにできますので、安心です。</p>

<h3 id="仮想ホストの停止破棄">仮想ホストの停止・破棄</h3>

<p>仮想ホストを停止するには <em>halt</em> サブコマンドを、破棄 (リセット) するには <em>destroy</em> サブコマンドを使います。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant halt</code></pre></figure>

<p>を実行すると一時停止、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant destroy</code></pre></figure>

<p>で破棄 (リセット) されます。再度、仮想ホストを起動したい場合は、最初と同じく</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant up</code></pre></figure>

<p>を実行してください。</p>

<p>Vagrant には、上記で紹介したものの他にもたくさんの便利なサブコマンドがありますが、本書の範囲内では、以上で十分です。より詳しく知りたい方は、<a href="http://docs.vagrantup.com/v2/cli/">Vagrant のドキュメント</a>を参照するとよいでしょう。</p>

<p>Vagrant を使うと、仮想ホストを <em>vagrant up</em> で起動し、あれこれいじった後に気に入らなくなってきたら <em>vagrant destroy</em> でまっさらなんてことも、簡単にできてしまいます。これから Puppet でこの仮想ホストをいじり倒していくには、もってこいの機能です。</p>

<p>manifest を書いていく途上で、何度も仮想ホストを作り直していくことになるでしょう。言葉を変えていえば、何度作り直しても manifest さえあればすぐに元通りになるという状態を作っていくことが「あるべき状態を記述する」ということになるのです。</p>

<h2 id="hello-puppet">Hello, Puppet!</h2>

<p>開発環境も整ったところで、さっそく Puppet を始めましょう。本章では、定番の “Hello, World!” を Puppet で実行してみます。さらに、もうすこし実践的な例として、Puppet を使ってパッケージをインストールする方法を紹介します。</p>

<p>まずはざっくりと、Puppet を使う最初の一歩を簡単な例から始めることにしましょう。</p>

<h3 id="puppet-のインストール">Puppet のインストール</h3>

<p>実は、前章で準備した Vagrant の仮想ホストには、最初から Puppet がインストールされています。そのため、Puppet を特別にインストールする必要はありません。<em>vagrant ssh</em> で仮想ホストにログインして、確かめてみましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ vagrant ssh
 Welcome to your Vagrant-built virtual machine.
 [vagrant@puppet-book ~]$ puppet --version
 3.1.1</code></pre></figure>

<p>本書執筆時点で最新のバージョン、3.1.1 が既に入っているのを確認できます。</p>

<p>以下、本書全体を通して、次の表記によりホスト OS 上と仮想ホスト上とでのコマンド実行を区別します (Vagrant を使わずに本書を読み進める場合は、適宜読み替えてください)。</p>

<ul>
  <li><em>$</em> のみで始まる行はホスト OS でのコマンド実行</li>
  <li><em>[vagrant@puppet-book ~]$</em> のように、<em>[vagrant@ホスト名 ディレクトリ名]$</em> から始まる行は仮想ホストでのコマンド実行</li>
</ul>

<p>本書の前提とする以外の、Puppet がインストールされていない環境では、以下のように <em>gem</em> コマンドによってインストールできます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book ~]$ sudo gem install puppet --no-rdoc --no-ri
 Successfully installed facter-1.6.18
 Successfully installed json_pure-1.7.7
 Successfully installed hiera-1.2.0
 Successfully installed puppet-3.1.1
 4 gems installed</code></pre></figure>

<p>ちなみに、Vagrant で起動した仮想ホストでは、デフォルトのログインユーザである <em>vagrant</em> ユーザが、パスワードの入力なしに <em>sudo</em> コマンドを実行できるよう設定されています。</p>

<h3 id="manifest-を置く場所">manifest を置く場所</h3>

<p>さて、さっそく manifest を書いていきましょう。とはいっても、どこにファイルを置けばいいのでしょうか。ここでも Vagrant がその便利さを発揮します。</p>

<p>仮想ホストにログインした状態で、<em>/vagrant</em> ディレクトリに移動し、<em>ls</em> コマンドを実行してみてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book ~]$ cd /vagrant
 [vagrant@puppet-book vagrant]$ ls
 Vagrantfile  puppet</code></pre></figure>

<p><em>Vagrantfile</em> が見えますね。Vagrant は、特に指定しなくても、仮想ホストの <em>/vagrant</em> ディレクトリに、ホスト OS 上の <em>Vagrantfile</em> のあるディレクトリをマウントしてくれます。また、サンプルコードを <em>git clone</em> した場合は、<em>puppet</em> ディレクトリも見えているはずです。</p>

<p>これから manifest を書いていく際は、ホスト OS 上でファイルの作成・編集を行い、Puppet の実行のみを仮想ホスト上で行うことにします。そうすることで、ファイルの編集をホスト OS 上でいつも使っているエディタで行いつつ、Puppet の実行は仮想ホストで、といったことが可能になり、とても便利です。</p>

<h3 id="manifest-を書いてみる">manifest を書いてみる</h3>

<p>まずはホスト OS 上で、manifest を置くためのディレクトリを作成しましょう。なお、このディレクトリの作成は必須ではなく、単純に、のちの章で作成するものとわけて置くほうが整理されていいだろうというだけの理由です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ mkdir -p puppet/hello_puppet
 $ cd puppet/hello_puppet/</code></pre></figure>

<p>次に、以下の内容で、<em>hello_world.pp</em> というファイルを作成します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> notice("Hello, World!")</code></pre></figure>

<p>このように、Puppet の manifest ファイルは、<em>.pp</em> という拡張子をつけることになっています。</p>

<h3 id="manifest-を適用する">manifest を適用する</h3>

<p>この manifest を適用してみましょう。今度は、仮想ホスト上で manifest ファイルのあるディレクトリに移動してから、<em>puppet apply</em> コマンドを実行します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book ~]$ cd /vagrant/puppet/hello_puppet/
 [vagrant@puppet-book hello_puppet]$ puppet apply hello_world.pp
 Notice: Scope(Class[main]): Hello, World!
 Notice: Finished catalog run in 0.03 seconds</code></pre></figure>

<p>“Hello, World!” と表示されています。簡単ですね。</p>

<h3 id="パッケージをインストールする">パッケージをインストールする</h3>

<p>さて、”Hello, World!” の表示からもう一歩すすんで、今度は実際にシステムの状態を変更する操作を行ってみましょう。ここでは zsh を、Puppet を使ってインストールします。</p>

<p>さきほどの <em>hello_world.pp</em> と同階層に、以下の内容で <em>zsh.pp</em> というファイルを作成してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> package { 'zsh':
   ensure =&gt; installed,
 }</code></pre></figure>

<p>今度は、新しく作成したファイルを引数にして <em>puppet apply</em> を実行します。今度は、ログの表示だけではなく、システムへの変更 (<em>yum</em> コマンドによるパッケージのインストール) も行うので、<em>sudo</em> 権限で実行する必要があります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book hello_puppet]$ sudo puppet apply zsh.pp
 Notice: /Stage[main]//Package[zsh]/ensure: created
 Notice: Finished catalog run in 9.76 seconds</code></pre></figure>

<p>意図した通り、zsh パッケージがインストールされたようですね。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book hello_puppet]$ which zsh
 /bin/zsh</code></pre></figure>

<p>ここで注目したいのは、CentOS 上でパッケージをインストールするに際して、<em>yum</em> コマンドのような、プラットフォーム固有のコマンドを指定していないということです。</p>

<p>Puppet には、RAL (Resouce Abstraction Layer) という仕組みがあり、プラットフォーム固有の事情を抽象化することで、差異を吸収してくれます。この仕組みのおかげで、どのプラットフォームに manifest を適用するかを気にすることなく、システム構成の記述という本質に注力することができるのです。</p>

<h3 id="manifest-の作成適用の流れ">manifest の作成・適用の流れ</h3>

<p>このように、Puppet で manifest を作成・適用する流れは、</p>

<ol>
  <li>適当な場所に manifest を書く</li>
  <li>manifest をシステムに適用する</li>
</ol>

<p>という流れを繰り返していくことに他なりません。のちのちの説明では、さらに規模の大きな manifest を書いていくために様々な記述方法を説明していきますが、本質的には上記の流れをくりかえしていくだけということに変わりありません。</p>

<p>どんどん書いて、どんどん <em>apply</em> していきましょう。</p>

<h3 id="function">Function</h3>

<p>さて、今回書いてみた manifest について、その中身をもうすこしくわしく見ていきましょう。”Hello, World!” を出力する箇所は、こういう内容でしたね。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> notice("Hello, World!")</code></pre></figure>

<p>この <em>notice</em> は、一般的な言語でいうところの「関数」と同じ働きをするもので、Puppet では function と呼ばれています。この <em>notice</em> のように、Puppet はあらかじめいくつかの function を提供しています。どのようなものがあるのか、その一覧については、以下のドキュメントをご参照ください。</p>

<p><a href="http://docs.puppetlabs.com/references/latest/function.html">http://docs.puppetlabs.com/references/latest/function.html</a></p>

<h3 id="resouce-type">Resouce Type</h3>

<p>zsh パッケージをインストールする箇所は、こうでした。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> package { 'zsh':
   ensure =&gt; installed,
 }</code></pre></figure>

<p>Puppet では、manifest によって記述する「システムのあるべき状態」を構成するひとつひとつを、resource と呼びます。ここでは <em>package</em> とそれに続く記述によって、zsh パッケージのインストールを行ってます。この場合の <em>package</em> を、resource の具体的な種類という意味で、resource type と呼びます。</p>

<p>resource type には、<em>package</em> 以外にも、たとえば <em>file</em> や <em>user</em> など、システムの構成要素の多様性に応じて、たくさんのものが用意されています。どのようなものがあるのか、その一覧については、以下のドキュメントをご参照ください。</p>

<p><a href="http://docs.puppetlabs.com/references/latest/type.html">http://docs.puppetlabs.com/references/latest/type.html</a></p>

<p>また、ここで <em>'zsh':</em> と記述されている箇所を title、<em>ensure =&gt; installed</em> を attributes といいます。title は、resource type を一意に決定するための名前を、attributes はどういう状態であるべきかを記述するために使われます。</p>

<p>実際に Puppet の manifest を書いて、”Hello, World!” を表示してみたり、パッケージをインストールしてみたりすることで、ひととおりの manifest の作成から、システムへの適用の流れまでを体験してみました。</p>

<p>また、今回書いた manifest には、function や resource type という、Puppet 言語の構成要素が使われていることも学びました。このように本書では、Puppet 言語の構成要素をまとめて網羅的に解説するというよりもむしろ、必要に応じて解説していきます。その方が、記憶への定着が行われやすいだろうからです。</p>

<h2 id="nginx-の-manifest-を書く">nginx の manifest を書く</h2>

<p>前章では、簡単な manifest を作成し、システムへ適用することを通して、Puppet での作業の流れを体験してみました。本章では、さらに実践的な manifest の作成に挑戦してみましょう。</p>

<p>今回取り上げるのは、HTTP サーバの <a href="http://nginx.org/">nginx</a> です。</p>

<h3 id="nginx-が使える状態とは">「nginx が使える状態」とは？</h3>

<p>CentOS に nginx をインストールし、実際に HTTP サーバとしてユーザからのリクエストに応答できるようにするまでのステップを、まずはあらためて考えてみましょう。</p>

<ol>
  <li>必要に応じて、yum パッケージを提供するリポジトリをシステムに登録する</li>
  <li><em>yum</em> コマンドを使って nginx をインストールする</li>
  <li>設定ファイルを記述する</li>
  <li>nginx を起動する</li>
  <li>nginx がシステム起動時に自動的に起動するよう設定する</li>
</ol>

<p>「nginx が使える状態」であるといえるためには、最低限これぐらいのことをする必要があります。実際、みなさんがこれまで nginx をシステムにインストールしてきた際には、同様のことを行ってきたことでしょう。</p>

<h3 id="manifest-に落とす">manifest に落とす</h3>

<p>次に、上記の 1 〜 5 を、manifest に落としていきます。まずは、本章で作成する manifest を置くためのディレクトリを作成しましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> $ cd puppet/
 $ mkdir nginx
 $ cd nginx/</code></pre></figure>

<p>以下の内容で、<em>nginx.pp</em> というファイルを作成してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> yumrepo { 'nginx':
   descr    =&gt; 'nginx yum repository',
   baseurl  =&gt; 'http://nginx.org/packages/centos/6/$basearch/',
   enabled  =&gt; 1,
   gpgcheck =&gt; 0,
 }

 package { 'nginx':
   ensure  =&gt; installed,
   require =&gt; Yumrepo['nginx'],
 }

 $port = 80

 file { '/etc/nginx/conf.d/my.conf':
   ensure  =&gt; present,
   owner   =&gt; 'root',
   group   =&gt; 'root',
   mode    =&gt; '0644',
   content =&gt; template('my.conf'),
   require =&gt; Package['nginx'],
   notify  =&gt; Service['nginx'],
 }

 $target = 'Puppet'

 file { '/usr/share/nginx/html/index.html':
   ensure  =&gt; present,
   owner   =&gt; 'root',
   group   =&gt; 'root',
   mode    =&gt; '0644',
   content =&gt; template('index.html'),
   require =&gt; Package['nginx'],
 }

 service { 'nginx':
   enable     =&gt; true,
   ensure     =&gt; running,
   hasrestart =&gt; true,
   require    =&gt; File['/etc/nginx/conf.d/my.conf'],
 }</code></pre></figure>

<h3 id="manifest-の内容">manifest の内容</h3>

<p>作成した manifest を、上から見ていきましょう。<em>package</em> については前章で紹介したので、省略します。今回はあらたに <em>yumrepo</em>、<em>file</em>、そして <em>service</em> という resource type が使われています。これら resource type についてはあとの章でより詳しく見ていきますので、ここでは簡単な説明にとどめます。</p>

<p><a href="http://docs.puppetlabs.com/references/latest/type.html#yumrepo">yumrepo</a> は、システムへの yum リポジトリの登録状態を記述するための resource type です。ここでは <a href="http://wiki.nginx.org/Install">nginx のインストールマニュアル</a>に掲載されている公式の yum リポジトリを登録し、使用可能な状態にしています。</p>

<p>ちなみに、ここでは <em>gpgcheck</em> を <em>0</em> とし、チェックしないよう設定していますが、これは nginx のリポジトリが GPG キーを提供していないためです。EPEL のように GPG キーを合わせて提供しているリポジトリを利用する場合は、極力 GPG キーのチェックも行うほうがよいでしょう。詳しくは「第 7 章 yum リポジトリを登録する - yumrepo」で解説します。</p>

<p><a href="http://docs.puppetlabs.com/references/latest/type.html#file">file</a> は、ファイルやディレクトリに関する resource type です。ファイルやディレクトリが、指定された attribute 通りに存在しする (あるいは存在しない) という状態を記述するために使います。<em>owner</em> や <em>group</em> などの各 attribute がどのような意味を持つかは、想像がつくでしょう。<em>template()</em>、および <em>require</em> と <em>notify</em> の各 Attribute については、後述します。</p>

<p><em>$port = 80</em> や <em>$target = 'Puppet'</em> という箇所は、見ての通り、変数への代入を行っています。Puppet ではこのように、manifest の中で変数を使えます。後述の <em>template()</em> といっしょに説明します。</p>

<p><a href="http://docs.puppetlabs.com/references/latest/type.html#service">service</a> は、今回の例の nginx のような、サービスを提供するデーモンのあるべき状態を記述するための resource type です。<em>enable</em> は、システム起動時にサービスとして起動するかどうかを、<em>ensure</em> は、常に起動した状態を保っているべきかどうかを記述するのに使います。nginx のようなデーモンは常に起動しておきたいのがふつうでしょうから、このように記述します。</p>

<h3 id="テンプレートを用意する">テンプレートを用意する</h3>

<p><em>yum</em> コマンドによってインストールされる nginx は、<em>/etc/nginx/conf.d/*.conf</em> をロードするよう設定されています。そこで、自分用にカスタマイズした設定を <em>/etc/nginx/conf.d/my.conf</em> として配置し、自動的にロードされるよう manifest を記述しています。その箇所をもう一度見てみましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> file { '/etc/nginx/conf.d/my.conf':
   ensure  =&gt; present,
   owner   =&gt; 'root',
   group   =&gt; 'root',
   mode    =&gt; '0644',
   content =&gt; template('my.conf'),
   require =&gt; Package['nginx'],
   notify  =&gt; Service['nginx'],
 }</code></pre></figure>

<p>ここでは <em>template()</em> という function を用いて、設定ファイルの内容を生成しています。ここであえて「生成」と述べたのにはわけがあります。<em>template()</em> は、引数に渡されたファイルの内容を、Ruby のテンプレートエンジン erb の形式で書かれたものとして評価し、その結果として生成された文字列を返す関数だからです。</p>

<p>以下の内容で、<em>my.conf</em> というファイルを <em>nginx.pp</em> と同じディレクトリに作成してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> server {
   listen       &lt;%= port %&gt;;
   server_name  localhost;

   location / {
     root  /usr/share/nginx/html;
     index index.html;
   }
 }</code></pre></figure>

<p>この <em>&lt;%= port %&gt;</em> の箇所が、erb の変数展開の記法として評価され、manifest で <em>$port = 80</em> と記述されている内容がうめこまれます。</p>

<p>同様に、<em>index.html</em> というファイルを、以下の通り作成してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> Hello, &lt;%= target %&gt;!</code></pre></figure>

<p>このファイル内の <em>&lt;%= target %&gt;</em> も、同名変数 <em>$target</em> の値に展開されます。</p>

<h3 id="manifest-を適用する-1">manifest を適用する</h3>

<p>さて、manifest を作成したら、システムに適用してみましょう。今回は前回と違ってテンプレートも使うので、<em>puppet apply</em> コマンド実行時に、<em>–templatedir</em> オプションでカレントディレクトリ (<em>.</em>) を指定します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book ~]$ cd /vagrant/puppet/nginx
 [vagrant@puppet-book nginx]$ sudo puppet apply --templatedir=. nginx.pp
 Notice: /Stage[main]//Yumrepo[nginx]/descr: descr changed '' to 'nginx yum repository'
 Notice: /Stage[main]//Yumrepo[nginx]/baseurl: baseurl changed '' to 'http://nginx.org/packages/centos/6/$basearch/'
 Notice: /Stage[main]//Yumrepo[nginx]/enabled: enabled changed '' to '1'
 Notice: /Stage[main]//Yumrepo[nginx]/gpgcheck: gpgcheck changed '' to '0'Notice: /Stage[main]//Package[nginx]/ensure: created
 Notice: /Stage[main]//File[/usr/share/nginx/html/index.html]/content: content changed '{md5}e3eb0a1df437f3f97a64aca5952c8ea0' to '{md5}1db16ebfb21d376e5b2ae9d1eaf5b3c8'
 Notice: /Stage[main]//File[/etc/nginx/conf.d/my.conf]/ensure: created
 Notice: /Stage[main]//Service[nginx]/ensure: ensure changed 'stopped' to 'running'
 Notice: /Stage[main]//Service[nginx]: Triggered 'refresh' from 1 events
 Notice: Finished catalog run in 33.69 seconds</code></pre></figure>

<p>エラーなく終了したら、nginx が実際に起動しているかどうか、確認してみましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [vagrant@puppet-book nginx]$ curl http://localhost:80/
 Hello, Puppet!</code></pre></figure>

<p>変数に代入した値がきちんと展開された文字列が、nginx によって返されました。</p>

<h3 id="relationship">Relationship</h3>

<p>さて、nginx の manifest を無事に適用できたところで、説明を先送りにした <em>require</em> と <em>notify</em> について、見ていきましょう。</p>

<p>今回は、<em>yumrepo</em>、<em>package</em>、<em>file</em>、<em>service</em> という、4 つの resource type を使って manifest を記述しました。それぞれの resource type によって記述された resource は、任意の順番で個別に存在するのはなく、次の順番で依存関係を持っています。</p>

<ol>
  <li>yum リポジトリを登録する</li>
  <li>nginx パッケージをインストールする</li>
  <li>設定ファイルを配置する</li>
  <li>サービスを起動する</li>
</ol>

<p>1 から 4 までが順番通りに実行されないと、正しく nginx を起動できません。このような依存関係のことを dependency relationship と呼び、<em>require</em> によって記述します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> package { 'nginx':
   ensure  =&gt; installed,
   require =&gt; Yumrepo['nginx'],
 }</code></pre></figure>

<p>これは、nginx パッケージをインストールする前に、nginx の yum リポジトリを登録する必要がある、ということを意味します。</p>

<p>「関係」にはもうひとつ種類があります。nginx のインストール時のみならず、nginx の設定ファイルを変更した場合にも、nginx にその設定を再読み込みさせる必要があります。このような、ある resource の変更にともなって再読み込みのようなアクションが必要となる関係を refresh relationship と呼び、<em>notify</em> によって記述します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> file { '/etc/nginx/conf.d/my.conf':
   ensure  =&gt; present,
   owner   =&gt; 'root',
   group   =&gt; 'root',
   mode    =&gt; '0644',
   content =&gt; template('my.conf'),
   require =&gt; Package['nginx'],
   notify  =&gt; Service['nginx'],
 }</code></pre></figure>

<p>Puppet の manifest は、ファイル内の記述順で処理が実行されるわけではありません。Puppet 言語は、これまで何度も述べている通り「システムのあるべき状態」を記述するためのものですから、ファイル内での記述の順序によって実行順が変わるのは好ましくありません。今回行ったように、明示的に relationship を記述してやる必要があります。</p>

<h3 id="resource-reference">Resource Reference</h3>

<p>上記で、<em>package</em> を宣言する際にはすべて小文字で書いていた一方で、<em>require</em> によって依存関係を記述する際には <em>Package[‘nginx’]</em> と、最初の 1 文字を大文字で書いていたことに気付いたでしょうか？</p>

<p>このように、resource の宣言時にはすべて小文字を使い、relationship のある resource への参照時には、最初の文字を大文字にした名前を使います。他の resource への参照を、resource reference と呼びます。宣言時はすべて小文字で、それ以外は最初の 1 文字を大文字にする、と憶えておいてください。</p>

<p>すこし大変だったかもしれませんが、ここで学んだことをきちんと理解しておけば、Puppet の本質の、多くの部分を把握したことになります。本章をよく読み返してみて、いまいちど理解を確かめてみてください。</p>

<h2 id="完全版の入手方法">完全版の入手方法</h2>
<p><img class="right" src="https://images-fe.ssl-images-amazon.com/images/I/31pxYolccUL._SL160_.jpg" /></p>

<p>今回るびまでご紹介したのは全 23 章の中の 5 章分です。電子書籍版では td-agent のインストールから serverspec の使い方まで、実践的に使える内容が多数含まれています。本書は puppet を用いてシステムの構成管理を行う際に必要とされるものを網羅している唯一の日本語の書籍と言っても過言ではありません。本書が皆さんのソフトウェア開発の手助けとなれば幸いです。</p>

<p>本書は以下の電子書籍販売サイトより購入可能です。</p>

<ul>
  <li><a href="http://p.booklog.jp/book/70667">ブクログのパブー</a></li>
  <li><a href="http://tatsu-zine.com/books/puppet">達人出版会</a></li>
  <li><a href="http://www.amazon.co.jp/dp/B00CL92JC0">Amazon.co.jp</a></li>
</ul>

<h2 id="筆者について">筆者について</h2>

<p>栗林健太郎。ネット上では「antipop/kentaro/あんちぽ」として知られる。市役所職員、株式会社はてな勤務を経て、現在は株式会社 paperboy&amp;co. で技術基盤整備エンジニアとして勤務。Perl Monger で Rubyist、時々ぺちぱー。 <a href="http://kentarok.org/">http://kentarok.org/</a></p>


                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
