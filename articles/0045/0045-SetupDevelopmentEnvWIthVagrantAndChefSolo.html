<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>vagrantとchef-soloを使った開発環境の構築</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0045/0045-SetupDevelopmentEnvWIthVagrantAndChefSolo.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>vagrantとchef-soloを使った開発環境の構築</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=vagrantとchef-soloを使った開発環境の構築&amp;url=https://magazine.rubyist.net/articles/0045/0045-SetupDevelopmentEnvWIthVagrantAndChefSolo.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0045/0045-SetupDevelopmentEnvWIthVagrantAndChefSolo.html&amp;t=vagrantとchef-soloを使った開発環境の構築" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0045/0045-SetupDevelopmentEnvWIthVagrantAndChefSolo.html&amp;vagrantとchef-soloを使った開発環境の構築" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        <div class="post_info">
                            



                        </div>
                        
<h2 id="vagrant-と-chef-solo-を使った開発環境の構築">vagrant と chef-solo を使った開発環境の構築</h2>

<ul id="markdown-toc">
  <li><a href="#vagrant-と-chef-solo-を使った開発環境の構築" id="markdown-toc-vagrant-と-chef-solo-を使った開発環境の構築">vagrant と chef-solo を使った開発環境の構築</a>    <ul>
      <li><a href="#はじめに" id="markdown-toc-はじめに">はじめに</a></li>
      <li><a href="#vagrant-について" id="markdown-toc-vagrant-について">vagrant について</a></li>
      <li><a href="#chef-solo-について" id="markdown-toc-chef-solo-について">chef-solo について</a>        <ul>
          <li><a href="#なぜchef-soloを採用したのか" id="markdown-toc-なぜchef-soloを採用したのか">なぜchef-soloを採用したのか</a></li>
          <li><a href="#berkshelfについて" id="markdown-toc-berkshelfについて">Berkshelfについて</a></li>
        </ul>
      </li>
      <li><a href="#vagrantとchef-soloを使った環境構築を行う前に" id="markdown-toc-vagrantとchef-soloを使った環境構築を行う前に">vagrantとchef-soloを使った環境構築を行う前に</a>        <ul>
          <li><a href="#なぜvagrantchef-soloを使って環境構築を行うのか" id="markdown-toc-なぜvagrantchef-soloを使って環境構築を行うのか">なぜvagrant、chef-soloを使って環境構築を行うのか</a></li>
          <li><a href="#vagrantとchef-soloを使うための前提条件" id="markdown-toc-vagrantとchef-soloを使うための前提条件">vagrantとchef-soloを使うための前提条件</a></li>
        </ul>
      </li>
      <li><a href="#vagrantとchef-soloを使った環境構築の準備" id="markdown-toc-vagrantとchef-soloを使った環境構築の準備">vagrantとchef-soloを使った環境構築の準備</a>        <ul>
          <li><a href="#ローカルマシンの環境を整える" id="markdown-toc-ローカルマシンの環境を整える">ローカルマシンの環境を整える</a>            <ul>
              <li><a href="#rubyのインストール" id="markdown-toc-rubyのインストール">Rubyのインストール</a></li>
              <li><a href="#vagrantのインストール" id="markdown-toc-vagrantのインストール">vagrantのインストール</a></li>
              <li><a href="#boxファイルの準備" id="markdown-toc-boxファイルの準備">boxファイルの準備</a></li>
            </ul>
          </li>
          <li><a href="#vagrantの準備" id="markdown-toc-vagrantの準備">vagrantの準備</a></li>
          <li><a href="#chef-soloの準備" id="markdown-toc-chef-soloの準備">chef-soloの準備</a>            <ul>
              <li><a href="#クックブックの分割" id="markdown-toc-クックブックの分割">クックブックの分割</a></li>
              <li><a href="#暗号化" id="markdown-toc-暗号化">暗号化</a></li>
            </ul>
          </li>
          <li><a href="#クックブックの書き方" id="markdown-toc-クックブックの書き方">クックブックの書き方</a>            <ul>
              <li><a href="#gheのリポジトリやgithubのプライベートリポジトリからクローンしてくる" id="markdown-toc-gheのリポジトリやgithubのプライベートリポジトリからクローンしてくる">GH:EのリポジトリやGitHubのプライベートリポジトリからクローンしてくる</a></li>
            </ul>
          </li>
          <li><a href="#作ったクックブックをberkshelfに登録しvmを立ち上げる" id="markdown-toc-作ったクックブックをberkshelfに登録しvmを立ち上げる">作ったクックブックをberkshelfに登録し、VMを立ち上げる</a></li>
        </ul>
      </li>
      <li><a href="#実際に環境を構築してもらう" id="markdown-toc-実際に環境を構築してもらう">実際に環境を構築してもらう</a>        <ul>
          <li><a href="#起こりえるトラブル" id="markdown-toc-起こりえるトラブル">起こりえるトラブル</a>            <ul>
              <li><a href="#segv" id="markdown-toc-segv">SEGV</a></li>
              <li><a href="#クックブックを修正した場合" id="markdown-toc-クックブックを修正した場合">クックブックを修正した場合</a></li>
              <li><a href="#立ち上げた仮想マシンのシャットダウンホストマシンのシャットダウン" id="markdown-toc-立ち上げた仮想マシンのシャットダウンホストマシンのシャットダウン">立ち上げた仮想マシンのシャットダウン、ホストマシンのシャットダウン</a></li>
              <li><a href="#git-cloneが終わらない巨大なリポジトリの場合" id="markdown-toc-git-cloneが終わらない巨大なリポジトリの場合">git cloneが終わらない(巨大なリポジトリの場合)</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#まとめ" id="markdown-toc-まとめ">まとめ</a></li>
      <li><a href="#筆者について" id="markdown-toc-筆者について">筆者について</a></li>
    </ul>
  </li>
</ul>

<hr />

<dl>
  <dt>対象読者</dt>
  <dd>初心者〜中級者</dd>
</dl>

<h3 id="はじめに">はじめに</h3>

<p>開発環境の構築は、アプリを作る上で重要ですが、楽をしたい作業です。<br />
ただし、開発環境構築で手を抜き、チームメンバー間で環境の差異がでてしまった場合、問題があった時の切り分けが困難になってしまいます。<br />
そこで、チームのメンバーが同じ環境を簡単に作れるように、vagrant と chef-solo を使った開発環境の構築についてご紹介したいと思います。</p>

<h3 id="vagrant-について">vagrant について</h3>

<p><a href="http://www.vagrantup.com/">vagrant</a> は、仮想マシン (バーチャルマシン、以降は VM とします) をプログラマブルに作成/破棄できるツールです。<br />
vagrant はプラグイン機構をもっており、プラグインにより vagrant を拡張することができます。<br />
操作出来る VM は VirtualBox が基本なのですが、有料ですが VMware をサポートしている vagrant も公開されています (<a href="http://www.vagrantup.com/vmware">VMware Vagrant Environments</a>)。<br />
その他にも色々なプラットフォームが操作できるようなプラグインが配布されています
(<a href="https://github.com/mitchellh/vagrant/wiki/Available-Vagrant-Plugins">Available Vagrant Plugins</a>)。</p>

<h3 id="chef-solo-について">chef-solo について</h3>

<p>chef-solo は <a href="http://www.opscode.com/chef/">chef</a> というツールに同梱されている、プロビジョニングツールです。<br />
プロビジョニングツールとは、サーバー構築・管理を自動化するツールです。<br />
chefはサーバークライント構成をとって、サーバーの構成管理をおこなっていますが、chef-soloはサーバークライント構成を使わず、単体でプロビジョニングを行うことができるツールです。<br />
プロビジョニングツールには、chef以外にも、puppetなどが挙げられます。<br /></p>

<h4 id="なぜchef-soloを採用したのか">なぜchef-soloを採用したのか</h4>

<p>上記でも紹介したとおり、プロビジョニングツールはchef以外にも色々ありますが、その中でchefを選んだ理由は、</p>

<ul>
  <li>私自身がchefに慣れていたこと</li>
  <li>私の周りにchefを知っている人が多かったこと</li>
</ul>

<p>くらいです。<br />
ですので、特にchefを勧めるわけではありません。<br />
chef以外に慣れているプロビジョニングツールがあれば、それを採用することをおすすめします。<br />
ただし、vagrantと連携できるプラグインがあるかどうかは確認しておいて下さい。(もしなければ、自分でプラグインを書くことになるでしょう)<br />
vagrantには、chefとpuppetを実行するためにプラグインが予め同梱されています。<br /></p>

<h4 id="berkshelfについて">Berkshelfについて</h4>

<p>Berkshelfは、chefで使うクックブックを管理するgemです。<br />
必要なクックブックを、設定に従って集めて来てくれます。  <br />
設定はBerksfileというファイルに下記のように書きます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">cookbook 'sudo', git: 'git@github.com:opscode-cookbooks/sudo.git'
cookbook 'hoge', git: 'git@github.com:SpringMT/hoge.git'</code></pre></figure>

<p>bundlerとGemfileと同じような関係ですね。<br />
ここに、使用するクックブックを列挙しておくと、プライベートgit、chef server、ローカルのファイルなどからBerkshelfが自動的にクックブックを集めてきてくれます。<br />
Berkshelfを使うことによって、クックブックを分割して管理することができ、再利用性が高まるので、chefを使う際はオススメです。<br /></p>

<h3 id="vagrantとchef-soloを使った環境構築を行う前に">vagrantとchef-soloを使った環境構築を行う前に</h3>

<p>まず、vagrantとchef-soloを使う前に、これらツールを使う理由を整理しましょう。</p>

<h4 id="なぜvagrantchef-soloを使って環境構築を行うのか">なぜvagrant、chef-soloを使って環境構築を行うのか</h4>

<p>開発環境を構築するために、なぜvagrant、chef-soloを使うのでしょうか。<br />
vagrantを使うということは、自分のマシンにVMを立ち上げることになり、もう一台マシンが走っていることになります。<br />
その分だけ、ホストマシンに負荷がかかり動作が重くなるのは明白です。<br />
ですので、私個人の意見としては、開発環境構築にvagrantを使ってVMを立ち上げるよりは、ホストマシンだけで開発環境を構築できるのであれば、そうするべきだと思っています。<br /></p>

<p>現在、Macを使っていれば、Homebrewなどを使って様々なミドルウェアをインストールすることができます。<br />
また、Macであればローカルマシンの環境構築には<a href="http://boxen.github.com/">boxen</a>を使うこともできます。</p>

<p>ではなぜ、今回vagrantを使ってVMを立ち上げることを選択したのでしょうか。<br />
それには、下記のようなローカルの環境では設定しにくい要因があったためです。</p>

<ul>
  <li>特定のユーザーでなければ動かないアプリ</li>
  <li>特定のホスト名を設定しておかないと動かないアプリ</li>
  <li>rootユーザーでしか作れないような、特定のディレクトリ構造が必要なアプリ</li>
</ul>

<p>上記のようなことをローカルマシンで実現できないわけではないのですが、ローカルマシンへの影響が大きすぎるため、vagrantとchef-soloを使ってVM上に環境構築することにしました。<br /></p>

<h4 id="vagrantとchef-soloを使うための前提条件">vagrantとchef-soloを使うための前提条件</h4>

<p>vagrantは、Mac、windows、Linuxの環境全て動きます。<br />
ただし、今回私が試した環境はMacのみなので、それ以外のOSでは動作確認をしていません。</p>

<h3 id="vagrantとchef-soloを使った環境構築の準備">vagrantとchef-soloを使った環境構築の準備</h3>

<p>まず、vagrantとchef-soloを動かす設定を作ります。</p>

<h4 id="ローカルマシンの環境を整える">ローカルマシンの環境を整える</h4>

<h5 id="rubyのインストール">Rubyのインストール</h5>

<p>ここではRubyのインストールの仕方については細かく説明しません。<br />
rbenvやrvmを使ってインストールすることをおすすめします。<br />
るびまでも紹介されているので参考になると思います。</p>

<ul>
  <li><a href="../../articles/first_step_ruby/FirstStepRuby.html">FirstStepRuby</a></li>
</ul>

<h5 id="vagrantのインストール">vagrantのインストール</h5>

<p>gemで配布されているvagrantは__使ってはいけません__。(rubygemsに登録されているvagrantはバージョンがかなり古いです) <br />
vagrantは、下記ページからOSにあったファイルをダウンロードしてインストールして下さい。<br />
Macの場合はdmgですね。</p>

<ul>
  <li><a href="http://downloads.vagrantup.com/">http://downloads.vagrantup.com/</a></li>
</ul>

<p>vagrantのインストールが完了すれば、vagrantコマンドが使えます。<br />
vagrantコマンドを使って、Berkshelfと連携するプラグインをインストールしておきましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">vagrant plugin install vagrant-berkshelf</code></pre></figure>

<p>chef-soloと連携するプラグインはvagrantに同梱されているので、特にプラグインのインストールは不要です。<br />
他にも使いたいプラグインがあれば、各々インストールしてください。</p>

<h5 id="boxファイルの準備">boxファイルの準備</h5>

<p>boxファイルは、vagrantでVMを立ち上げるためのベースとなるファイルです。<br />
vagrantのサイトで公開されているものもありますが、その中に自分が使いたいboxファイルがない場合や、個人で公開している野良boxファイルしか見つからず、自前でboxファイルを用意する必要がある場合があるかと思います。</p>

<p>boxファイルを作ることになる場合、<a href="https://github.com/jedi4ever/veewee">veewee</a>というツールを使うことがお勧めです。<br />
boxファイルを作る際は、boxファイルは極力シンプルにしておくと良いと思います。<br />
多くの人が使える状態にしておき、あとで、chef-soloで自分の好きな状態にするのが良いでしょう。</p>

<p>さて、作ってboxファイルの共有はどうしましょう。<br />
コピーして渡すには容量がそれなりに大きく、会社によってはUSBを使った共有もできない場合もあります。<br />
実は、ここが結構困ったところですが、結局自分はチームの全員がアクセスできるファイルサーバーにおいて、そこからダウンロードしてもらっています。<br /></p>

<h4 id="vagrantの準備">vagrantの準備</h4>

<p>vagrantがインストールできていれば、vagrantコマンドが使えると思います。<br />
まず、vagrantの設定ファイルを格納するディレクトリを作って、そこでvagrant initを行います。<br />
更に、boxファイルをvagrantに登録します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mkdir [vagrant dir]
cd [vagrant dir]
vagrant init
vagrant box add 'vagrantに登録する名前' 'boxファイルのパス'</code></pre></figure>

<p>ここで、_Vagrantfile_というファイルができていることを確認してください。<br />
Vagrantfileのサンプルは下記のとおりです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">VAGRANTFILE_API_VERSION = "2"
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.box = "vagrant box addで登録したboxファイルの名前"
  # berkshelfを使うのでtrue
  config.berkshelf.enabled = true
  # hostnameの設定が必要であれば設定可能
  config.vm.hostname = 'test'
  # chefの設定
  config.vm.provision :chef_solo do |chef|
      chef.run_list = [
      # 使うクックブックを列挙しておく
      "sample",
    ]
  end
end</code></pre></figure>

<p>他にも、私の場合は、ネットワークの設定やsynced_folderの設定をしていますが、上記の設定だけでも十分に稼働可能です。　　</p>

<h4 id="chef-soloの準備">chef-soloの準備</h4>

<p>まず、chefを使うための準備を行います。
chef本体と、chefのクックブックを作るためのツールknife-soloをインストールします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">gem install chef
gem install knife-solo</code></pre></figure>

<p>もちろん、bundler経由からインストールしても問題ありません。<br />
インストールが完了したら、vagrant initしたディレクトリで下記コマンドを実行します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">knife solo init .</code></pre></figure>

<p>そうすると、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">.
├── Berksfile
├── Vagrantfile
├── cookbooks
├── data_bags
├── environments
├── nodes
├── roles
└── site-cookbooks</code></pre></figure>

<p>こんな感じにディレクトリが作られると思います。<br />
それぞれの説明はchefを解説しているブログ等に譲りますが、ここで幾つか自分が取った方針について紹介しようと思います。</p>

<h5 id="クックブックの分割">クックブックの分割</h5>

<p>クックブックの再利用が困難になるため、site-cookbooksの中にはクックブックをほとんど入れませんでした。<br />
なるべく最小の単位でクックブックで作り、クックブックはそれぞれレポジトリを作って管理しました。<br />
それらを、Berkshelfでまとめて使えるようにしています。  <br />
クックブックは、誰でも使える場所に公開しておき、再利用可能な状態にしておくことで、他に使いたい人が再発明しなくてすみます。</p>

<p>site-cookbooksに入れたクックブックは、作りたい環境特有の設定を行うためのクックブックのみになっています。(このクックブックも、あとでシェアできるようになるべく分割しています)</p>

<h5 id="暗号化">暗号化</h5>

<p>chefには、data_bagという仕組みを使って、公開したくないデータを暗号化して配布する方法があります。(パスワードなど)
しかし、今回はその方法を採用しませんでした。
その理由としては、下記二点がありました。</p>

<ul>
  <li>鍵の配布が手間</li>
  <li>開発環境の構築のみなので、パスワード等の暗号化は特に必要ないものだった</li>
</ul>

<p>鍵の配布は特に手間になるので暗号化したい場合は、鍵の配布の方法も合わせて考える必要があります。<br />
しかし、チームのほとんどが同じ鍵を持つことになるので、特に暗号化する必要がないと思い、今回は特に暗号化をしませんでした。</p>

<h4 id="クックブックの書き方">クックブックの書き方</h4>

<p>ほとんどのクックブックは出回ってるクックブックと同じ書き方をしていますが、GH:EのリポジトリやGitHubのプライベートリポジトリをcloneしてくる部分が大分ハマったので、ここで紹介できればと思います。</p>

<h6 id="gheのリポジトリやgithubのプライベートリポジトリからクローンしてくる">GH:EのリポジトリやGitHubのプライベートリポジトリからクローンしてくる</h6>

<p>これは、ローカルマシンとvagrantとの連携技になります。<br />
まず、Vagrantfileの設定で、sshのforward_agentをtrueにしてください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">VAGRANTFILE_API_VERSION = "2"
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  .
  config.ssh.forward_agent = true
  .
end</code></pre></figure>

<p>次に、ローカルマシンの<code class="highlighter-rouge">ssh/config</code>の設定を行ってください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Host [GH:Eのhostやgithub.com]
ForwardAgent yes</code></pre></figure>

<p>ローカルマシンで、ssh-agentにGH:EもしくはGitHubで使ってる鍵を登録してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ssh-add ~/.ssh/id_rsa
# 登録できているか確認
ssh-add -l</code></pre></figure>

<p>この設定で、VMから__vagrantユーザー__が、ローカルマシンのssh agent経由でGH:EやGitHubのプライベートリポジトリからgit cloneすることができます。<br />
ただし、このままだとVMからcloneするときにwarnningメッセージがでて実行が止まってしまうので、vagrantユーザーの.ssh/configに下記の設定を反映できるようなクックブックを書いて実行できるようにしておいてください。<br />
サンプルはこちらです。</p>

<ul>
  <li>recipie</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">directory "#{node['vagrant']['tmp_vagrant_path']}" do
  owner "vagrant"
  group "vagrant"
  mode  "2775"
  recursive true
end
template "/home/vagrant/.ssh/config" do
  source "ssh.config.erb"
  mode   "0600"
  owner  "vagrant"
  group  "vagrant"
end</code></pre></figure>

<ul>
  <li>template</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Host [GH:Eのhostやgithub.com]
  StrictHostKeyChecking no</code></pre></figure>

<p>ここまで行うと、vagrantユーザーでgit cloneすることができます。<br />
ただ、このままでは、cloneしたディレクトリがvagrantユーザーになってしまうので、一旦git cloneした後に、cloneしてきたリポジトリをmvで移動したり、ユーザーを変えたりする必要があります。<br />
クックブックで表現すると下記のようになるかと思います。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">git "#{tmp_vagrant_path}/test" do
  repository "git@github.hoge.jp:test/test.git"
  revision   "master"
  user       "vagrant"
  group      "vagrant"
  action     :checkout
  not_if     "test -d /home/user/test"
end
execute "chown hoge at test" do
  command "chown -R hoge:hoge #{tmp_vagrant_path}/test"
  not_if "test -d /home/user/test"
end
execute "mv test" do
  command "mv #{tmp_vagrant_path}/test /home/hoge/"
  not_if "test -d /home/user/test"
end</code></pre></figure>

<p>この他に方法が無いかと色々試したのですが、この方法以外しか見つからず。。。<br />
他にいい方法があれば、ぜひご教授頂きたいです！！</p>

<h4 id="作ったクックブックをberkshelfに登録しvmを立ち上げる">作ったクックブックをberkshelfに登録し、VMを立ち上げる</h4>

<p>ここまで、準備ができたら、Berksfileに作成したクックブックを設定し、<code class="highlighter-rouge">berks install</code>を実行してください。<br />
その後に、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">vagrant up</code></pre></figure>

<p>を行えば、VMが立ち上がります。</p>

<h3 id="実際に環境を構築してもらう">実際に環境を構築してもらう</h3>

<p>ここまでできたら、他に人にも使ってもらえる準備が整いました。<br />
以下には、使ってもらったときに起きたトラブルとその解消方法を紹介します。</p>

<h4 id="起こりえるトラブル">起こりえるトラブル</h4>

<h5 id="segv">SEGV</h5>

<p>vagrant upを実行中、結構な頻度でSEGVで落ちます。
<img src="../../images/0045-SetupDevelopmentEnvWIthVagrantAndChefSolo/vagrant-dot_error.jpeg" alt="vagrant-dot_error.jpeg" /></p>

<p>この場合は、vagrant provisionを実行して再度chefを実行しましょう。<br />
(クックブックは冪等性を担保していることが前提となります。)</p>

<h5 id="クックブックを修正した場合">クックブックを修正した場合</h5>

<p>環境を更新するために、クックブックを修正することが多々あると思います。<br />
クックブックを修正したら、vagrantを管理しているディレクトリで<code class="highlighter-rouge">berks update</code> を実行してBerksfile.lockを更新しましょう(よく忘れます。。。。)。<br />
Berksfile.lockを更新したら、使ってる人たちに連絡してberks installしてもらい、vagrant provisionを実行してもらい新しいクックブックを適用しましょう。</p>

<h5 id="立ち上げた仮想マシンのシャットダウンホストマシンのシャットダウン">立ち上げた仮想マシンのシャットダウン、ホストマシンのシャットダウン</h5>

<p>vagrant haltすると、VMがsymbol lookup errorがでて立ち上がらなくなることがあります。一旦止めたいときはvagrant suspendで行うことを推奨します。<br />
また、いきなりホストマシンを落とすと恐らくvagrant haltと同じ現象が起こり、立ち上がらなくなる場合があります。<br />
ホストマシンを落とすときは、一旦vagrant suspendしてからホストマシンを落とすとよいでしょう。</p>

<h5 id="git-cloneが終わらない巨大なリポジトリの場合">git cloneが終わらない(巨大なリポジトリの場合)</h5>

<p>ウンGレベルまで肥大化した深淵なリポジトリをcloneする場合、timeoutすることがあります(デフォルトは300 sec)。<br />
この場合、boot_timeoutの値を伸ばしてあげましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">VAGRANTFILE_API_VERSION = "2"
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  .
  config.vm.boot_timeout = 3600
  .
end</code></pre></figure>

<p>もともとはssh.timeoutだったのですが、名前が変わってハマりました。。。</p>

<ul>
  <li><a href="https://github.com/mitchellh/vagrant/commit/5a4c06f75e2fc727a17152a959a7a64992049137">変更されたコミット</a></li>
</ul>

<h3 id="まとめ">まとめ</h3>

<p>開発環境構築はチームで開発を行う上で重要ではありますが、あまり時間を掛けたくないものです。<br />
この記事で、少しでも開発環境構築が楽になればと思います。</p>

<h3 id="筆者について">筆者について</h3>

<p>春山 誠 (<a href="https://twitter.com/Spring_MT">@Spring_MT</a>)<br />
Fukuoka.rb所属(だったんですが、東京に引っ越したので現在は不定)<br />
Perlがメインの会社にいますが、今は主にRuby書いてます。</p>


                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
