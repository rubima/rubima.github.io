<!DOCTYPE html>
<html>
  



  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CGIKit、TapKit を利用した Web アプリケーションの作成</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">

  <link rel="canonical" href="http://magazine.rubyist.net/articles/0005/0005-CGIKit.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="http://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>CGIKit、TapKit を利用した Web アプリケーションの作成</h1>
                        <div class="social-buttons">
                            <a href="http://b.hatena.ne.jp/entry//articles/0005/0005-CGIKit.html" class="hatena-bookmark-button" data-hatena-bookmark-title="CGIKit、TapKit を利用した Web アプリケーションの作成" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
<span id="fb-root"></span>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.5";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<span class="fb-like" data-href="/articles/0005/0005-CGIKit.html" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></span>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="/articles/0005/0005-CGIKit.html" data-text="CGIKit、TapKit を利用した Web アプリケーションの作成">ツイート</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

                        </div>
                        
<p>著者：喜多川 豪　編集：かずひこ</p>

<h2 id="cgikittapkit-を利用した-web-アプリケーションの作成">CGIKit、TapKit を利用した Web アプリケーションの作成</h2>

<ul id="markdown-toc">
  <li><a href="#cgikittapkit-を利用した-web-アプリケーションの作成" id="markdown-toc-cgikittapkit-を利用した-web-アプリケーションの作成">CGIKit、TapKit を利用した Web アプリケーションの作成</a>    <ul>
      <li><a href="#1-はじめに" id="markdown-toc-1-はじめに">1. はじめに</a></li>
      <li><a href="#2-cgikit-とは" id="markdown-toc-2-cgikit-とは">2. CGIKit とは？</a></li>
      <li><a href="#3-tapkit-とは" id="markdown-toc-3-tapkit-とは">3. TapKit とは？</a></li>
      <li><a href="#4-webアプリケーションを作ってみる" id="markdown-toc-4-webアプリケーションを作ってみる">4. Webアプリケーションを作ってみる</a></li>
      <li><a href="#5-準備" id="markdown-toc-5-準備">5. 準備</a></li>
      <li><a href="#6-コンポーネントの作成" id="markdown-toc-6-コンポーネントの作成">6. コンポーネントの作成</a></li>
      <li><a href="#7-モデルファイルの作成" id="markdown-toc-7-モデルファイルの作成">7. モデルファイルの作成</a></li>
      <li><a href="#8-tapkit-オブジェクト用クラス" id="markdown-toc-8-tapkit-オブジェクト用クラス">8. TapKit オブジェクト用クラス</a></li>
      <li><a href="#9-まとめ" id="markdown-toc-9-まとめ">9. まとめ</a></li>
      <li><a href="#著者について" id="markdown-toc-著者について">著者について</a></li>
    </ul>
  </li>
</ul>

<h3 id="1-はじめに">1. はじめに</h3>

<p>Ruby で CGI を作成した事がある方は判るかと思いますが、Ruby には cgi.rb というライブラリが標準で利用する事が出来ます。
cgi.rb でコードの再利用やテンプレートとロジックの分離等を行うためには自前でライブラリを書いたりする必要があります。
また、バックエンドにデータベースを利用する場合、なるべくロジックからはデータベースを意識しないようなコードを書きたくなります。</p>

<p>これらの問題を解消する手段として、本記事では Web アプリケーションフレームワークの CGIKit、O/R マッピングツールの TapKit を利用した Web アプリケーションの作成方法を説明します。</p>

<h3 id="2-cgikit-とは">2. CGIKit とは？</h3>

<p><a href="http://www.spice-of-life.net/cgikit/">CGIKit</a> は Ruby で書かれた Web アプリケーションフレームワークです。</p>

<p>CGIKit による Web アプリケーションは、</p>

<ul>
  <li>テンプレート (.html)</li>
  <li>バインディング (.ckd)</li>
  <li>コード (.rb)</li>
</ul>

<p>というファイルで構成されるコンポーネントを組み合わせて作成します。
これらのファイルで記述されたエレメント (インスタンス変数やメソッドを HTML として表示する仕組み) をコードがバインディングし、HTML に変換して出力することで Web ページが表示されるようになっています。</p>

<p>Ruby 標準の cgi.rb で CGI を作成していると、コードやテンプレートの再利用が難しいのですが、CGIKit では　Web ページのヘッダ部分 (サイトのタイトル等) やフッタ部分、またはどのページにも表示させたいパーツ等再利用したいものは全てコンポーネントとして分ける事で、コードの再利用を可能にし、開発効率を上げる事ができます。</p>

<p>また、CGIKit のコンポーネントは、デザインとロジックが分離されているので、ロジックに影響しないデザインだけであればコードを書き換える事無く変更する事ができます。</p>

<h3 id="3-tapkit-とは">3. TapKit とは？</h3>

<p><a href="http://www.spice-of-life.net/tapkit/index_ja.html">TapKit</a> はオブジェクト-リレーショナルデータベース間のマッピングを行うフレームワークです。
細かい内容はるびま 4 号の記事「<a href="../../articles/0004/0004-RLR.html">Ruby Library Report — [第3回] O/R マッピング</a>」を参考にしてください。</p>

<h3 id="4-webアプリケーションを作ってみる">4. Webアプリケーションを作ってみる</h3>

<p>では実際に CGIKit と TapKit を使って Web アプリケーションを作成してみましょう。
今回は簡易 BBS (掲示板) を作成してみます。
手順としては以下のようになります。</p>

<ul>
  <li>コンポーネントの作成</li>
  <li>モデルファイルの作成</li>
  <li>TapKit オブジェクト用クラスの作成</li>
</ul>

<p>まず掲示板 (以下 BBS と呼ぶ) の操作の流れは今回以下のようにしてみます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[スレッド一覧] ----&gt; [スレッド新規登録]
      |
      +------------&gt; [コメント一覧]</code></pre></figure>

<p>「スレッド一覧」画面ではスレッドの一覧を表示し、「スレッド新規登録」ではスレッドを新しく登録出来るようにします。「コメント一覧」ではスレッドに対してのコメントの一覧を表示し、またコメントを入力出来るようにします。</p>

<h3 id="5-準備">5. 準備</h3>

<p>BBS の仕様は [4.Webアプリケーションを作ってみる] の通りですが、まずは CGIKit、TapKit のインストールから行いましょう。
今回 CGIKit は CVS から取得します。取得するものは安定版であるバージョン 1 系のものになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ cvs -d:pserver:anonymous@cvs.sourceforge.jp:/cvsroot/cgikit login
  パスワードを聞かれたら、Enter を押す。
$ cvs -d:pserver:anonymous@cvs.sourceforge.jp:/cvsroot/cgikit co cgikit-1
$ cd cgikit-1
$ ruby setup.rb config
$ ruby setup.rb setup
# ruby setup.rb install</code></pre></figure>

<p>うまくインストール出来たでしょうか？
次に TapKit をインストールします。
今回 bbs のデータを扱うためにデータベースを使用しますが、データベースは RDBMS の PostgreSQL を利用します。
TapKit では PostgreSQL を利用するために <a href="http://raa.ruby-lang.org/project/ruby-dbi">RAA:ruby-dbi</a>、<a href="http://raa.ruby-lang.org/project/postgres">RAA:postgres</a> を使いますのでこれらを先にインストールしておきましょう。
ruby-dbi、ruby-postgres がインストール出来ましたら TapKit も CVS から取得します。
インストール方法は CGIKit と同じように、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ cvs -d:pserver:anonymous@cvs.sourceforge.jp:/cvsroot/tapkit login
  パスワードを聞かれたら、Enter を押す。
$ cvs -d:pserver:anonymous@cvs.sourceforge.jp:/cvsroot/tapkit co tapkit
$ cd tapkit
$ ruby setup.rb config
$ ruby setup.rb setup
# ruby setup.rb install</code></pre></figure>

<p>となります。
これで準備は完了です。</p>

<h3 id="6-コンポーネントの作成">6. コンポーネントの作成</h3>

<p>CGIKit による Web アプリケーションは、[1. CGIKitとは] で説明したとおり、<em>.html、</em>.ckd、*.rb というファイル群で構成されます。これら三つのファイルを合わせてコンポーネントと呼び、画面毎にこのコンポーネントを作成していきます。
今回作成する BBS では、[4. Webアプリケーションを作ってみる] での操作の流れから、以下の三つのコンポーネントを作成します。</p>

<ul>
  <li>MainPage   (スレッド一覧)</li>
  <li>EditPage   (スレッド新規登録)</li>
  <li>ThreadPage (コメント一覧)</li>
</ul>

<p>まず MainPage コンポーネントのテンプレート、バインディングから作成します。
CGIKit のテンプレートはバインディングファイルと対となっています。
エレメントは、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;cgikit name="*****"&gt;.....&lt;/cgikit&gt;</code></pre></figure>

<p>や、&lt;/cgikit&gt;を省略した形、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;cgikit name="*****" /&gt;</code></pre></figure>

<p>と記述します。
では MainPage のテンプレートを見てみましょう。</p>

<p>テンプレートファイル (MainPage/MainPage.html)</p>

<p><img src="../../images/0005-CGIKit/MainPage.html" alt="MainPage.html" />
<a href="../../images/0005-CGIKit/MainPage.html">MainPage.html</a></p>

<p>“edit” というエレメントがまず出て来ます。これはご想像のとおりスレッドを追加するページへのリンクになります。以下のバインディングファイルでエレメントの内容を見てみましょう。</p>

<p>バインディングファイルは、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">定義名 : 種類 {
  属性 = 値
  属性 = 値
  ...
}</code></pre></figure>

<p>という書式で記述します。定義名はテンプレートで指定した名前が入り、種類は CGIKit で提供されているエレメントや他のコンポーネントを指定します。
{ と } の間はそのエレメントの属性を定義します。
例えば、edit にあたるバインディングは以下のようになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">edit : CKHyperlink {
        page = 'EditPage'
}</code></pre></figure>

<p>これは、EditPage というコンポーネントへのリンクを生成するエレメントになります。</p>

<p>次に thread_list というエレメントが登場します。これにあたるバインディングは以下のようになります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">thread_list : CKRepetition {
        list  = thread_list
        item  = thread
        index = index
}</code></pre></figure>

<p>これは、&lt;cgikit&gt; タグで囲んだ内容を繰り返すエレメントになります。
つまり、&lt;cgikit name=”thread_list”&gt; から &lt;/cgikit&gt; までを繰り返すという意味になります。ここでは HTML での</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&lt;table&gt;
  &lt;tr&gt;
    &lt;td&gt;2004-01-01&lt;/td&gt;
    &lt;td&gt;けいじばん&lt;/td&gt;
    &lt;td&gt;喜多川&lt;/td&gt;
  &lt;/tr&gt;
   .
   .
   .
&lt;/table&gt;</code></pre></figure>

<p>のように表を 1 行ずつ繰り返す役割をしています。
thread_list の属性は、list、item、index が指定されてますが、</p>

<dl>
  <dt>list</dt>
  <dd>繰り返すデータ。この配列から要素を順に取り出し、item 属性に入れる。</dd>
  <dt>item</dt>
  <dd>list 属性から取り出した要素。イテレータのブロックパラメータにあたる。</dd>
  <dt>index</dt>
  <dd>item 属性で繰り返される要素数。</dd>
</dl>

<p>となっています。
つまりコード (*.rb) で thread_list へ配列で値を渡すと item 属性の thread へ
1 要素ずつ展開されるようになります。ここでの配列は、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[{'date' =&gt; '2004-01-01',
  'title' =&gt; 'けいじばん',
  'register' =&gt; '喜多川'
  'query' =&gt; {'thread_no' =&gt; 1}
 },
....]</code></pre></figure>

<p>のようにコードで要素にはハッシュで値を渡すようにしています。
なのでバインディングでは、以下のように date や title といった値として thread[‘date’] や thread[‘title’] などのように指定します。</p>

<p>また、以下のバインディングファイルで、CKString というエレメントが記述されていますが、CGIKit が提供している各エレメントには escape という属性がありますのでこれを利用する事で自前でエスケープ等をしなくて良くなります (escape 属性はデフォルトで有効)。</p>

<p>エレメントの一覧は <a href="http://www.spice-of-life.net/cgikit/ja/userguide/CGIKitUserGuide_J.html">CGIKit のドキュメント</a> を参考にすると良いでしょう。</p>

<p>バインディングファイル (MainPage/MainPage.ckd)</p>

<p><img src="../../images/0005-CGIKit/MainPage.ckd.txt" alt="MainPage.ckd.txt" />
<a href="../../images/0005-CGIKit/MainPage.ckd">MainPage.ckd</a></p>

<p>コード (MainPage/MainPage.rb)</p>

<p><img src="../../images/0005-CGIKit/MainPage.rb" alt="MainPage.rb" />
<a href="../../images/0005-CGIKit/MainPage.rb">MainPage.rb</a></p>

<h3 id="7-モデルファイルの作成">7. モデルファイルの作成</h3>

<p>次に TapKit で利用するモデルファイルを作成しましょう。
TapKit ではマッピングの設定を記述したファイルをモデルファイルと呼び、このファイルには他にデータベースと接続するアダプタの情報も記述します。</p>

<p>まず今回作成する BBS のデータベースのテーブル構造は以下のようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">/* bbs */
/* base table */
create  table	thread	(
        thread_no	integer,	/* 0. スレッド No */
        title		text,		/* 1. タイトル */
        date		text,		/* 2. 登録日 */
        register	text,		/* 3. 名前 */
        e_mail		text,		/* 4. メールアドレス */
        contents	text,		/* 5. 内容 */
        primary key (
          thread_no
        )
);
/* comment table */
create	table	comment (
        thread_no	integer,	/* 0. スレッド No */
        comment_no	integer,	/* 1. コメント No */
        date		text,		/* 2. 登録日 */
        register	text,		/* 3. 名前 */
        e_mail		text,		/* 4. メールアドレス */
        contents	text,		/* 5. 内容 */
        primary key (
          thread_no,
          comment_no
        )
);</code></pre></figure>

<p>これを PostgreSQL に bbs という名前の DB として作成します。
次にデータベーススキーマからモデルファイルを自動生成します。
TapKit をインストールすると modeler というコマンドもインストールされますが、これが自動生成用のスクリプトになります。
モデルファイルの自動生成は以下のようにします。
(モデルファイルのファイル名は model.conf とします)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ modeler PostgreSQL model.conf</code></pre></figure>

<p>とすると、以下のように対話的に設定を行う事が出来ます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">kida@sairen:~/src/bbs$ modeler PostgreSQL model.conf
Login database with DBI
URL: dbi:Pg:bbs
Username: postgres
Password:
Selectable tables - comment, pg_aggregate, pg_am, pg_amop,
pg_amproc, pg_attrdef, pg_attribute, pg_cast, pg_class,
pg_constraint, pg_conversion, pg_database, pg_depend,
pg_description, pg_group, pg_index, pg_inherits, pg_language,
pg_largeobject, pg_listener, pg_namespace, pg_opclass,
pg_operator, pg_proc, pg_rewrite, pg_shadow, pg_statistic,
pg_trigger, pg_type, sql_features, sql_implementation_info,
sql_languages, sql_packages, sql_sizing, sql_sizing_profiles, thread
(If you want to select the all tables, input 'all')
Select tables (separate table names with comma): thread,comment
Create model.conf</code></pre></figure>

<p>これでカレントディレクトリに model.conf というファイル名のモデルファイルが作成されます。
以下のモデルファイルは自動生成されたファイルを若干修正しています。
具体的には text 型のフィールドで width が-1 と設定されているのを削除したり、primary key を class_properties に追加したりしています。
また、次の章で説明しますが、class_name を GenerciRecord から BBS::Thread や BBS::Comment に変更しています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">---
adapter_name: PostgreSQL
connection:
  password: ''
  url: dbi:Pg:bbs
  user: postgres
entities:
-
  attributes:
    -
      allow_null: true
      class_name: Integer
      column_name: thread_no
      external_type: integer
      name: thread_no
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: contents
      external_type: text
      name: contents
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: date
      external_type: text
      name: date
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: e_mail
      external_type: text
      name: e_mail
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: register
      external_type: text
      name: register
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: title
      external_type: text
      name: title
      read_only: false
  class_name: BBS::Thread
  class_properties:
    - contents
    - e_mail
    - register
    - title
    - comments
    - date
    - thread_no
  external_name: thread
  name: Thread
  primary_key_attributes:
    - thread_no
  relationships:
    -
      delete_rule: nullify
      destination: Comment
      join_semantic: inner
      joins:
        -
          destination: thread_no
          source: thread_no
      mandatory: false
      name: comments
      to_many: true
-
  attributes:
    -
      allow_null: false
      class_name: Integer
      column_name: comment_no
      external_type: integer
      name: comment_no
      read_only: false
    -
      allow_null: false
      class_name: Integer
      column_name: thread_no
      external_type: integer
      name: thread_no
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: date
      external_type: text
      name: date
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: e_mail
      external_type: text
      name: e_mail
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: register
      external_type: text
      name: register
      read_only: false
    -
      allow_null: false
      class_name: String
      column_name: contents
      external_type: text
      name: contents
      read_only: false
  class_name: BBS::Comment
  class_properties:
    - e_mail
    - register
    - thread
    - date
    - contents
    - comment_no
    - thread_no
  external_name: comment
  name: Comment
  primary_key_attributes:
    - comment_no
    - thread_no
  relationships:
    -
      delete_rule: nullify
      destination: Thread
      join_semantic: inner
      joins:
        -
          destination: thread_no
          source: thread_no
      mandatory: false
      name: thread
      to_many: false</code></pre></figure>

<p>これで TapKit を利用する準備が整いました。</p>

<h3 id="8-tapkit-オブジェクト用クラス">8. TapKit オブジェクト用クラス</h3>

<p>次に TapKit を利用してデータベースにアクセスするクラスを作成しましょう。</p>

<p>CGIKit で利用する*.rb の実装では以下のようにクラスにアクセスする事を想定して作成します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">def init
  threads = Thread.list
  @thread_list = Array.new
  threads.each do |obj|
    @thread_list.push({
                        'query' =&gt; {'thread_no' =&gt; obj.thread_no},
                        'date' =&gt; obj.date,
                        'title' =&gt; obj.title,
                        'register' =&gt; obj.register
                      })
  end
end</code></pre></figure>

<p>上記の通り、作成するクラス名は Thread という名前のクラスになります。
Thread クラスを作成する前に、TapKit::GenericRecord という Tapkit 独自のクラスを継承するクラスを作成します。
このクラス (BBSRecord) ではモデルファイルから TapKit の Application オブジェクトを作成します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">class BBS
  class BBSRecord &lt; TapKit::GenericRecord
    def self.connect(model)
      @@tap = TapKit::Application.new(model)
    end
  end
end</code></pre></figure>

<p>BBSRecord クラスの connect メソッドは index.cgi というこの BBS アプリケーションでアクセスする cgi ファイルから呼ばれるようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">#!/usr/bin/env ruby
require 'cgikit'
require 'tapkit'
require 'lib/bbs.rb'
require 'lib/bbs_record'
require 'lib/thread'
require 'lib/comment'
BBS::BBSRecord.connect('sql/model.conf')
app = BBS.new
app.main = 'MainPage'
app.run</code></pre></figure>

<p>これで以下の Thread クラスの list メソッドで@@tap という Application オブジェクトを利用出来るようになります。</p>

<p>以下の list メソッドでは、Quqlifer.format でデータを取得するための条件を記述します。list メソッドでは全てのスレッドを取り出したいので空を指定しています。
次に、SortOrdering.new では thread_no というフィールドで降順にデータを取り出すという並び変えの設定を行っています。SQL でいう ORDER BY 句にあたります。
FetchSpec.new ではこれらの条件式、並び変えの設定を指定し、fetchspec.limit でデータの取得件数を指定します。
実際にデータを取り出すのは、@@tap.create_editing_context.fetch で取得します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">class BBS
  class Thread &lt; BBSRecord
    def self.list(count = 20)
      qualifier = Qualifier.format('')
      sort = SortOrdering.new('thread_no', SortOrdering::DESC)
      fetchspec = FetchSpec.new('Thread', qualifier, [sort])
      fetchspec.limit = count
      obj = @@tap.create_editing_context.fetch(fetchspec)
      return obj
    end
  end
end</code></pre></figure>

<p>obj には以下のような Hash に似た値が帰ってきます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[{thread_no = 2, contents = "内容", date = "2005-01-22",
  e_mail = "kida@netlab.jp", register = "喜多川",
  title ="開設しました",
  comments = &lt;FaultingDelayEvaluationArray -89021887&gt;},
 {thread_no = 1, contents = "内容 2", date = "2005-01-20",
  e_mail = "kida@netlab.jp", register = "喜多川です",
  title = "BBS ですよ",
  comments = &lt;FaultingDelayEvaluationArray -89021881&gt;}]</code></pre></figure>

<p>実装では</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">obj[0].thread_no
obj[0].contents</code></pre></figure>

<p>等で値を取り出す事が出来ます。
comments は FaultingDelayEvaluationArray と記述されていますが、これは comment テーブルは thread と 1:多でリレーションシップの関係を持っているため、thread_no でリレーションされている comment テーブルのデータも取得出来ます。
上記の comments は、</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">obj[0].comments[0].contents</code></pre></figure>

<p>等でアクセス出来ますが、アクセスしない限り comment テーブルに対してデータベースにアクセスしません。これは TapKit のフォールティングの機能があるからです。</p>

<h3 id="9-まとめ">9. まとめ</h3>

<p>簡単ですが CGIKit と TapKit で Web アプリケーションを作成してみました。
コンポーネントの再利用や O/R マッピングの利便性等は説明しきれませんでしたが、CGIKit、TapKit に興味を持っていただけると幸いです。
今回製作した BBS のソースは <a href="../../images/0005-CGIKit/bbs.tar.gz">bbs.tar.gz</a> になります。
CGIKit はバージョン 2 系の開発も進んでおり、リリースされた時はまたレビューしてみたいと思っております。</p>

<h3 id="著者について">著者について</h3>

<dl>
  <dt>喜多川 豪</dt>
  <dd>喜多川は株式会社ネットワーク応用通信研究所にて研究開発職に就いています。日々仕事で Ruby を使って Web アプリケーションを作成していたりします。</dd>
  <dt>かずひこ</dt>
  <dd>Web アプリケーションをこよなく愛するオープンソースエンジニア。</dd>
</dl>


                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
