<!DOCTYPE html>
<html>
  



  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41117431-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-41117431-1');
  </script>
  <script src="../../js/gtag.js"></script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)</title>
  <meta name="description" content="">

  <script src="../../js/jquery.min.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <link href="../../css/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="../../css/theme.css" rel="stylesheet" type="text/css">
  <link href="../../css/syntax.css" rel="stylesheet" type="text/css">
  <link href="../../css/sharebutton.css" rel="stylesheet" type="text/css">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="https://magazine.rubyist.net/articles/0005/0005-RubyOnRails.html">
  <link rel="alternate" type="application/rss+xml" title="Rubyist Magazine" href="https://magazine.rubyist.net/feed.xml">
  <link rel="shortcut icon" href="../../images/favicon.ico">
</head>

  <body>
    <div class="container-fluid">
        <div class="row full">
            <div class="col-md-2 hidden-xs sidebar">
                <h4>

</h4>

<h4>バックナンバー</h4>
<ul>
    
        <li><a href="../../articles/0058/0058-index.html">0058号(2018-08)</a></li>
    
        <li><a href="../../articles/prerubykaigi2018/preRubyKaigi2018-index.html">RubyKaigi 2018 直前特集号</a></li>
    
        <li><a href="../../articles/0057/0057-index.html">0057号(2018-02)</a></li>
    
        <li><a href="../../articles/prerubykaigi2017/preRubyKaigi2017-index.html">RubyKaigi 2017 直前特集号</a></li>
    
        <li><a href="../../articles/0056/0056-index.html">0056号(2017-08)</a></li>
    
        <li><a href="../../articles/0055/0055-index.html">0055号(2017-03)</a></li>
    
        <li><a href="../../articles/0054/0054-index.html">0054号(2016-08)</a></li>
    
        <li><a href="../../articles/pretokyorubykaigi11/preTokyoRubyKaigi11-index.html">東京 Ruby 会議 11 直前特集号</a></li>
    
        <li><a href="../../articles/0053/0053-index.html">0053号(2016-04)</a></li>
    
        <li><a href="../../articles/0052/0052-index.html">0052号(2015-12)</a></li>
    
        <li><a href="../../articles/0051/0051-index.html">0051号(2015-09)</a></li>
    
        <li><a href="../../articles/0050/0050-index.html">0050号(2015-05)</a></li>
    
        <li><a href="../../articles/0049/0049-index.html">0049号(2014-12)</a></li>
    
        <li><a href="../../articles/0048/0048-index.html">0048号(2014-09)</a></li>
    
        <li><a href="../../articles/0047/0047-index.html">0047号(2014-06)</a></li>
    
        <li><a href="../../articles/0046/0046-index.html">0046号(2014-04)</a></li>
    
        <li><a href="../../articles/0045/0045-index.html">0045号(2013-12)</a></li>
    
        <li><a href="../../articles/0044/0044-index.html">0044号(2013-09)</a></li>
    
        <li><a href="../../articles/0043/0043-index.html">0043号(2013-07)</a></li>
    
        <li><a href="../../articles/0042/0042-index.html">0042号(2013-05)</a></li>
    
        <li><a href="../../articles/ruby200specialen/Ruby200SpecialEn-index.html">2.0.0 Special (EN)</a></li>
    
        <li><a href="../../articles/0041/0041-index.html">0041号(2013-02)</a></li>
    
        <li><a href="../../articles/0040/0040-index.html">0040号(2012-11)</a></li>
    
        <li><a href="../../articles/0039/0039-index.html">0039号(2012-09)</a></li>
    
        <li><a href="../../articles/rubykaja/kaja.html">RubyKaja のご紹介</a></li>
    
        <li><a href="../../articles/0038/0038-index.html">0038号(2012-05)</a></li>
    
        <li><a href="../../articles/0037/0037-index.html">0037号(2012-02)</a></li>
    
        <li><a href="../../articles/0036/0036-index.html">0036号(2011-11)</a></li>
    
        <li><a href="../../articles/0035/0035-index.html">0035号(2011-09)</a></li>
    
        <li><a href="../../articles/prerubykaigi2011/preRubyKaigi2011-index.html">RubyKaigi2011直前特集号</a></li>
    
        <li><a href="../../articles/0034/0034-index.html">0034号(2011-06)</a></li>
    
        <li><a href="../../articles/0033/0033-index.html">0033号(2011-04)</a></li>
    
        <li><a href="../../articles/0032/0032-index.html">0032号(2011-01)</a></li>
    
        <li><a href="../../articles/0031/0031-index.html">0031号(2010-10)</a></li>
    
        <li><a href="../../articles/prerubykaigi2010/preRubyKaigi2010-index.html">RubyKaigi2010直前特集号</a></li>
    
        <li><a href="../../articles/0030/0030-index.html">0030号(2010-06)</a></li>
    
        <li><a href="../../articles/0029/0029-index.html">0029号(2010-03)</a></li>
    
        <li><a href="../../articles/0028/0028-index.html">0028号(2009-12)</a></li>
    
        <li><a href="../../articles/0027/0027-index.html">0027号(2009-09)</a></li>
    
        <li><a href="../../articles/0026/0026-index.html">0026号(2009-06)</a></li>
    
        <li><a href="../../articles/0025/0025-index.html">0025号(2009-02)</a></li>
    
        <li><a href="../../articles/0024/0024-index.html">0024号(2008-10)</a></li>
    
        <li><a href="../../articles/0023/0023-index.html">0023号(2008-03)</a></li>
    
        <li><a href="../../articles/0022/0022-index.html">0022号(2007-12)</a></li>
    
        <li><a href="../../articles/0021/0021-index.html">0021号(2007-09)</a></li>
    
        <li><a href="../../articles/0020/0020-index.html">0020号(2007-08)</a></li>
    
        <li><a href="../../articles/0019/0019-index.html">0019号(2007-05)</a></li>
    
        <li><a href="../../articles/0018/0018-index.html">0018号(2007-02)</a></li>
    
        <li><a href="../../articles/0017/0017-index.html">0017号(2006-11)</a></li>
    
        <li><a href="../../articles/0016/0016-index.html">0016号(2006-09)</a></li>
    
        <li><a href="../../articles/0015/0015-index.html">0015号(2006-07)</a></li>
    
        <li><a href="../../articles/rubykaigi2006/RubyKaigi2006-index.html">日本 Ruby カンファレンス 2006 特別号</a></li>
    
        <li><a href="../../articles/0014/0014-index.html">0014号(2006-05)</a></li>
    
        <li><a href="../../articles/0013/0013-index.html">0013号(2006-02)</a></li>
    
        <li><a href="../../articles/0012/0012-index.html">0012号(2005-12)</a></li>
    
        <li><a href="../../articles/0011/0011-index.html">0011号(2005-11)</a></li>
    
        <li><a href="../../articles/0010/0010-index.html">0010号(2005-10)</a></li>
    
        <li><a href="../../articles/0009/0009-index.html">0009号(2005-09)</a></li>
    
        <li><a href="../../articles/0008/0008-index.html">0008号(2005-07)</a></li>
    
        <li><a href="../../articles/0007/0007-index.html">0007号(2005-06)</a></li>
    
        <li><a href="../../articles/0006/0006-index.html">0006号(2005-05)</a></li>
    
        <li><a href="../../articles/0005/0005-index.html">0005号(2005-02)</a></li>
    
        <li><a href="../../articles/0004/0004-index.html">0004号(2004-12)</a></li>
    
        <li><a href="../../articles/0003/0003-index.html">0003号(2004-11)</a></li>
    
        <li><a href="../../articles/0002/0002-index.html">0002号(2004-10)</a></li>
    
        <li><a href="../../articles/0001/0001-index.html">0001号(2004-09)</a></li>
    
</ul>
<p class="rss-subscribe"><a href="/feed.xml">RSS</a></p>

            </div>
            <div class="col-md-10 main">
                <div class="row">
                    <div class="col-md-12">
                        <img src="../../images/rubima_logo_l.png">
                        <h1>RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)</h1>
                        <div class="social-buttons">
                            <div class='sns'>            
    <ul class="clearfix">
       <li class="twitter"><a href="https://twitter.com/share?text=RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)&amp;url=https://magazine.rubyist.net/articles/0005/0005-RubyOnRails.html" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
       <li class="facebook"><a href="https://www.facebook.com/sharer.php?u=https://magazine.rubyist.net/articles/0005/0005-RubyOnRails.html&amp;t=RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
       <li class="hatebu"><a href="http://b.hatena.ne.jp/add?mode=confirm&amp;url=https://magazine.rubyist.net/articles/0005/0005-RubyOnRails.html&amp;RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)" target="_blank" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"><i class="fa">B!</i></a></li>
    </ul>
</div>
                        </div>
                        
<h2 id="はじめに">はじめに</h2>

<p>もりきゅうです。<a href="../../articles/0004/0004-RubyOnRails.html">先号</a>に引き続き、<a href="http://www.rubyonrails.org/">Ruby on Rails</a> (以下 Rails) に関する記事をお届けします。</p>

<p>さて、前回のまとめには「次回は私が作った買い物かごを紹介しつつ」と書いてあります。
今号は執筆当初 (といっても締め切りはすでに過ぎていました。ごめんなさい) 製作過程から始めるつもりでした。しかし、
Rails の開発が進んだこともあり、先号の内容からではいきなりすぎる感が否めません。
というわけで、インストールが終わった時点からもう一度、お話を始めたいと思います。</p>

<p>また、今回は特に Windows XP 環境での作業を元にして記事を書いています。
これは単に私の都合なわけですが、UNIX 環境で同様に試して問題になるようなことは特にないので、cmd.exe のプロンプトを気にせずにお読みください。</p>

<h2 id="rails-の使い方">Rails の使い方</h2>

<h3 id="準備">準備</h3>

<p>本稿では Windows XP 環境を例にして説明します。</p>

<p>RDBMS として MySQL を使います。</p>

<dl>
  <dt><a href="http://dev.mysql.com/get/Downloads/MySQL-4.1/mysql-essential-4.1.9-win32.msi/from/pick#mirrors">mysql-essential-4.1.9-win32.msi</a></dt>
  <dd>Windows 版 MySQL-4.1 のインストーラです。このインストーラは root パスワードやパラメータの設定も行うことができます。</dd>
</dl>

<p>RubyGems での Rails のバージョンは以下の通り。</p>

<ul>
  <li>actionmailer 0.6.1</li>
  <li>actionpack 1.4.0</li>
  <li>activerecord 1.6.0</li>
  <li>rails 0.9.5</li>
  <li>rake 0.4.15</li>
</ul>

<h3 id="testunit-rake-にパッチをあてる">test/unit, rake にパッチをあてる</h3>

<p>今回用いるバージョンの test/unit, rake には不具合が見つかっています。以下のパッチをあてておきます。</p>

<dl>
  <dt><a href="http://dev.rubyonrails.com/attachment/ticket/474/dir.rb.cleanup.patch?format=txt">dir.rb.cleanup.patch</a></dt>
  <dd>テストが途中で止まってしまう現象に対するパッチ <a href="http://weblog.rubyonrails.com/archives/2005/01/15/having-problems-running-tests-under-182/">Having problems running tests under 1.8.2?</a></dd>
  <dt><a href="http://www.moriq.com/ruby/archive/rake-0.4.15-testtask.patch">rake-0.4.15-testtask.patch</a></dt>
  <dd>win32 における testrb の呼び出しに対するパッチ ((う)さんに感謝)</dd>
</dl>

<h3 id="model-を作る">Model を作る</h3>

<p>Windows XP の cmd.exe での作業を例にして説明します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www&gt;rails rubima</code></pre></figure>

<p>Rails プロジェクト rubima が作られます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www&gt;cd rubima
 C:\var\www\rubima&gt;ruby script\generate</code></pre></figure>

<p>generate の説明が表示されます。</p>

<p>Model として Topic クラスを作りましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;ruby script\generate model Topic</code></pre></figure>

<p>すると、次に挙げるファイルが作られます。</p>

<ul>
  <li>app/models/topic.rb</li>
  <li>test/fixtures/topics.yml</li>
  <li>
    <p>test/unit/topic_test.rb</p>
  </li>
  <li>app/models/topic.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class Topic &lt; ActiveRecord::Base
 end</code></pre></figure>

<p>app/models/ に作られたファイル topic.rb には ActiveRecord::Base から継承したクラス Topic の定義が書かれています。</p>

<ul>
  <li>test/fixtures/topics.yml</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> # Read about fixtures at http://ar.rubyonrails.org/classes/Fixtures.html</code></pre></figure>

<p>test/fixtures/ に作られたファイル topics.yml はテストに使うデータ (これを fixtures といいます) を書くためのファイルです。</p>

<p>fixtures にはいくつかの書き方がありますが、本稿では YAML での書き方を見ていきます。
YAML 形式のファイル拡張子は .yml または .yaml とします。</p>

<p>YAML については <a href="http://www.namikilab.tuat.ac.jp/~sasada/prog/yaml.html">YAML を Ruby で使う</a> などを参照してください。</p>

<ul>
  <li>test/unit/topic_test.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require File.dirname(__FILE__) + '/../test_helper'

 class TopicTest &lt; Test::Unit::TestCase
   fixtures :topics

   # Replace this with your real tests.
   def test_truth
     assert true
   end
 end</code></pre></figure>

<p>test/unit/ に作られたファイル topic_test.rb には Test::Unit::TestCase から継承したテストケースクラス TopicTest の定義が書かれています。</p>

<p>fixtures をテストに用いるには、すでに topic_test.rb に書かれているように、テストケースクラスの中で</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> fixtures :topics</code></pre></figure>

<p>と指定します (ここでは topics table を指定しています。単数形のクラス名と複数形のテーブル名の対応に注意してください)。
これにより、app/models/topic.rb が require され、test/fixtures/topics.yml が読み込まれます。読み込まれたデータは Topic のインスタンスとして保持されます。</p>

<h3 id="テストの実行">テストの実行</h3>

<p>では、テストを実行してみましょう。</p>

<p>まず、Rails が用意している Rakefile の task を確認しておきます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake -T
 (in C:/var/www/rubima)
 rake apidoc                   # Build the apidoc HTML Files
 rake appdoc                   # Build the appdoc HTML Files
 rake clobber_apidoc           # Remove rdoc products
 rake clobber_appdoc           # Remove rdoc products
 rake clone_structure_to_test  # Recreate the test databases from the development structure
 rake db_structure_dump        # Dump the database structure to a SQL file
 rake default                  # Run all the tests on a fresh test database
 rake doc                      # Generate API documentatio, show coding stats
 rake purge_test_database      # Empty the test database
 rake reapidoc                 # Force a rebuild of the RDOC files
 rake reappdoc                 # Force a rebuild of the RDOC files
 rake stats                    # Report code statistics (KLOCs, etc) from the application
 rake test_functional          # Run tests for test_functional
 rake test_units               # Run tests for test_units</code></pre></figure>

<p>ふむ。test/unit/ に置かれているテストの実行は test_units ですね。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake test_units
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb
 Loaded suite topic_test.rb
 Started
 E
 Finished in 1.051 seconds.

   1) Error:
 test_truth(TopicTest):
 Mysql::Error: #28000Access denied for user 'root'@'localhost' (using password: NO)
 ...
 1 tests, 0 assertions, 0 failures, 1 errors
 rake aborted!
 Command failed with status (1): [ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb ]</code></pre></figure>

<p>テストの結果、エラーになりました。問題を検知しているので、これは正しい動作です。
次に、このエラーを解決するための作業を行います。</p>

<h3 id="データベースの設定">データベースの設定</h3>

<p>上のテストのエラーは MySQL のアクセス権が正しく設定されていないために起きています。
データベースの設定は config/database.yml で行います。このファイルは YAML 形式で書かれています。</p>

<p>config/database.yml の初期状態は以下の通り。</p>

<ul>
  <li>config/database.yml</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> development:
   adapter: mysql
   database: rails_development
   host: localhost
   username: root
   password:

 test:
   adapter: mysql
   database: rails_test
   host: localhost
   username: root
   password:

 production:
   adapter: mysql
   database: rails_production
   host: localhost
   username: root
   password:</code></pre></figure>

<p>今回重要なのは development と test の設定です。
まず、開発用 (development) の database 名を決めます。ここでは rubima とします。
テスト用 (test) の database 名は、とりあえず rails_test のままにしておきます。</p>

<p>ユーザ名とパスワードに関しては、開発用のユーザを作っておきましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;mysql -u root -p
 Welcome to the MySQL monitor.  Commands end with ; or \g.
 Your MySQL connection id is 1825 to server version: 4.1.9-nt

 Type 'help;' or '\h' for help. Type '\c' to clear the buffer.</code></pre></figure>

<p>rails@localhost が rubima と rails_test table を扱えるようにします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> mysql&gt; grant all on rubima.* to rails@localhost;
 Query OK, 0 rows affected (0.01 sec)

 mysql&gt; grant all on rails_test.* to rails@localhost;
 Query OK, 0 rows affected (0.00 sec)

 mysql&gt; \q
 Bye</code></pre></figure>

<p>MySQL の GRANT 構文については <a href="http://dev.mysql.com/doc/mysql/ja/grant.html">MySQL リファレンスマニュアル</a> を参照してください。</p>

<p>今回はパスワードを指定しませんでした。</p>

<ul>
  <li>config/database.yml</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> development:
   adapter: mysql
   database: rubima
   host: localhost
   username: rails
   password:

 test:
   adapter: mysql
   database: rails_test
   host: localhost
   username: rails
   password:</code></pre></figure>

<p>production はそのままにしておきます。
MySQL 以外の RDBMS を使うときは adapter 名を変更してください。</p>

<h3 id="table-の作成">table の作成</h3>

<p>もう一度テストを実行します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake test_units
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb
 Loaded suite topic_test.rb
 Started
 E
 Finished in 0.511 seconds.

   1) Error:
 test_topic_1(TopicTest):
 Mysql::Error: #42000Unknown database 'rails_test'
 ...
 1 tests, 0 assertions, 0 failures, 1 errors</code></pre></figure>

<p>少し進みました。今度は、rails_test という database がない、と言っています。
さて、ここで重要なのは、test db は development db から作られる (スキーマをコピーする) ということです。
ですから、rails_test.topics table を作るのではなく、rubima.topics table を作ることになります。</p>

<p>今日の格言: <strong>create table, alter table は development db に対して行うべし</strong></p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;mysql -u rails rubima
 ERROR 1049 (42000): Unknown database 'rubima'</code></pre></figure>

<p>おおっと。まだ rubima database を作っていませんでした。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;mysql -u rails
 Welcome to the MySQL monitor.  Commands end with ; or \g.
 Your MySQL connection id is 1825 to server version: 4.1.9-nt

 Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

 mysql&gt; create database rubima;
 Query OK, 1 row affected (0.05 sec)

 mysql&gt; use rubima
 Database changed</code></pre></figure>

<p>簡単に topics table を用意しておきましょう。ActiveRecord で扱う db table は少なくとも id という名前のプライマリキーを持つ必要があります。また、auto_increment にしておくと後々楽なので、指定しておきます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> mysql&gt; create table topics (
     -&gt; id int unsigned not null auto_increment,
     -&gt; primary key (id));
 Query OK, 0 rows affected (0.15 sec)

 mysql&gt; show tables;
 +------------------+
 | Tables_in_rubima |
 +------------------+
 | topics           |
 +------------------+
 1 row in set (0.00 sec)

 mysql&gt; describe topics;
 +-------+------------------+------+-----+---------+----------------+
 | Field | Type             | Null | Key | Default | Extra          |
 +-------+------------------+------+-----+---------+----------------+
 | id    | int(10) unsigned |      | PRI | NULL    | auto_increment |
 +-------+------------------+------+-----+---------+----------------+
 1 row in set (0.00 sec)

 mysql&gt; \q
 Bye</code></pre></figure>

<p>はい。ではもう一度テストを実行します…変わっていませんね。これは development db から test db へのコピーがまだ行われていないためです。
先に見た rake の task に clone_structure_to_test というのがありました。これを実行します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake clone_structure_to_test
 (in C:/var/www/rubima)</code></pre></figure>

<p>ok。ではもう一度テストを。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake test_units
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb
 Loaded suite topic_test.rb
 Started
 .
 Finished in 0.54 seconds.

 1 tests, 1 assertions, 0 failures, 0 errors</code></pre></figure>

<p>ok。初めてテストに成功しました。長い道のりでした…</p>

<ul>
  <li>db/development_structure.sql</li>
</ul>

<p>rake clone_structure_to_test すると db/development_structure.sql にスキーマが保存されます。MySQL の場合は mysqldump を用いて作られます。<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup></p>

<h3 id="fixtures-を書く">fixtures を書く</h3>

<p>やっとスタートラインに立てました。後はただひたすら作るのみ。</p>

<p>まず、fixtures を用意しましょう。</p>

<ul>
  <li>test/fixtures/topics.yml</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> # Read about fixtures at http://ar.rubyonrails.org/classes/Fixtures.html
 topic_1:
   id: 1
   title: The First Topic</code></pre></figure>

<p>YAML ではインデントが重要な意味を持ちます。注意してください。</p>

<p>ではテストを。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake test_units
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb
 Loaded suite topic_test.rb
 Started
 E
 Finished in 0.571 seconds.

   1) Error:
 test_truth(TopicTest):
 ActiveRecord::StatementInvalid: #42S22Unknown column 'title' in 'field list':
 INSERT INTO topics (title, id) VALUES ('The First Topic', 1)
 ...
 1 tests, 0 assertions, 0 failures, 1 errors</code></pre></figure>

<p>はい。title field がない、と言っています。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;mysql -u rails -e "alter table topics add title varchar(255)" rubima</code></pre></figure>

<p>スキーマをコピーしてからテストを。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake clone_structure_to_test
 (in C:/var/www/rubima)

 C:\var\www\rubima&gt;rake test_units
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb
 Loaded suite topic_test.rb
 Started
 .
 Finished in 0.661 seconds.

 1 tests, 1 assertions, 0 failures, 0 errors</code></pre></figure>

<p>ok。</p>

<h3 id="model-に対するテストを書く">Model に対するテストを書く</h3>

<p>fixtures が追加できましたので、今度はテストを追加しましょう。</p>

<p>Ruby の Test::Unit については <a href="ruby-man:Test::Unit">ruby-man:Test::Unit</a> を、Rails のテストについては <a href="http://manuals.rubyonrails.com/read/book/5">A Guide to Testing the Rails</a> を参照してください。</p>

<p>test first に従うならば、テストを書いてから fixtures を追加すべきですが、いきなり @topic_1 や title メソッドが出てきても説明に困るので見逃してください。</p>

<ul>
  <li>test/unit/topic_test.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require File.dirname(__FILE__) + '/../test_helper'

 class TopicTest &lt; Test::Unit::TestCase
   fixtures :topics

   def test_topic_1
     assert_equal(1, @topic_1.id)
     assert_equal('The First Topic', @topic_1.title)
   end
 end</code></pre></figure>

<p>最初に定義されている test_truth はダミーのテストなので、削除してかまいません。</p>

<p>これは、先に書いた fixtures との対比でわかっていただけると思います。
つまり、fixtures によって Topic インスタンス @topic_1 が作られます。この変数名は fixtures の第1レベルに指定した値 topic_1 を元にしています。
Topic#title メソッドは topics table の title field に対応しています。この field は varchar 型なので、Ruby での値は String オブジェクトになります。</p>

<p>ではテストを。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake test_units
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/unit/topic_test.rb
 Loaded suite topic_test.rb
 Started
 .
 Finished in 0.54 seconds.

 1 tests, 2 assertions, 0 failures, 0 errors</code></pre></figure>

<p>ok。</p>

<h3 id="controller-を作る">Controller を作る</h3>

<p>Model と同じ要領で Controller を作ります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;ruby script\generate controller Debate</code></pre></figure>

<p>すると、次に挙げるファイルが作られます。</p>

<ul>
  <li>app/controllers/debate_controller.rb</li>
  <li>app/helpers/debate_helper.rb</li>
  <li>app/views/debate</li>
  <li>
    <p>test/functional/debate_controller_test.rb</p>
  </li>
  <li>app/controllers/debate_controller.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class DebateController &lt; ApplicationController
 end</code></pre></figure>

<p>Controller 本体です。</p>

<ul>
  <li>app/helpers/debate_helper.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> module DebateHelper
 end</code></pre></figure>

<p>自動的に include されるモジュールです。テンプレートの中で関数のように使うメソッドを定義します。</p>

<ul>
  <li>app/views/debate</li>
</ul>

<p>このフォルダにはテンプレートを置くことになります。</p>

<ul>
  <li>test/functional/debate_controller_test.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require File.dirname(__FILE__) + '/../test_helper'
 require 'debate_controller'

 # Re-raise errors caught by the controller.
 class DebateController; def rescue_action(e) raise e end; end

 class DebateControllerTest &lt; Test::Unit::TestCase
   def setup
     @controller = DebateController.new
     @request, @response = ActionController::TestRequest.new, ActionController::TestResponse.new
   end

   # Replace this with your real tests.
   def test_truth
     assert true
   end
 end</code></pre></figure>

<p>テストケースクラスの定義です。setup メソッドで設定しているのは、テスト用の Controller、リクエスト、レスポンスのオブジェクトです。ただし、これらのオブジェクトを直接扱わなければならないようなことは、あまりないと思います。</p>

<h3 id="scaffold-を使う">scaffold を使う</h3>

<p>Model と Controller が準備できました。あとは View としてテンプレートを用意すれば MVC が揃うことになります。
しかし、ここでは手を抜いて、Rails に備わっている scaffold という仕組みを利用することにしましょう (scaffold は足場という意味です)。</p>

<p>debate_controller.rb に1行追加します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> class DebateController &lt; ApplicationController
   scaffold :topic
 end</code></pre></figure>

<p>scaffold は Model オブジェクトを操作するために最低限必要な機能――作成・表示・編集・削除そして一覧表示――を実装します。</p>

<p>WEBrick による HTTP サーバを立ち上げて、動作を確認します。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;ruby script\server
 =&gt; Rails application started on http://127.0.0.1:3000
 [2005-02-03 03:55:57] INFO  WEBrick 1.3.1
 [2005-02-03 03:55:57] INFO  ruby 1.8.2 (2004-12-25) [i386-mswin32]
 [2005-02-03 03:55:57] INFO  WEBrick::HTTPServer#start: pid=3688 port=3000</code></pre></figure>

<p><a href="http://localhost:3000/debate">http://localhost:3000/debate</a> にアクセスすると、Listing topics のページが開きます。</p>

<p>新たな Topic を追加できます。New topic リンクを開いてください。
すると、New topic のページが開きます。</p>

<p>Title というラベルの付いた text field がひとつあります。これは Topic#title に対応しています (つまり、データベースレベルでいえば topics table の title field に対応しています)。</p>

<p>ここで好きな title を記入して (記入しなくてもかまいませんが) [Create] ボタンを押しましょう。すると、Listing topics のページに戻り、ひとつ Topic が追加されていることがわかります。</p>

<p>その Topic の横には Show Edit Destroy というリンクが並んでいます。</p>

<ul>
  <li>Show を開くと、ひとつの Topic について表示するページになります。</li>
  <li>Edit を開くと、Editing topic のページが開き、先の New topic のページと同じように Title というラベルの付いた text field がひとつ現れます。この text field には現在の title の値が設定されています。[Update] ボタンを押すと更新できます。</li>
  <li>Destroy を開くと、その Topic は削除されます。</li>
</ul>

<p><img src="../../images/0005-RubyOnRails/new_topic.gif" alt="new_topic.gif" />
<img src="../../images/0005-RubyOnRails/list_topic.gif" alt="list_topic.gif" />
<img src="../../images/0005-RubyOnRails/show_topic.gif" alt="show_topic.gif" />
<img src="../../images/0005-RubyOnRails/edit_topic.gif" alt="edit_topic.gif" /></p>

<h3 id="データベースの選択">データベースの選択</h3>

<p>上のアプリケーションで用いているデータベースは development db です。入力して保存したデータはデータベースに格納されますから、HTTP サーバを終了しても保持されます (cmd.exe 上であれば Ctrl+C を押すと script/server を終了できます)。</p>

<p>アプリケーションで用いるデータベースを production に変更するには、ENV[‘RAILS_ENV’] を設定します。
ENV[‘RAILS_ENV’] については config/emvironment.rb を参照してください。</p>

<p>また、script/server であれば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> -e, --environment=name
   Specifies the environment to run this server under (test/development/production).</code></pre></figure>

<p>というオプションで指定できます。</p>

<h3 id="テンプレートを作る">テンプレートを作る</h3>

<p>View となる ERB テンプレートについて説明します。</p>

<p>テンプレートの詳細については ActionView のマニュアルを参照してください。</p>

<p>scaffold はお手軽ですが、実際に使えるサービスを提供するためには、それなりにテンプレートを作る必要があります。
例えば、編集 (edit) のページを次のように用意してみます。</p>

<ul>
  <li>app/views/debate/edit.rhtml</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;html&gt;
 &lt;head&gt;
 &lt;title&gt;トピックの編集&lt;/title&gt;
 &lt;/head&gt;
 &lt;body&gt;
 &lt;div&gt;
 [ &lt;%= link_to "戻る", :action=&gt;"show", :id=&gt;@topic.id %&gt; ]
 &lt;/div&gt;
 &lt;table&gt;
 &lt;%= form_tag :action=&gt;"update" %&gt;
 &lt;%= hidden_field "topic", "id" %&gt;
   &lt;caption&gt;トピックの編集&lt;/caption&gt;
   &lt;tr&gt;
     &lt;th&gt;タイトル&lt;/th&gt;
     &lt;td&gt;&lt;%= text_field "topic", "title" %&gt;&lt;/td&gt;
   &lt;/tr&gt;
   &lt;tr&gt;
     &lt;th&gt;&lt;/th&gt;
     &lt;td align="right"&gt;&lt;input type="submit" value=" 保存 " /&gt;&lt;/td&gt;
   &lt;/tr&gt;
 &lt;/form&gt;
 &lt;/table&gt;
 &lt;/body&gt;
 &lt;/html&gt;</code></pre></figure>

<p>テンプレートの拡張子は .rhtml とします。ERB の書式についてはドキュメントを参照してください。</p>

<p>link_to は A タグに変換されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [ &lt;a href="/debate/show/2"&gt;戻る&lt;/a&gt; ]</code></pre></figure>

<p>この例では id=2 になっています。</p>

<p>form_tag, hidden_field は</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;form action="/debate/update" method="post"&gt;
 &lt;input id="topic_id" name="topic[id]" type="hidden" value="2" /&gt;</code></pre></figure>

<p>このように変換されます。</p>

<p>また、text_field は展開すると</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;input type="text" name="topic[title]" value="&lt;%=h @topic.title %&gt;" /&gt;</code></pre></figure>

<p>このように書くこともできます。name の値に注意してください。</p>

<h3 id="controller-に対するテストを書く">Controller に対するテストを書く</h3>

<p>Controller に対するテストの書き方を紹介して締めくくります。</p>

<p>DebateController#update に対するテストを書いてみましょう。</p>

<p>scaffold :topic が定義する update メソッドは、次のようになります (actionpack-1.4.0/lib/action_controller/scaffolding.rb を参照)。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">def update
  @topic = Topic.find(@params["topic"]["id"])
  @topic.attributes = @params["topic"]

  if @topic.save
    flash["notice"] = "Topic was succesfully updated"
    redirect_to :action =&gt; "show/" &lt;&lt; @topic.id.to_s
  else
    render "topic/edit"
  end
end</code></pre></figure>

<p>これに対するテストは次のように書けます。</p>

<ul>
  <li>test/functional/debate_controller_test.rb</li>
</ul>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> require File.dirname(__FILE__) + '/../test_helper'
 require 'debate_controller'

 # Re-raise errors caught by the controller.
 class DebateController; def rescue_action(e) raise e end; end

 class DebateControllerTest &lt; Test::Unit::TestCase
   fixtures :topics

   def setup
     @controller = DebateController.new
     @request, @response = ActionController::TestRequest.new, ActionController::TestResponse.new
   end

   def test_update
     post :update, "topic"=&gt;{"id"=&gt;"1", "title"=&gt;"Hello"}
     assert_redirected_to :action =&gt; "show/1"
     topic = Topic.find(1)
     assert_equal('Hello', topic.title)
   end
 end</code></pre></figure>

<p>追加したのは fitures :topics の行と test_update の定義です。</p>

<p>フォーム入力 (title を入力して [Update] を押す) に対応するのが、post メソッドです。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> post :update, "topic"=&gt;{"id"=&gt;"1", "title"=&gt;"Hello"}</code></pre></figure>

<p>これは HTTP の POST method によるリクエストをエミュレートします。リクエストのパラメータとして本来なら “topic[id]=1&amp;topic[title]=Hello” を渡すことになるわけですが、このテストではハッシュがそのまま @params に入ると考えればわかりやすいでしょう。</p>

<p>redirect_to の実行を期待するテストが assert_redirected_to です。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> assert_redirected_to :action =&gt; "show/1"</code></pre></figure>

<p>redirect_to の引数と同じ形式でテストを書けます。</p>

<p>render の実行を期待するテストであれば</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> assert_rendered_file "topic/edit"</code></pre></figure>

<p>とします。</p>

<p>Model に対するテストのとき用いた @topic_1 を使わずに</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> topic = Topic.find(1)</code></pre></figure>

<p>としているのは、Controller での更新は @topic_1 に反映されないからです。</p>

<p>このテストを実行するには、直接 debate_controller_test.rb を実行するか、rake test_functional とします。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> C:\var\www\rubima&gt;rake test_functional
 (in C:/var/www/rubima)
 ruby -Ilib;test -Sx testrb.bat test/functional/debate_controller_test.rb
 Loaded suite debate_controller_test.rb
 Started
 .
 Finished in 1.422 seconds.

 1 tests, 5 assertions, 0 failures, 0 errors</code></pre></figure>

<p>今回はこれでおしまい。</p>

<p>残りの紙面に、いくつか簡易リファレンスを用意しました。</p>

<ul>
  <li>scaffold</li>
  <li>SQL 型と Ruby クラスとの対応</li>
  <li>テンプレート用 helper メソッド リファレンス</li>
</ul>

<p>ご参考になれば幸いです。</p>

<h2 id="scaffold">scaffold</h2>

<p>scaffold が自動生成するアクションと redirect, render の働き、画面遷移のカスタマイズについて解説します。</p>

<h3 id="scaffold-が用意する-action">scaffold が用意する action</h3>

<p><img src="../../images/0005-RubyOnRails/scaffold-1.gif" alt="scaffold-1.gif" />
scaffold が自動生成するアクションの関係を図にするとこうなります。
scaffold を使わない場合にも、同様のアクション名を付けたほうがわかりやすくて良いと思います。</p>

<h3 id="scaffold-が用意する-template">scaffold が用意する template</h3>
<p><img src="../../images/0005-RubyOnRails/scaffold-2.gif" alt="scaffold-2.gif" /></p>

<p>テンプレートファイルを図に加えてみました。
scaffold はアクションメソッドの定義を自動化するだけでなく、テンプレートも自動的に用意します (scaffold が用いるテンプレートは action_controller/templates/scaffolds/*.rhtml にあります)。
ただし、アクションと同名のテンプレートファイルが存在すればそれを使います (テンプレートファイルは拡張子を .rhtml として app/views/#{controller_name} ディレクトリの中に置きます) 。これにより、scaffold を使うように指定したまま、テンプレートを置き換えていくことができます。
アクションメソッドの定義も同様に、scaffold 指定の後ろで再定義 (上書き) することで、置き換えることができます。</p>

<p>scaffold が生成する update メソッドは次のようになります (実際のものから少々今風に書き換えました :)。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">def update
  @entry = Entry.find(@params["entry"]["id"])
  @entry.attributes = @params["entry"]

  if @entry.save
    flash["notice"] = "Entry was succesfully updated"
    redirect_to :action =&gt; "show", :id =&gt; @entry.id
  else
    render_action :edit
  end
end</code></pre></figure>

<p>update アクションで ActiveRecord オブジェクトの保存 (save) に成功したとき、show アクションへ自動的に移動します。
この移動は HTTP status: “302 Found” によるものです。
これにより、ユーザからの反応なしに (例えば、保存ボタンを押すといった反応なしに) 次のリクエストが行われます。
この機能を redirect といいます。redirect を行うために redirect_to メソッドを使います。</p>

<p>また、update アクションで save に失敗したときには、edit テンプレートを使って再び編集画面を表示します (ついでに指摘しておくと、なぜ save に失敗したのか表示すべきです)。このように、テンプレートを指定するために用いるのが render, render_action といったメソッドです。
なお、save に失敗したときには show アクションへ移動しません。</p>

<h3 id="template-と-action">template と action</h3>
<p><img src="../../images/0005-RubyOnRails/scaffold-3.gif" alt="scaffold-3.gif" /></p>

<p>テンプレートに書かれたアクション指定に従って次に呼び出すアクションが決まるので、テンプレートからアクションに矢印を付けるように変更してみました。こちらのほうが意味は正確になるように思いますが、見た目にわかりにくくなってしまいました。
以降は元に戻しますが、アクションはテンプレートのアクション指定も含めて捉えてください。</p>

<h3 id="new-edit-template-をまとめる">new, edit template をまとめる</h3>
<p><img src="../../images/0005-RubyOnRails/scaffold-4.gif" alt="scaffold-4.gif" /></p>

<p>new と edit は同じ入力フォームを必要とすることが多いようです。
同じフォームをふたつ作るのは無駄なので、new アクションで edit テンプレートを用いるようにしてみましょう。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">def new
  @entry = Entry.new
  @target = "create"
  render_action :edit
end</code></pre></figure>

<p>edit.rhtml に指定するアクション (ターゲットアクション) はそれぞれ create, update となるので、edit.rhtml の中で動的に指定する必要があります。
例えば、new, edit メソッドの中で @target にそれぞれ “create”, “update” と設定すれば、テンプレートで @target をターゲットアクションとして指定できます。</p>

<h3 id="create-update-action-をまとめる">create, update action をまとめる</h3>
<p><img src="../../images/0005-RubyOnRails/scaffold-5.gif" alt="scaffold-5.gif" /></p>

<p>前の例では new と edit でテンプレートは共有するものの、生成・更新メソッド (create, update) はそれぞれ用意していました。
これらのメソッドもまとめることができます (例えば、create を削って update にまとめることができます)。
@entry = Entry.find(@params[“entry”][“id”]) に失敗したとき @entry = Entry.new とすればよいでしょう。</p>

<p>以上のように、scaffold を基本として、柔軟に画面遷移 (アクションの遷移) を設計することができます。
Model が1対1や1対多などの関連を含む場合は、使いやすさを考えて見せ方を工夫する必要が出てきますが、画面遷移の基本的な考え方は同じです。</p>

<h2 id="sql-型と-ruby-クラスとの対応">SQL 型と Ruby クラスとの対応</h2>

<p>SQL 型と Ruby クラスとの対応は次の通りです (MySQL の場合)。</p>

<table>
  <tbody>
    <tr>
      <td>数値型</td>
      <td> </td>
    </tr>
    <tr>
      <td>tinyint, smallint, mediumint, integer, bigint</td>
      <td>Fixnum(*1)</td>
    </tr>
    <tr>
      <td>decimal</td>
      <td>Float</td>
    </tr>
    <tr>
      <td>float, double</td>
      <td>Float</td>
    </tr>
    <tr>
      <td>日付と時刻型</td>
      <td> </td>
    </tr>
    <tr>
      <td>date</td>
      <td>Date</td>
    </tr>
    <tr>
      <td>datetime, time (<em>2), timestamp (</em>2)</td>
      <td>Time</td>
    </tr>
    <tr>
      <td>year (*2)</td>
      <td>Fixnum</td>
    </tr>
    <tr>
      <td>文字列型</td>
      <td> </td>
    </tr>
    <tr>
      <td>char, varchar</td>
      <td>String (*3)</td>
    </tr>
    <tr>
      <td>blob (*2), text</td>
      <td>String (*3)</td>
    </tr>
    <tr>
      <td>enum (*2)</td>
      <td>String</td>
    </tr>
    <tr>
      <td>set  (*2)</td>
      <td>String</td>
    </tr>
  </tbody>
</table>

<ol>
  <li>integer, bigint は Bignum になり得ます。</li>
  <li>scaffold による入力フォームの自動生成には対応していません。</li>
  <li>scaffold では、char, varchar 型は input (type=”text”), text 型は textarea で入力フォームが生成されます。といっても text 型に input タグを使ってもかまいません。</li>
</ol>

<p>また、ActiveRecord は field 名に ? を付けたメソッドで true または false を返すことができます。</p>

<ul>
  <li>数値の場合は 0 で偽, 1 で真</li>
  <li>文字列の場合は ‘0’,’f’ で偽, ‘1’,’t’ (あるいは他の文字列) で真</li>
</ul>

<p>となります。そのほか NULL (nil) は偽です。</p>

<p>真偽値を格納する SQL 型は、MySQL なら実際には tinyint(1) (つまり bool) や char(1) と定義することが多いでしょう。</p>

<p>enum 型と set 型は ActiveRecord (の MySQL adapter) で考慮されているわけではないようですが、使っても問題なさそうです。</p>

<h2 id="テンプレート用-helper-メソッド-リファレンス">テンプレート用 helper メソッド リファレンス</h2>

<p>主に使う (私の主観によります ;) テンプレート用の helper メソッドをまとめてみます。</p>

<p>注意: わかりやすさを優先したため、引数が実装と一致していないことがあります。</p>

<h4 id="url_foroptions---string">url_for(options) -&gt; String</h4>

<p>[action_controller/base.rb: ActionController::Base]</p>

<p>URL を生成します。特に Rails の Rewrite ルールに沿った URL を生成します (Apache 用のルールは public/.htaccess に定義されています)。</p>

<p>url_for を直接用いることはあまりありませんが、以降に挙げる helper メソッドの url_for_options 引数は、このメソッドに渡ります。</p>

<p>options 引数には主に Hash を与え、key として主に :controller, :action, :id を指定します。</p>

<dl>
  <dt>controller =&gt; String</dt>
  <dd>contoller 名です。同じ contoller に移動するときは省略できます。</dd>
  <dt>action =&gt; String</dt>
  <dd>アクション名です。次に呼び出すアクションを指定します。</dd>
  <dt>id =&gt; Fixnum</dt>
  <dd>ID です。次に呼び出すアクションの中で @params[“id”] として参照します。</dd>
</dl>

<h4 id="form_tagurl_for_options-html_options-----string">form_tag(url_for_options, html_options = {}) -&gt; String</h4>

<p>[action_view/helpers/tag_helper.rb: ActionView::Helpers::TagHelper]</p>

<p>form タグを作ります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;%= form_tag :action=&gt;"update" %&gt;
 #=&gt;
 &lt;form action="/debate/update" method="post"&gt;</code></pre></figure>

<p>url_for_options は url_for に渡ります。</p>

<p>html_options は HTML のタグ属性に展開されます。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;%= form_tag {:action=&gt;"update"}, {"name"=&gt;"form1"} %&gt;
 #=&gt;
 &lt;form action="/debate/update" method="post" name="form1"&gt;</code></pre></figure>

<p>注意: html_options を指定するときは url_for_options (Hash) の {} を省略できません。</p>

<h4 id="end_form_tag---string">end_form_tag -&gt; String</h4>

<p>[action_view/helpers/tag_helper.rb: ActionView::Helpers::TagHelper]</p>

<p>&lt;/form&gt; です。たぶん使いません。;)</p>

<h4 id="text_fieldobject-method-html_options-----string">text_field(object, method, html_options = {}) -&gt; String</h4>

<p>[action_view/helpers/form_helper.rb: ActionView::Helpers::FormHelper]</p>

<p>input タグ (type=”text”) を作ります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;%= text_field "topic", "title", "size"=&gt;30 %&gt;
 #=&gt;
 &lt;input id="topic_title" name="topic[title]" size="30" type="text" value="&lt;%=h @topic['title'] %&gt;" /&gt;</code></pre></figure>

<p>object, method は Controller との値のやり取りに使うインスタンス変数名とメソッド名です。
テンプレートが展開されるときには、Controller 上で設定した @object.method の値 (例では @topic.title) が input タグの value 値として設定されます。
そして、(form で submit した結果として) Controller のアクションメソッドを実行するときには、@params[object][method] (例では @params[‘topic’][‘title’]) に value 値が渡ります。</p>

<p>特に Model として ActiveRecord を用いると、この仕様はとても扱いやすく感じられます。
具体的には、Controller 上で @object という名前のインスタンス変数 (例では @topic) に ActiveRecord オブジェクトを設定することで、method に対応する field の値 (例では @topic.title) が input タグの value 値として設定されます。
そして、@params を @topic.attributes = @params[‘topic’] のように ActiveRecord::Base#attributes= に渡すことで field の更新を行えます。</p>

<p>参考: text_field と同じ要領で使えるメソッドとして、hidden_field, password_field, check_box, text_area があります。</p>

<h4 id="selectobject-method-choices-options---html_options-----string">select(object, method, choices, options = {}, html_options = {}) -&gt; String</h4>

<p>[action_view/helpers/form_options_helper.rb: ActionView::Helpers::FormOptionsHelper]</p>

<p>select, option タグを作ります。</p>

<p>object, method は text_field などと同じです。
@object.method の値に一致する選択肢があれば、その選択肢が selected になります。</p>

<p>choices は選択肢のキーと値を指定します。指定方法にいくつかパターンがあります。</p>

<dl>
  <dt>選択肢を option value にする場合</dt>
  <dd>全ての option value を省略できる場合は、単純に値の配列として指定できます。</dd>
</dl>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [ "VISA", "Mastercard" ]</code></pre></figure>

<dl>
  <dt>選択肢と option value を指定する場合</dt>
  <dd>選択肢として表示される値と、@params[object][method] に渡る option value を両方指定する場合は、配列の入れ子かハッシュで指定できます (ただし、ハッシュで指定したときの順序は未定のような気がします)。</dd>
</dl>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [["柔らかい", 1], ["普通", 2], ["硬い", 3]]
 { "柔らかい"=&gt;1 ,  "普通"=&gt;2 ,  "硬い"=&gt;3 }</code></pre></figure>

<p>options は今のところ :include_blank =&gt; true のみ有効です。これを指定すると、先頭に空の選択肢が追加されます。</p>

<p>参考: 親戚筋に collection_select, country_select メソッドがあります。
日本人向けに都道府県の select モジュールがほしいです。</p>

<h4 id="date_selectobject-method-options-----string">date_select(object, method, options = {}) -&gt; String</h4>

<p>[action_view/helpers/date_helper.rb: ActionView::Helpers::DateHelper]</p>

<p>日付用の select タグを作ります。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> &lt;%= date_select "customer", "birth", :use_month_numbers =&gt; true, :start_year =&gt;
 Date.today.year-99, :end_year =&gt; Date.today.year, :include_blank =&gt; true %&gt;</code></pre></figure>

<p>options にはいろいろ指定できます。</p>

<dl>
  <dt>use_month_numbers</dt>
  <dd>月を月名ではなく数字で表します。日本語環境だといつも true にするかも。</dd>
</dl>

<p>start_year</p>

<dl>
  <dt>end_year</dt>
  <dd>選択できる最初の年 (西暦) と最後の年です。省略すると今年を真ん中にして前後 5 年になります。</dd>
  <dt>include_blank</dt>
  <dd>true にすると、(年月日の 3 つとも) 先頭に空の選択肢が追加されます。</dd>
</dl>

<p>あと、年月日 時分秒 用の select タグを個別に作ったり、日を消したり秒を付けたりできますが、詳細はリファレンスやソースをご覧ください。</p>

<h4 id="datetime_selectobject-method-options-----string">datetime_select(object, method, options = {}) -&gt; String</h4>

<p>[action_view/helpers/date_helper.rb: ActionView::Helpers::DateHelper]</p>

<p>日付と時刻用の select タグを作ります。
使い方は date_select と同じです。</p>

<h2 id="rails-日本語-ml-へのお誘い">Rails 日本語 ML へのお誘い</h2>

<p>Rails について日本語で話し合う場として、Rails 日本語 ML &lt;rails@ruby.ml.fdiary.net&gt; が開設されました。お気軽にご参加ください。</p>

<p>参加方法: 下記の要領でメールを出してください。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">To: rails@ruby.ml.fdiary.net
Cc: moriq@moriq.com
Subject: 参加します
本文: 空でなければ何でも可 (自己紹介でもどうぞ)</code></pre></figure>

<h2 id="おわりに">おわりに</h2>

<p>この記事の執筆における最大の成果は MySQL-4.1.9 のバグを見つけたことです。;)</p>

<h2 id="著者について">著者について</h2>

<p>もりきゅうは <a href="http://www.mitta-sys.jp/">ミッタシステム</a> のプログラマです。</p>

<p>著者の連絡先は moriq@moriq.com です。</p>

<h2 id="rubyonrails-を使ってみる-連載一覧">RubyOnRails を使ってみる 連載一覧</h2>

<ul>
  <li>
    <p><a href="../../articles/0019/0019-RubyOnRails.html">RubyOnRails を使ってみる 【第 10 回】 パフォーマンスチューニング</a></p>
  </li>
  <li>
    <p><a href="../../articles/0018/0018-RubyOnRails.html">RubyOnRails を使ってみる 【第 9 回】 Rails で XML-DB にチャレンジ</a></p>
  </li>
  <li>
    <p><a href="../../articles/0015/0015-RubyOnRails.html">RubyOnRails を使ってみる 【第 8 回】 Rails はまり道</a></p>
  </li>
  <li>
    <p><a href="../../articles/0014/0014-RubyOnRails.html">RubyOnRails を使ってみる 【第 7 回】 RJS を使ってみる</a></p>
  </li>
  <li>
    <p><a href="../../articles/0013/0013-RubyOnRails.html">RubyOnRails を使ってみる 【第 6 回】 テストの書き方</a></p>
  </li>
  <li>
    <p><a href="../../articles/0012/0012-RubyOnRails.html">RubyOnRails を使ってみる 【第 5 回】 ActiveHeart</a></p>
  </li>
  <li>
    <p><a href="../../articles/0008/0008-RubyOnRails.html">RubyOnRails を使ってみる 【第 4 回】 ActionPack</a></p>
  </li>
  <li>
    <p><a href="../../articles/0006/0006-RubyOnRails.html">RubyOnRails を使ってみる 【第 3 回】 ActiveRecord</a></p>
  </li>
  <li>
    <p><a href="../../articles/0005/0005-RubyOnRails.html">RubyOnRails を使ってみる 【第 2 回】 (続・RubyOnRails を使ってみる)</a></p>
  </li>
  <li>
    <p><a href="../../articles/0004/0004-RubyOnRails.html">RubyOnRails を使ってみる 【第 1 回】</a></p>
  </li>
</ul>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>character set の設定によってはうまくいかないことがある (例えば enum, set 型の要素として日本語を用いているとき) ので注意が必要です…そんなことしない？;) <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
  </body>
</html>
